<!DOCTYPE html>
<html>
<head>
<title>Back to Skool: Routine at 5D17</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../style.css" />

</head>
<body class="load-Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="Back to Skool" src="../images/logo.png" /></a></td>
<td class="page-header">Load routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-0">Prev: <a href=""></a></span></td>
<td class="up">Up: <a href="load.html#5d17">Map</a></td>
<td class="next"><span class="next-1">Next: <a href="8000.html">8000</a></span></td>
</tr>
</table>
<div class="description">5D17: After the program 'bak2skool' has loaded, this is where it all starts...</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
<table class="">
<tr>
<td class="" colspan="1" rowspan="1"><img alt="loader" src="../images/scr/loader.png" /></td>
<td class="" colspan="1" rowspan="1">This is the initial loader program for Back to Skool (as it appears after doing 'POKE 23762,0' to change the INK for the BASIC listing from white to black). Don't be fooled by the 'RANDOMIZE USR 23794': the floating point number stored underneath is actually 5D17.</td>
</tr>
</table>
</div>
<div class="paragraph">
Entering the code here from BASIC means that <span class="register">C</span>=0x17 (the LSB of 5D17); this value is used later on in the routine at <a href="802F.html">802F</a>.
</div>
</div>
<table class="input-0">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>

</table>
<table class="output-0">
<tr class="asm-output-header">
<th colspan="2">Output</th>
</tr>

</table>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="5d17"></span>5D17</td>
<td class="bytes-0"></td>
<td class="instruction">DI</td>
<td class="comment-11" rowspan="1">Disable interrupts</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="5d18"></span>5D18</td>
<td class="bytes-0"></td>
<td class="instruction">LD B,$31</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="5d1a"></span>5D1A</td>
<td class="bytes-0"></td>
<td class="instruction">LD DE,$FFCF</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="5d1d"></span>5D1D</td>
<td class="bytes-0"></td>
<td class="instruction">CALL $5DEE</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="5dee"></span>
<div class="comments">
<div class="paragraph">
And so begins the misdirection.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="5dee"></span>5DEE</td>
<td class="bytes-0"></td>
<td class="instruction">POP HL</td>
<td class="comment-11" rowspan="1"><span class="register">HL</span>=5D20</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="5def"></span>5DEF</td>
<td class="bytes-0"></td>
<td class="instruction">ADD HL,DE</td>
<td class="comment-11" rowspan="1"><span class="register">HL</span>=5CEF</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="5df0"></span>5DF0</td>
<td class="bytes-0"></td>
<td class="instruction">PUSH HL</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="5df1"></span>5DF1</td>
<td class="bytes-0"></td>
<td class="instruction">LD DE,$0007</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="5df4"></span>5DF4</td>
<td class="bytes-0"></td>
<td class="instruction">ADD HL,DE</td>
<td class="comment-11" rowspan="1"><span class="register">HL</span>=5CF6</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="5df5"></span>5DF5</td>
<td class="bytes-0"></td>
<td class="instruction">RET</td>
<td class="comment-11" rowspan="1">Jump to 5CEF</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="5cef"></span>
<div class="comments">
<div class="paragraph">
Undo some code obfuscation before continuing.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="5cef"></span>5CEF</td>
<td class="bytes-0"></td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="6">Do some XOR-ing on the 49 bytes from 5CF6 to 5D26</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="5cf0"></span>5CF0</td>
<td class="bytes-0"></td>
<td class="instruction">XOR H</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="5cf1"></span>5CF1</td>
<td class="bytes-0"></td>
<td class="instruction">XOR L</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="5cf2"></span>5CF2</td>
<td class="bytes-0"></td>
<td class="instruction">LD (HL),A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="5cf3"></span>5CF3</td>
<td class="bytes-0"></td>
<td class="instruction">INC HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="5cf4"></span>5CF4</td>
<td class="bytes-0"></td>
<td class="instruction">DJNZ $5CEF</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="5cf6"></span>
<div class="comments">
<div class="paragraph">
After the XOR-ing:
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="5cf6"></span>5CF6</td>
<td class="bytes-0"></td>
<td class="instruction">EXX</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="5cf7"></span>5CF7</td>
<td class="bytes-0"></td>
<td class="instruction">EX (SP),HL</td>
<td class="comment-11" rowspan="1"><span class="register">HL'</span>=2D2B</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="5cf8"></span>5CF8</td>
<td class="bytes-0"></td>
<td class="instruction">LD A,H</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=0x2D</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="5cf9"></span>5CF9</td>
<td class="bytes-0"></td>
<td class="instruction">AND L</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=0x29</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="5cfa"></span>5CFA</td>
<td class="bytes-0"></td>
<td class="instruction">ADD A,L</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=0x54</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="5cfb"></span>5CFB</td>
<td class="bytes-0"></td>
<td class="instruction">ADD A,L</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=0x7F</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="5cfc"></span>5CFC</td>
<td class="bytes-0"></td>
<td class="instruction">LD H,A</td>
<td class="comment-11" rowspan="1"><span class="register">H'</span>=0x7F</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="5cfd"></span>5CFD</td>
<td class="bytes-0"></td>
<td class="instruction">ADD A,$4E</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=0xCD</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="5cff"></span>5CFF</td>
<td class="bytes-0"></td>
<td class="instruction">LD L,A</td>
<td class="comment-11" rowspan="1"><span class="register">HL'</span>=7FCD</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="5d00"></span>5D00</td>
<td class="bytes-0"></td>
<td class="instruction">EXX</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="5d01"></span>5D01</td>
<td class="bytes-0"></td>
<td class="instruction">LD HL,$5BFF</td>
<td class="comment-11" rowspan="5">INK 1: PAPER 1</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="5d04"></span>5D04</td>
<td class="bytes-0"></td>
<td class="instruction">LD (HL),$09</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="5d06"></span>5D06</td>
<td class="bytes-0"></td>
<td class="instruction">DEC HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="5d07"></span>5D07</td>
<td class="bytes-0"></td>
<td class="instruction">BIT 3,H</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="5d09"></span>5D09</td>
<td class="bytes-0"></td>
<td class="instruction">JR NZ,$5D04</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="5d0b"></span>5D0B</td>
<td class="bytes-0"></td>
<td class="instruction">LD (HL),$00</td>
<td class="comment-11" rowspan="4">Clear the display file</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="5d0d"></span>5D0D</td>
<td class="bytes-0"></td>
<td class="instruction">DEC HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="5d0e"></span>5D0E</td>
<td class="bytes-0"></td>
<td class="instruction">BIT 6,H</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="5d10"></span>5D10</td>
<td class="bytes-0"></td>
<td class="instruction">JR NZ,$5D0B</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="5d12"></span>5D12</td>
<td class="bytes-0"></td>
<td class="instruction">INC E</td>
<td class="comment-11" rowspan="2"><span class="register">DE</span>=0009</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="5d13"></span>5D13</td>
<td class="bytes-0"></td>
<td class="instruction">INC E</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="5d14"></span>5D14</td>
<td class="bytes-0"></td>
<td class="instruction">CALL $5DEE</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="5dee"></span>
<div class="comments">
<div class="paragraph">
More misdirection.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="5dee"></span>5DEE</td>
<td class="bytes-0"></td>
<td class="instruction">POP HL</td>
<td class="comment-11" rowspan="1"><span class="register">HL</span>=5D17</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="5def"></span>5DEF</td>
<td class="bytes-0"></td>
<td class="instruction">ADD HL,DE</td>
<td class="comment-11" rowspan="1"><span class="register">HL</span>=5D20</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="5df0"></span>5DF0</td>
<td class="bytes-0"></td>
<td class="instruction">PUSH HL</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="5df1"></span>5DF1</td>
<td class="bytes-0"></td>
<td class="instruction">LD DE,$0007</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="5df4"></span>5DF4</td>
<td class="bytes-0"></td>
<td class="instruction">ADD HL,DE</td>
<td class="comment-11" rowspan="1"><span class="register">HL</span>=5D27</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="5df5"></span>5DF5</td>
<td class="bytes-0"></td>
<td class="instruction">RET</td>
<td class="comment-11" rowspan="1">Jump to 5D20</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="5d20"></span>
<div class="comments">
<div class="paragraph">
Undo some more code obfuscation before continuing.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="5d20"></span>5D20</td>
<td class="bytes-0"></td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="6">Do some XOR-ing and RLC-ing on the 217 bytes from 5D27 to 5DFF</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="5d21"></span>5D21</td>
<td class="bytes-0"></td>
<td class="instruction">XOR E</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="5d22"></span>5D22</td>
<td class="bytes-0"></td>
<td class="instruction">RLCA</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="5d23"></span>5D23</td>
<td class="bytes-0"></td>
<td class="instruction">LD (HL),A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="5d24"></span>5D24</td>
<td class="bytes-0"></td>
<td class="instruction">INC L</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="5d25"></span>5D25</td>
<td class="bytes-0"></td>
<td class="instruction">JR NZ,$5D20</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="5d27"></span>
<div class="comments">
<div class="paragraph">
After the XOR-ing and RLC-ing:
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="5d27"></span>5D27</td>
<td class="bytes-0"></td>
<td class="instruction">PUSH HL</td>
<td class="comment-11" rowspan="1"><span class="register">HL</span>=5D00</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="5d28"></span>5D28</td>
<td class="bytes-0"></td>
<td class="instruction">EXX</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="5d29"></span>5D29</td>
<td class="bytes-0"></td>
<td class="instruction">POP DE</td>
<td class="comment-11" rowspan="1"><span class="register">DE'</span>=5D00</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="5d2a"></span>5D2A</td>
<td class="bytes-0"></td>
<td class="instruction">EX DE,HL</td>
<td class="comment-11" rowspan="1"><span class="register">DE'</span>=7FCD</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="5d2b"></span>5D2B</td>
<td class="bytes-0"></td>
<td class="instruction">LD BC,$00FF</td>
<td class="comment-11" rowspan="2">Copy 255 bytes from 5D00-5DFE to 7FCD-80CB</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="5d2e"></span>5D2E</td>
<td class="bytes-0"></td>
<td class="instruction">LDIR</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="5d30"></span>5D30</td>
<td class="bytes-0"></td>
<td class="instruction">LD E,A</td>
<td class="comment-11" rowspan="1"><span class="register">E'</span>=0x2F</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="5d31"></span>5D31</td>
<td class="bytes-0"></td>
<td class="instruction">EX DE,HL</td>
<td class="comment-11" rowspan="1"><span class="register">HL'</span>=802F</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="5d32"></span>5D32</td>
<td class="bytes-0"></td>
<td class="instruction">JP (HL)</td>
<td class="comment-11" rowspan="1">Jump to <a href="802F.html">802F</a></td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-0">Prev: <a href=""></a></span></td>
<td class="up">Up: <a href="load.html#5d17">Map</a></td>
<td class="next"><span class="next-1">Next: <a href="8000.html">8000</a></span></td>
</tr>
</table>
<footer>
<div class="release">The complete Back to Skool RAM disassembly 20190617</div>
<div class="copyright">&#169; 1985 Microsphere Computer Services Ltd. &#169; 2019 Richard Dymond.</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 7.2.</div>
<div><a href="../dec/load/23831.html">Switch to decimal</a>.</div>
</footer>
</body>
</html>