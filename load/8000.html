<!DOCTYPE html>
<html>
<head>
<title>Back to Skool: Routine at 8000</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body class="load-Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="Back to Skool" src="../images/logo.png" /></a></td>
<td class="page-header">Load routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="5D17.html">5D17</a>
</td>
<td class="up">Up: <a href="load.html#8000">Map</a></td>
<td class="next">
Next: <a href="802F.html">802F</a>
</td>
</tr>
</table>
<div class="description">8000: Collect one bit from tape</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
Used by the routine at <a href="802F.html">802F</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="8000"></span>8000</td>
<td class="instruction">INC SP</td>
<td class="comment-1" rowspan="8">Place the address 0000 on the stack above the current return address, so the Spectrum will reset if there's a loading error</td>
</tr>
<tr>
<td class="address-1"><span id="8001"></span>8001</td>
<td class="instruction">INC SP</td>
</tr>
<tr>
<td class="address-1"><span id="8002"></span>8002</td>
<td class="instruction">EX (SP),HL</td>
</tr>
<tr>
<td class="address-1"><span id="8003"></span>8003</td>
<td class="instruction">LD H,$00</td>
</tr>
<tr>
<td class="address-1"><span id="8005"></span>8005</td>
<td class="instruction">LD L,H</td>
</tr>
<tr>
<td class="address-1"><span id="8006"></span>8006</td>
<td class="instruction">EX (SP),HL</td>
</tr>
<tr>
<td class="address-1"><span id="8007"></span>8007</td>
<td class="instruction">DEC SP</td>
</tr>
<tr>
<td class="address-1"><span id="8008"></span>8008</td>
<td class="instruction">DEC SP</td>
</tr>
<tr>
<td class="address-1"><span id="8009"></span>8009</td>
<td class="instruction">LD A,$06</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-1"><span id="800b"></span>800B</td>
<td class="instruction">CALL $8011</td>
<td class="comment-1" rowspan="1">Listen for one edge</td>
</tr>
<tr>
<td class="address-1"><span id="800e"></span>800E</td>
<td class="instruction">RET NC</td>
<td class="comment-1" rowspan="1">Return if no edge was found within the time limit</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="800f"></span>
<div class="comments">
<div class="paragraph">
This entry point is also used by the routine at <a href="802F.html">802F</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="800f"></span>800F</td>
<td class="instruction">LD A,$0B</td>
<td class="comment-1" rowspan="3">Wait a bit</td>
</tr>
<tr>
<td class="address-2"><span id="8011"></span>8011</td>
<td class="instruction">DEC A</td>
</tr>
<tr>
<td class="address-1"><span id="8012"></span>8012</td>
<td class="instruction">JR NZ,$8011</td>
</tr>
<tr>
<td class="address-1"><span id="8014"></span>8014</td>
<td class="instruction">AND A</td>
<td class="comment-1" rowspan="1">Reset the carry flag</td>
</tr>
<tr>
<td class="address-2"><span id="8015"></span>8015</td>
<td class="instruction">INC B</td>
<td class="comment-1" rowspan="1">Have we run out of time to find an edge?</td>
</tr>
<tr>
<td class="address-1"><span id="8016"></span>8016</td>
<td class="instruction">RET Z</td>
<td class="comment-1" rowspan="1">Return with the carry flag reset if so</td>
</tr>
<tr>
<td class="address-1"><span id="8017"></span>8017</td>
<td class="instruction">LD A,$7F</td>
<td class="comment-1" rowspan="2">Collect an EAR port reading in bit 6 of <span class="register">A</span></td>
</tr>
<tr>
<td class="address-1"><span id="8019"></span>8019</td>
<td class="instruction">IN A,($FE)</td>
</tr>
<tr>
<td class="address-1"><span id="801b"></span>801B</td>
<td class="instruction">RRA</td>
<td class="comment-1" rowspan="1">Move it to bit 5 of <span class="register">A</span></td>
</tr>
<tr>
<td class="address-1"><span id="801c"></span>801C</td>
<td class="instruction">AND A</td>
<td class="comment-1" rowspan="1">In the analogous ROM routine, the instruction here is 'RET NC', causing a return if BREAK was pressed; in this routine, that behaviour is disabled (pressing BREAK does nothing)</td>
</tr>
<tr>
<td class="address-1"><span id="801d"></span>801D</td>
<td class="instruction">XOR C</td>
<td class="comment-1" rowspan="2">Compare this EAR port reading with the previous one</td>
</tr>
<tr>
<td class="address-1"><span id="801e"></span>801E</td>
<td class="instruction">AND $20</td>
</tr>
<tr>
<td class="address-1"><span id="8020"></span>8020</td>
<td class="instruction">JR Z,$8015</td>
<td class="comment-1" rowspan="1">Jump back if they are the same (i.e. no edge was found)</td>
</tr>
<tr>
<td class="address-1"><span id="8022"></span>8022</td>
<td class="instruction">LD A,C</td>
<td class="comment-1" rowspan="6">Alternate the border colour</td>
</tr>
<tr>
<td class="address-1"><span id="8023"></span>8023</td>
<td class="instruction">CPL</td>
</tr>
<tr>
<td class="address-1"><span id="8024"></span>8024</td>
<td class="instruction">LD C,A</td>
</tr>
<tr>
<td class="address-1"><span id="8025"></span>8025</td>
<td class="instruction">AND $07</td>
</tr>
<tr>
<td class="address-1"><span id="8027"></span>8027</td>
<td class="instruction">OR $08</td>
</tr>
<tr>
<td class="address-1"><span id="8029"></span>8029</td>
<td class="instruction">OUT ($FE),A</td>
</tr>
<tr>
<td class="address-1"><span id="802b"></span>802B</td>
<td class="instruction">SCF</td>
<td class="comment-1" rowspan="1">Signal: an edge was found within the time limit</td>
</tr>
<tr>
<td class="address-1"><span id="802c"></span>802C</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1">Return with <span class="register">B</span> indicating the time taken to find the edge</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="5D17.html">5D17</a>
</td>
<td class="up">Up: <a href="load.html#8000">Map</a></td>
<td class="next">
Next: <a href="802F.html">802F</a>
</td>
</tr>
</table>
<footer>
<div class="release">The complete Back to Skool RAM disassembly 20191115</div>
<div class="copyright">&#169; 1985 Microsphere Computer Services Ltd. &#169; 2019 Richard Dymond.</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 8.0.</div>
<div><a href="../dec/load/32768.html">Switch to decimal</a>.</div>
</footer>
</body>
</html>