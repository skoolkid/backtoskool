<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html
    PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Back to Skool: Routine at 32768</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../microsphere.css" />
<link rel="stylesheet" type="text/css" href="../skool.css" />
<link rel="stylesheet" type="text/css" href="../bts.css" />

</head>
<body class="load-Asm-c">
<table class="header">
<tr>
<td class="logo"><a class="link" href="../index.html"><img alt="logo" src="../images/logo.png" /></a></td>
<td class="page-header">Load routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a class="link" href="23831.html">23831</a></span></td>
<td class="up">Up: <a class="link" href="load.html#32768">Map</a></td>
<td class="next"><span class="next-1">Next: <a class="link" href="32815.html">32815</a></span></td>
</tr>
</table>
<div class="description">32768: Collect one bit from tape</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="4">
<div class="details">
<div class="paragraph">
Used by the routine at <a class="link" href="32815.html">32815</a>.
</div>
</div>
<table class="input-0">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>

</table>
<table class="output-0">
<tr class="asm-output-header">
<th colspan="2">Output</th>
</tr>

</table>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="32768"></a>32768</td>
<td class="instruction">INC SP</td>
<td class="comment-11" rowspan="8">Place the address 0 on the stack above the current return address, so the Spectrum will reset if there's a loading error</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="32769"></a>32769</td>
<td class="instruction">INC SP</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="32770"></a>32770</td>
<td class="instruction">EX (SP),HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="32771"></a>32771</td>
<td class="instruction">LD H,0</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="32773"></a>32773</td>
<td class="instruction">LD L,H</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="32774"></a>32774</td>
<td class="instruction">EX (SP),HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="32775"></a>32775</td>
<td class="instruction">DEC SP</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="32776"></a>32776</td>
<td class="instruction">DEC SP</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="32777"></a>32777</td>
<td class="instruction">LD A,6</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="32779"></a>32779</td>
<td class="instruction">CALL 32785</td>
<td class="comment-11" rowspan="1">Listen for one edge</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="32782"></a>32782</td>
<td class="instruction">RET NC</td>
<td class="comment-11" rowspan="1">Return if no edge was found within the time limit</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="32783"></a>
<div class="comments">
<div class="paragraph">
This entry point is also used by the routine at <a class="link" href="32815.html">32815</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="32783"></a>32783</td>
<td class="instruction">LD A,11</td>
<td class="comment-11" rowspan="3">Wait a bit</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="32785"></a>32785</td>
<td class="instruction">DEC A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="32786"></a>32786</td>
<td class="instruction">JR NZ,32785</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="32788"></a>32788</td>
<td class="instruction">AND A</td>
<td class="comment-11" rowspan="1">Reset the carry flag</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="32789"></a>32789</td>
<td class="instruction">INC B</td>
<td class="comment-11" rowspan="1">Have we run out of time to find an edge?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="32790"></a>32790</td>
<td class="instruction">RET Z</td>
<td class="comment-11" rowspan="1">Return with the carry flag reset if so</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="32791"></a>32791</td>
<td class="instruction">LD A,127</td>
<td class="comment-11" rowspan="2">Collect an EAR port reading in bit 6 of <span class="register">A</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="32793"></a>32793</td>
<td class="instruction">IN A,(254)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="32795"></a>32795</td>
<td class="instruction">RRA</td>
<td class="comment-11" rowspan="1">Move it to bit 5 of <span class="register">A</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="32796"></a>32796</td>
<td class="instruction">AND A</td>
<td class="comment-11" rowspan="1">In the analogous ROM routine, the instruction here is 'RET NC', causing a return if BREAK was pressed; in this routine, that behaviour is disabled (pressing BREAK does nothing)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="32797"></a>32797</td>
<td class="instruction">XOR C</td>
<td class="comment-11" rowspan="2">Compare this EAR port reading with the previous one</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="32798"></a>32798</td>
<td class="instruction">AND 32</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="32800"></a>32800</td>
<td class="instruction">JR Z,32789</td>
<td class="comment-11" rowspan="1">Jump back if they are the same (i.e. no edge was found)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="32802"></a>32802</td>
<td class="instruction">LD A,C</td>
<td class="comment-11" rowspan="6">Alternate the border colour</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="32803"></a>32803</td>
<td class="instruction">CPL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="32804"></a>32804</td>
<td class="instruction">LD C,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="32805"></a>32805</td>
<td class="instruction">AND 7</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="32807"></a>32807</td>
<td class="instruction">OR 8</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="32809"></a>32809</td>
<td class="instruction">OUT (254),A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="32811"></a>32811</td>
<td class="instruction">SCF</td>
<td class="comment-11" rowspan="1">Signal: an edge was found within the time limit</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="32812"></a>32812</td>
<td class="instruction">RET</td>
<td class="comment-11" rowspan="1">Return with <span class="register">B</span> indicating the time taken to find the edge</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a class="link" href="23831.html">23831</a></span></td>
<td class="up">Up: <a class="link" href="load.html#32768">Map</a></td>
<td class="next"><span class="next-1">Next: <a class="link" href="32815.html">32815</a></span></td>
</tr>
</table>
<div class="footer">
<div class="release">The complete Back to Skool RAM disassembly 20140614</div>
<div class="copyright">&#169; 1985 Microsphere Computer Services Ltd (Back to Skool). &#169; 2014 Richard Dymond (this disassembly).</div>
<div class="created">Created using <a class="link" href="http://pyskool.ca/?page_id=177">SkoolKit</a> 4.0.</div>
</div>
</body>
</html>