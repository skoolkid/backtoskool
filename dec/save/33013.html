<!DOCTYPE html>
<html>
<head>
<title>Back to Skool: Routine at 33013</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../style.css" />

</head>
<body class="save-Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="Back to Skool" src="../../images/logo.png" /></a></td>
<td class="page-header">Save routine</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-0">Prev: <a href=""></a></span></td>
<td class="up">Up: <a href="save.html#33013">Map</a></td>
<td class="next"><span class="next-0">Next: <a href=""></a></span></td>
</tr>
</table>
<div class="description">33013: Save Back to Skool to tape</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
<table class="">
<tr>
<td class="" colspan="1" rowspan="1"><img alt="saver" src="../../images/scr/saver.png" /></td>
<td class="" colspan="1" rowspan="1">This is the program used to save the fast code block for Back to Skool. See '<a href="../reference/facts.html#saverPokes">BASIC saver POKEs</a>' for a discussion of the two POKEs that appear in line 33 of the program.</td>
</tr>
</table>
</div>
<div class="paragraph">
The fast code block consists of two sections of data. The first section contains the 16573 bytes of data for addresses 16384-32956. The second section contains 65535 bytes of data starting at address 32971, moving forward in steps of 23 bytes, and ending at 32925.
</div>
<div class="paragraph">
Note that the last three bytes in the first section (addresses 32954-32956) are actually loaded into addresses 32902, 32925 and 32948 by the <a href="../load/32815.html">load routine</a>. Note also that the last byte in the second section, for address 32925, is not loaded by the <a href="../load/32815.html">load routine</a>.
</div>
</div>
<table class="input-0">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>

</table>
<table class="output-0">
<tr class="asm-output-header">
<th colspan="2">Output</th>
</tr>

</table>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="33013"></span>33013</td>
<td class="bytes-0"></td>
<td class="instruction">LD HL,33204</td>
<td class="comment-11" rowspan="1"><a href="../start/33204.html">33204</a> is where the game starts after loading</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="33016"></span>33016</td>
<td class="bytes-0"></td>
<td class="instruction">LD (23833),HL</td>
<td class="comment-11" rowspan="1">Store this address where it will be popped off the stack by the <a href="../load/32815.html">load routine</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="33019"></span>33019</td>
<td class="bytes-0"></td>
<td class="instruction">EXX</td>
<td class="comment-11" rowspan="3">Prepare <span class="register">BC'</span> for saving the second section of data</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="33020"></span>33020</td>
<td class="bytes-0"></td>
<td class="instruction">LD BC,23</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="33023"></span>33023</td>
<td class="bytes-0"></td>
<td class="instruction">EXX</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="33024"></span>33024</td>
<td class="bytes-0"></td>
<td class="instruction">LD IX,16384</td>
<td class="comment-11" rowspan="2">16384 to 32956 will be saved first</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="33028"></span>33028</td>
<td class="bytes-0"></td>
<td class="instruction">LD DE,16572</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="33031"></span>33031</td>
<td class="bytes-0"></td>
<td class="instruction">LD A,255</td>
<td class="comment-11" rowspan="1">A flag byte of 255 (the first byte saved) indicates a data block</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="33033"></span>33033</td>
<td class="bytes-0"></td>
<td class="instruction">LD HL,3224</td>
<td class="comment-11" rowspan="1">This constant will give a leader tone of about 2 seconds</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="33036"></span>33036</td>
<td class="bytes-0"></td>
<td class="instruction">EX AF,AF'</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="33037"></span>33037</td>
<td class="bytes-0"></td>
<td class="instruction">INC DE</td>
<td class="comment-11" rowspan="2">Adjust the length and start address to allow for the flag byte</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="33038"></span>33038</td>
<td class="bytes-0"></td>
<td class="instruction">DEC IX</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="33040"></span>33040</td>
<td class="bytes-0"></td>
<td class="instruction">DI</td>
<td class="comment-11" rowspan="1">Disable interrupts</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="33041"></span>33041</td>
<td class="bytes-0"></td>
<td class="instruction">LD A,2</td>
<td class="comment-11" rowspan="1">MIC on, border red</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="33043"></span>33043</td>
<td class="bytes-0"></td>
<td class="instruction">LD B,A</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="33044"></span>
<div class="comments">
<div class="paragraph">
First create the 2-second leader tone.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="33044"></span>33044</td>
<td class="bytes-0"></td>
<td class="instruction">DJNZ 33044</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="33046"></span>33046</td>
<td class="bytes-0"></td>
<td class="instruction">OUT (254),A</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="33048"></span>33048</td>
<td class="bytes-0"></td>
<td class="instruction">XOR 15</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="33050"></span>33050</td>
<td class="bytes-0"></td>
<td class="instruction">LD B,164</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="33052"></span>33052</td>
<td class="bytes-0"></td>
<td class="instruction">DEC L</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="33053"></span>33053</td>
<td class="bytes-0"></td>
<td class="instruction">JR NZ,33044</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="33055"></span>33055</td>
<td class="bytes-0"></td>
<td class="instruction">DEC B</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="33056"></span>33056</td>
<td class="bytes-0"></td>
<td class="instruction">DEC H</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="33057"></span>33057</td>
<td class="bytes-0"></td>
<td class="instruction">JP P,33044</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="33060"></span>
<div class="comments">
<div class="paragraph">
Then create the sync pulse.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="33060"></span>33060</td>
<td class="bytes-0"></td>
<td class="instruction">LD B,47</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="33062"></span>33062</td>
<td class="bytes-0"></td>
<td class="instruction">DJNZ 33062</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="33064"></span>33064</td>
<td class="bytes-0"></td>
<td class="instruction">OUT (254),A</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="33066"></span>33066</td>
<td class="bytes-0"></td>
<td class="instruction">LD A,13</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="33068"></span>33068</td>
<td class="bytes-0"></td>
<td class="instruction">LD B,55</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="33070"></span>33070</td>
<td class="bytes-0"></td>
<td class="instruction">DJNZ 33070</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="33072"></span>33072</td>
<td class="bytes-0"></td>
<td class="instruction">OUT (254),A</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="33074"></span>
<div class="comments">
<div class="paragraph">
It's time to save the first byte, which will be the flag byte (255).
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="33074"></span>33074</td>
<td class="bytes-0"></td>
<td class="instruction">LD BC,6670</td>
<td class="comment-11" rowspan="1"><span class="register">B</span>=26 (timing constant), <span class="register">C</span>=14 (MIC off, border yellow)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="33077"></span>33077</td>
<td class="bytes-0"></td>
<td class="instruction">EX AF,AF'</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=255</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="33078"></span>33078</td>
<td class="bytes-0"></td>
<td class="instruction">LD L,A</td>
<td class="comment-11" rowspan="1"><span class="register">L</span>=255</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="33079"></span>33079</td>
<td class="bytes-0"></td>
<td class="instruction">JP 33091</td>
<td class="comment-11" rowspan="1">Jump forward to save the flag byte</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="33082"></span>
<div class="comments">
<div class="paragraph">
This is the main byte-saving loop.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="33082"></span>33082</td>
<td class="bytes-0"></td>
<td class="instruction">LD A,D</td>
<td class="comment-11" rowspan="2">In the analagous ROM routine, the second instruction here is 'OR E', to check whether it's time to save the last byte (the parity byte)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="33083"></span>33083</td>
<td class="bytes-0"></td>
<td class="instruction">LD A,D</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="33084"></span>33084</td>
<td class="bytes-0"></td>
<td class="instruction">JR Z,33098</td>
<td class="comment-11" rowspan="1">This jump (to save the parity byte) is never made</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="33086"></span>33086</td>
<td class="bytes-0"></td>
<td class="instruction">LD L,(IX+0)</td>
<td class="comment-11" rowspan="1">Fetch the next byte to be saved</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="33089"></span>33089</td>
<td class="bytes-0"></td>
<td class="instruction">LD A,H</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=current parity byte</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="33090"></span>33090</td>
<td class="bytes-0"></td>
<td class="instruction">XOR L</td>
<td class="comment-11" rowspan="1">Update this for the next byte to be saved</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="33091"></span>33091</td>
<td class="bytes-0"></td>
<td class="instruction">LD H,A</td>
<td class="comment-11" rowspan="1"><span class="register">H</span>=new parity byte</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="33092"></span>33092</td>
<td class="bytes-0"></td>
<td class="instruction">LD A,1</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=1 (MIC on, border blue)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="33094"></span>33094</td>
<td class="bytes-0"></td>
<td class="instruction">SCF</td>
<td class="comment-11" rowspan="1">Set the carry flag (which will act as the marker bit)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="33095"></span>33095</td>
<td class="bytes-0"></td>
<td class="instruction">JP 33121</td>
<td class="comment-11" rowspan="1">Jump forward to save the byte</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="33098"></span>
<div class="comments">
<div class="paragraph">
This section of code, if it were used, would save the parity byte.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="33098"></span>33098</td>
<td class="bytes-0"></td>
<td class="instruction">LD L,H</td>
<td class="comment-11" rowspan="1">Pick up the parity byte in <span class="register">L</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="33099"></span>33099</td>
<td class="bytes-0"></td>
<td class="instruction">JR 33089</td>
<td class="comment-11" rowspan="1">Save it</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="33101"></span>
<div class="comments">
<div class="paragraph">
This is the bit-saving loop for the first section of data (16384-32956).
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="33101"></span>33101</td>
<td class="bytes-0"></td>
<td class="instruction">LD A,C</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=14 (MIC off, border yellow) for the second pass</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="33102"></span>33102</td>
<td class="bytes-0"></td>
<td class="instruction">BIT 7,B</td>
<td class="comment-11" rowspan="1">Set the zero flag to indicate that this is the second pass through the loop</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="33104"></span>33104</td>
<td class="bytes-0"></td>
<td class="instruction">DJNZ 33104</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="33106"></span>33106</td>
<td class="bytes-0"></td>
<td class="instruction">JR NC,33112</td>
<td class="comment-11" rowspan="1">Jump if we are saving a '0'</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="33108"></span>33108</td>
<td class="bytes-0"></td>
<td class="instruction">LD B,32</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="33110"></span>33110</td>
<td class="bytes-0"></td>
<td class="instruction">DJNZ 33110</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="33112"></span>33112</td>
<td class="bytes-0"></td>
<td class="instruction">OUT (254),A</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="33114"></span>33114</td>
<td class="bytes-0"></td>
<td class="instruction">LD B,29</td>
<td class="comment-11" rowspan="1">Set the timing constant for the second pass</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="33116"></span>33116</td>
<td class="bytes-0"></td>
<td class="instruction">JR NZ,33101</td>
<td class="comment-11" rowspan="1">Jump back for the second pass if we've just done the first</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="33118"></span>33118</td>
<td class="bytes-0"></td>
<td class="instruction">DEC B</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="33119"></span>33119</td>
<td class="bytes-0"></td>
<td class="instruction">XOR A</td>
<td class="comment-11" rowspan="1">Clear the carry flag</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="33120"></span>33120</td>
<td class="bytes-0"></td>
<td class="instruction">INC A</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=1 (MIC on, border blue)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="33121"></span>33121</td>
<td class="bytes-0"></td>
<td class="instruction">RL L</td>
<td class="comment-11" rowspan="1">Move the bit to be saved into the carry flag, and the marker bit leftwards</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="33123"></span>33123</td>
<td class="bytes-0"></td>
<td class="instruction">JP NZ,33104</td>
<td class="comment-11" rowspan="1">Jump unless we've saved all 8 bits of the byte</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="33126"></span>
<div class="comments">
<div class="paragraph">
A byte from the first section (16384-32956) has just been saved. Are there any more left?
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="33126"></span>33126</td>
<td class="bytes-0"></td>
<td class="instruction">DEC DE</td>
<td class="comment-11" rowspan="1">Decrease the length counter</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="33127"></span>33127</td>
<td class="bytes-0"></td>
<td class="instruction">INC IX</td>
<td class="comment-11" rowspan="1">Move to the next byte to be saved</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="33129"></span>33129</td>
<td class="bytes-0"></td>
<td class="instruction">LD B,16</td>
<td class="comment-11" rowspan="1">Set the timing constant for the first bit of the next byte</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="33131"></span>33131</td>
<td class="bytes-0"></td>
<td class="instruction">LD A,127</td>
<td class="comment-11" rowspan="4">Return if the BREAK key is being pressed</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="33133"></span>33133</td>
<td class="bytes-0"></td>
<td class="instruction">IN A,(254)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="33135"></span>33135</td>
<td class="bytes-0"></td>
<td class="instruction">RRA</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="33136"></span>33136</td>
<td class="bytes-0"></td>
<td class="instruction">RET NC</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="33137"></span>33137</td>
<td class="bytes-0"></td>
<td class="instruction">LD A,D</td>
<td class="comment-11" rowspan="2">Have we saved 16384 to 32956 yet?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="33138"></span>33138</td>
<td class="bytes-0"></td>
<td class="instruction">INC A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="33139"></span>33139</td>
<td class="bytes-0"></td>
<td class="instruction">JP NZ,33082</td>
<td class="comment-11" rowspan="1">Jump back if not</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="33142"></span>
<div class="comments">
<div class="paragraph">
Now a further 65535 bytes are saved: starting at 32971, moving forward in steps of 23 bytes, and ending at 32925.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="33142"></span>33142</td>
<td class="bytes-0"></td>
<td class="instruction">LD A,D</td>
<td class="comment-11" rowspan="2"><span class="register">IX</span>=32957 and <span class="register">DE</span>=65535 the first time we get here</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="33143"></span>33143</td>
<td class="bytes-0"></td>
<td class="instruction">OR E</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="33144"></span>33144</td>
<td class="bytes-0"></td>
<td class="instruction">JR Z,33158</td>
<td class="comment-11" rowspan="1">Jump if we have now saved 32971 onwards</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="33146"></span>33146</td>
<td class="bytes-0"></td>
<td class="instruction">LD L,(IX+14)</td>
<td class="comment-11" rowspan="1"><span class="register">IX</span>+14=32971 the first time we get here</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="33149"></span>33149</td>
<td class="bytes-0"></td>
<td class="instruction">LD A,H</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=current parity byte</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="33150"></span>33150</td>
<td class="bytes-0"></td>
<td class="instruction">XOR L</td>
<td class="comment-11" rowspan="1">Update this for the next byte to be saved</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="33151"></span>33151</td>
<td class="bytes-0"></td>
<td class="instruction">LD H,A</td>
<td class="comment-11" rowspan="1"><span class="register">H</span>=new parity byte</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="33152"></span>33152</td>
<td class="bytes-0"></td>
<td class="instruction">LD A,1</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=1 (MIC on, border blue)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="33154"></span>33154</td>
<td class="bytes-0"></td>
<td class="instruction">SCF</td>
<td class="comment-11" rowspan="1">Set the carry flag (which will act as the marker bit)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="33155"></span>33155</td>
<td class="bytes-0"></td>
<td class="instruction">JP 33181</td>
<td class="comment-11" rowspan="1">Jump forward to save the byte</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="33158"></span>
<div class="comments">
<div class="paragraph">
This is where we come when all 82108 bytes have been saved.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="33158"></span>33158</td>
<td class="bytes-0"></td>
<td class="instruction">LD L,0</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="33160"></span>33160</td>
<td class="bytes-0"></td>
<td class="instruction">RET</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="33161"></span>
<div class="comments">
<div class="paragraph">
This is the bit-saving loop for the second section of data.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="33161"></span>33161</td>
<td class="bytes-0"></td>
<td class="instruction">LD A,C</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=14 (MIC off, border yellow) for the second pass</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="33162"></span>33162</td>
<td class="bytes-0"></td>
<td class="instruction">BIT 7,B</td>
<td class="comment-11" rowspan="1">Set the zero flag to indicate that this is the second pass through the loop</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="33164"></span>33164</td>
<td class="bytes-0"></td>
<td class="instruction">DJNZ 33164</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="33166"></span>33166</td>
<td class="bytes-0"></td>
<td class="instruction">JR NC,33172</td>
<td class="comment-11" rowspan="1">Jump if we are saving a '0'</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="33168"></span>33168</td>
<td class="bytes-0"></td>
<td class="instruction">LD B,32</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="33170"></span>33170</td>
<td class="bytes-0"></td>
<td class="instruction">DJNZ 33170</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="33172"></span>33172</td>
<td class="bytes-0"></td>
<td class="instruction">OUT (254),A</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="33174"></span>33174</td>
<td class="bytes-0"></td>
<td class="instruction">LD B,29</td>
<td class="comment-11" rowspan="1">Set the timing constant for the second pass</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="33176"></span>33176</td>
<td class="bytes-0"></td>
<td class="instruction">JR NZ,33161</td>
<td class="comment-11" rowspan="1">Jump back for the second pass if we've just done the first</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="33178"></span>33178</td>
<td class="bytes-0"></td>
<td class="instruction">DEC B</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="33179"></span>33179</td>
<td class="bytes-0"></td>
<td class="instruction">XOR A</td>
<td class="comment-11" rowspan="1">Clear the carry flag</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="33180"></span>33180</td>
<td class="bytes-0"></td>
<td class="instruction">INC A</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=1 (MIC on, border blue)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="33181"></span>33181</td>
<td class="bytes-0"></td>
<td class="instruction">RL L</td>
<td class="comment-11" rowspan="1">Move the bit to be saved into the carry flag, and the marker bit leftwards</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="33183"></span>33183</td>
<td class="bytes-0"></td>
<td class="instruction">JP NZ,33164</td>
<td class="comment-11" rowspan="1">Jump unless we've saved all 8 bits of the byte</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="33186"></span>
<div class="comments">
<div class="paragraph">
A byte from the second section has just been saved. Are there any more left?
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="33186"></span>33186</td>
<td class="bytes-0"></td>
<td class="instruction">DEC DE</td>
<td class="comment-11" rowspan="1">Decrease the length counter</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="33187"></span>33187</td>
<td class="bytes-0"></td>
<td class="instruction">EXX</td>
<td class="comment-11" rowspan="3">Move forward 23 bytes to the next byte to be saved</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="33188"></span>33188</td>
<td class="bytes-0"></td>
<td class="instruction">ADD IX,BC</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="33190"></span>33190</td>
<td class="bytes-0"></td>
<td class="instruction">EXX</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="33191"></span>33191</td>
<td class="bytes-0"></td>
<td class="instruction">LD B,16</td>
<td class="comment-11" rowspan="1">Set the timing constant for the first bit of the next byte</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="33193"></span>33193</td>
<td class="bytes-0"></td>
<td class="instruction">LD A,127</td>
<td class="comment-11" rowspan="3">These instructions check the BREAK key but do not act on the result</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="33195"></span>33195</td>
<td class="bytes-0"></td>
<td class="instruction">IN A,(254)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="33197"></span>33197</td>
<td class="bytes-0"></td>
<td class="instruction">RRA</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="33198"></span>33198</td>
<td class="bytes-0"></td>
<td class="instruction">JP 33142</td>
<td class="comment-11" rowspan="1">Save the next byte</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="32952"></span>
<div class="comments">
<div class="paragraph">
The last 5 bytes of the first section saved make important changes to the <a href="../load/32815.html">load routine</a> when the game is being loaded:
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="32952"></span>32952</td>
<td class="bytes-0"></td>
<td class="instruction">JR NZ,32893</td>
<td class="comment-11" rowspan="1">This will replace the 'JR NZ,32907' at 32952, and kick off the loading of 65537 bytes from 32902 onwards (in steps of 23, all the way round to 32902 again)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="32954"></span>32954</td>
<td class="bytes-0"></td>
<td class="instruction">DEFB 32</td>
<td class="comment-11" rowspan="1">This byte will replace the 49 at 32902, changing the instruction there from 'LD SP,23833' to 'JR NZ,32929'</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="32955"></span>32955</td>
<td class="bytes-0"></td>
<td class="instruction">DEFB 221</td>
<td class="comment-11" rowspan="1">This byte will be loaded into 32925 (which already contains 221)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="32956"></span>32956</td>
<td class="bytes-0"></td>
<td class="instruction">DEFB 173</td>
<td class="comment-11" rowspan="1">This byte will be loaded into 32948 (which already contains 173)</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-0">Prev: <a href=""></a></span></td>
<td class="up">Up: <a href="save.html#33013">Map</a></td>
<td class="next"><span class="next-0">Next: <a href=""></a></span></td>
</tr>
</table>
<footer>
<div class="release">The complete Back to Skool RAM disassembly 20190617</div>
<div class="copyright">&#169; 1985 Microsphere Computer Services Ltd. &#169; 2019 Richard Dymond.</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 7.2.</div>
<div><a href="../../save/80F5.html">Switch to hexadecimal</a>.</div>
</footer>
</body>
</html>