<!DOCTYPE html>
<html>
<head>
<title>Back to Skool: Routine at 24477</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="Back to Skool" src="../../images/logo-dec.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="24476.html">24476</a>
</td>
<td class="up">Up: <a href="../maps/all.html#24477">Map</a></td>
<td class="next">
Next: <a href="24560.html">24560</a>
</td>
</tr>
</table>
<div class="description">24477: Play a tune</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
Used by the routine at <a href="62910.html">62910</a>. The main entry point is used to play the theme tune.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="24477"></span>24477</td>
<td class="instruction">LD HL,23611</td>
<td class="comment-1" rowspan="2">Reset bit 5 at 23611, clearing the record of any keypresses before the tune starts</td>
</tr>
<tr>
<td class="address-1"><span id="24480"></span>24480</td>
<td class="instruction">RES 5,(HL)</td>
</tr>
<tr>
<td class="address-1"><span id="24482"></span>24482</td>
<td class="instruction">LD HL,56384</td>
<td class="comment-1" rowspan="1">The theme tune data starts at <a href="56385.html">56385</a></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="24485"></span>
<div class="comments">
<div class="paragraph">
This entry point is used by the routine at <a href="23907.html">23907</a> with <span class="register">HL</span>=<a href="56364.html">56364</a>-1 (the up-a-year tune data starts at <a href="56364.html">56364</a>).
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="24485"></span>24485</td>
<td class="instruction">DI</td>
<td class="comment-1" rowspan="1">Disable interrupts</td>
</tr>
<tr>
<td class="address-2"><span id="24486"></span>24486</td>
<td class="instruction">INC HL</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at the next tune datum</td>
</tr>
<tr>
<td class="address-1"><span id="24487"></span>24487</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1">Pick it up</td>
</tr>
<tr>
<td class="address-1"><span id="24488"></span>24488</td>
<td class="instruction">INC A</td>
<td class="comment-1" rowspan="1">Is it an end-of-section marker?</td>
</tr>
<tr>
<td class="address-1"><span id="24489"></span>24489</td>
<td class="instruction">JR NZ,24496</td>
<td class="comment-1" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="address-1"><span id="24491"></span>24491</td>
<td class="instruction">INC HL</td>
<td class="comment-1" rowspan="5">Point <span class="register">HL</span> at the first datum in the next section</td>
</tr>
<tr>
<td class="address-1"><span id="24492"></span>24492</td>
<td class="instruction">LD A,(HL)</td>
</tr>
<tr>
<td class="address-1"><span id="24493"></span>24493</td>
<td class="instruction">INC HL</td>
</tr>
<tr>
<td class="address-1"><span id="24494"></span>24494</td>
<td class="instruction">LD H,(HL)</td>
</tr>
<tr>
<td class="address-1"><span id="24495"></span>24495</td>
<td class="instruction">LD L,A</td>
</tr>
<tr>
<td class="address-2"><span id="24496"></span>24496</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=tune datum</td>
</tr>
<tr>
<td class="address-1"><span id="24497"></span>24497</td>
<td class="instruction">AND A</td>
<td class="comment-1" rowspan="1">Have we reached the end of the tune?</td>
</tr>
<tr>
<td class="address-1"><span id="24498"></span>24498</td>
<td class="instruction">JP Z,<a href="62094.html#62169">62169</a></td>
<td class="comment-1" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="24501"></span>
<div class="comments">
<div class="paragraph">
A non-zero tune datum has been found, meaning the tune is not finished yet.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="24501"></span>24501</td>
<td class="instruction">PUSH HL</td>
<td class="comment-1" rowspan="1">Save the tune data table pointer</td>
</tr>
<tr>
<td class="address-1"><span id="24502"></span>24502</td>
<td class="instruction">RRCA</td>
<td class="comment-1" rowspan="1">Set the carry flag if we should pause briefly</td>
</tr>
<tr>
<td class="address-1"><span id="24503"></span>24503</td>
<td class="instruction">LD B,A</td>
<td class="comment-1" rowspan="1">Copy the right-rotated tune datum to <span class="register">B</span></td>
</tr>
<tr>
<td class="address-1"><span id="24504"></span>24504</td>
<td class="instruction">JR NC,24514</td>
<td class="comment-1" rowspan="1">Jump unless we should pause briefly</td>
</tr>
<tr>
<td class="address-1"><span id="24506"></span>24506</td>
<td class="instruction">LD D,15</td>
<td class="comment-1" rowspan="5">Pause briefly</td>
</tr>
<tr>
<td class="address-2"><span id="24508"></span>24508</td>
<td class="instruction">DEC E</td>
</tr>
<tr>
<td class="address-1"><span id="24509"></span>24509</td>
<td class="instruction">JR NZ,24508</td>
</tr>
<tr>
<td class="address-1"><span id="24511"></span>24511</td>
<td class="instruction">DEC D</td>
</tr>
<tr>
<td class="address-1"><span id="24512"></span>24512</td>
<td class="instruction">JR NZ,24508</td>
</tr>
<tr>
<td class="address-2"><span id="24514"></span>24514</td>
<td class="instruction">AND 7</td>
<td class="comment-1" rowspan="1">0&lt;=<span class="register">A</span>&lt;=7</td>
</tr>
<tr>
<td class="address-1"><span id="24516"></span>24516</td>
<td class="instruction">LD C,A</td>
<td class="comment-1" rowspan="1"><span class="register">C</span>=border colour for this note</td>
</tr>
<tr>
<td class="address-1"><span id="24517"></span>24517</td>
<td class="instruction">ADD A,A</td>
<td class="comment-1" rowspan="4">Point <span class="register">HL</span> at an entry in the note duration/pitch data table at <a href="24560.html">24560</a></td>
</tr>
<tr>
<td class="address-1"><span id="24518"></span>24518</td>
<td class="instruction">ADD A,240</td>
</tr>
<tr>
<td class="address-1"><span id="24520"></span>24520</td>
<td class="instruction">LD L,A</td>
</tr>
<tr>
<td class="address-1"><span id="24521"></span>24521</td>
<td class="instruction">LD H,95</td>
</tr>
<tr>
<td class="address-1"><span id="24523"></span>24523</td>
<td class="instruction">LD A,B</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=original tune datum rotated right one bit</td>
</tr>
<tr>
<td class="address-1"><span id="24524"></span>24524</td>
<td class="instruction">RRCA</td>
<td class="comment-1" rowspan="13">Obtain the note frequency parameter in <span class="register">E</span> and the note duration parameter in <span class="register">HL</span></td>
</tr>
<tr>
<td class="address-1"><span id="24525"></span>24525</td>
<td class="instruction">RRCA</td>
</tr>
<tr>
<td class="address-1"><span id="24526"></span>24526</td>
<td class="instruction">RRCA</td>
</tr>
<tr>
<td class="address-1"><span id="24527"></span>24527</td>
<td class="instruction">AND 15</td>
</tr>
<tr>
<td class="address-1"><span id="24529"></span>24529</td>
<td class="instruction">LD B,A</td>
</tr>
<tr>
<td class="address-1"><span id="24530"></span>24530</td>
<td class="instruction">LD E,(HL)</td>
</tr>
<tr>
<td class="address-1"><span id="24531"></span>24531</td>
<td class="instruction">INC L</td>
</tr>
<tr>
<td class="address-1"><span id="24532"></span>24532</td>
<td class="instruction">LD A,(HL)</td>
</tr>
<tr>
<td class="address-1"><span id="24533"></span>24533</td>
<td class="instruction">LD HL,0</td>
</tr>
<tr>
<td class="address-2"><span id="24536"></span>24536</td>
<td class="instruction">ADD HL,DE</td>
</tr>
<tr>
<td class="address-1"><span id="24537"></span>24537</td>
<td class="instruction">DJNZ 24536</td>
</tr>
<tr>
<td class="address-1"><span id="24539"></span>24539</td>
<td class="instruction">RES 0,L</td>
</tr>
<tr>
<td class="address-1"><span id="24541"></span>24541</td>
<td class="instruction">LD E,A</td>
</tr>
<tr>
<td class="address-2"><span id="24542"></span>24542</td>
<td class="instruction">LD A,C</td>
<td class="comment-1" rowspan="11">Produce a note</td>
</tr>
<tr>
<td class="address-1"><span id="24543"></span>24543</td>
<td class="instruction">OUT (254),A</td>
</tr>
<tr>
<td class="address-1"><span id="24545"></span>24545</td>
<td class="instruction">XOR 16</td>
</tr>
<tr>
<td class="address-1"><span id="24547"></span>24547</td>
<td class="instruction">LD C,A</td>
</tr>
<tr>
<td class="address-1"><span id="24548"></span>24548</td>
<td class="instruction">LD B,E</td>
</tr>
<tr>
<td class="address-2"><span id="24549"></span>24549</td>
<td class="instruction">DJNZ 24549</td>
</tr>
<tr>
<td class="address-1"><span id="24551"></span>24551</td>
<td class="instruction">DEC HL</td>
</tr>
<tr>
<td class="address-1"><span id="24552"></span>24552</td>
<td class="instruction">DEC L</td>
</tr>
<tr>
<td class="address-1"><span id="24553"></span>24553</td>
<td class="instruction">LD A,H</td>
</tr>
<tr>
<td class="address-1"><span id="24554"></span>24554</td>
<td class="instruction">OR L</td>
</tr>
<tr>
<td class="address-1"><span id="24555"></span>24555</td>
<td class="instruction">JR NZ,24542</td>
</tr>
<tr>
<td class="address-1"><span id="24557"></span>24557</td>
<td class="instruction">POP HL</td>
<td class="comment-1" rowspan="1">Restore the tune data table pointer to <span class="register">HL</span></td>
</tr>
<tr>
<td class="address-1"><span id="24558"></span>24558</td>
<td class="instruction">JR 24486</td>
<td class="comment-1" rowspan="1">Pick up the next tune datum</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="24476.html">24476</a>
</td>
<td class="up">Up: <a href="../maps/all.html#24477">Map</a></td>
<td class="next">
Next: <a href="24560.html">24560</a>
</td>
</tr>
</table>
<footer>
<div class="release">The complete Back to Skool RAM disassembly 20200811</div>
<div class="copyright">&#169; 1985 Microsphere Computer Services Ltd. &#169; 2020 Richard Dymond.</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 8.2.</div>
<div><a href="../../asm/5F9D.html">Switch to hexadecimal</a>.</div>
</footer>
</body>
</html>