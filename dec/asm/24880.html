<!DOCTYPE html>
<html>
<head>
<title>Back to Skool: Routine at 24880</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="Back to Skool" src="../../images/logo-dec.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="24878.html">24878</a>
</td>
<td class="up">Up: <a href="../maps/all.html#24880">Map</a></td>
<td class="next">
Next: <a href="25011.html">25011</a>
</td>
</tr>
</table>
<div class="description">24880: Update a character's animatory state and location and update the SRB</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
Used by many routines. Sets the new animatory state and location of a character, and updates the <a href="32512.html">screen refresh buffer</a> (SRB) accordingly.
</div>
</div>
<table class="input">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">A</td>
<td class="register-desc">New animatory state</td>
</tr>
<tr>
<td class="register">D</td>
<td class="register-desc">New y-coordinate (3-17)</td>
</tr>
<tr>
<td class="register">E</td>
<td class="register-desc">New x-coordinate (0-189)</td>
</tr>
<tr>
<td class="register">H</td>
<td class="register-desc">Character number (183-214)</td>
</tr>
</table>
</td>
</tr>
<tr>
<td class="address-2"><span id="24880"></span>24880</td>
<td class="instruction">LD L,2</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at byte 2 of the character's buffer</td>
</tr>
<tr>
<td class="address-1"><span id="24882"></span>24882</td>
<td class="instruction">LD (HL),D</td>
<td class="comment-1" rowspan="1">Fill in the new y-coordinate</td>
</tr>
<tr>
<td class="address-1"><span id="24883"></span>24883</td>
<td class="instruction">DEC L</td>
<td class="comment-1" rowspan="1"><span class="register">L</span>=1</td>
</tr>
<tr>
<td class="address-1"><span id="24884"></span>24884</td>
<td class="instruction">LD (HL),E</td>
<td class="comment-1" rowspan="1">Fill in the new x-coordinate</td>
</tr>
<tr>
<td class="address-1"><span id="24885"></span>24885</td>
<td class="instruction">DEC L</td>
<td class="comment-1" rowspan="1"><span class="register">L</span>=0</td>
</tr>
<tr>
<td class="address-1"><span id="24886"></span>24886</td>
<td class="instruction">LD (HL),A</td>
<td class="comment-1" rowspan="1">Fill in the new animatory state</td>
</tr>
<tr>
<td class="address-1"><span id="24887"></span>24887</td>
<td class="instruction">LD C,A</td>
<td class="comment-1" rowspan="1"><span class="register">C</span>=new animatory state</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="24888"></span>
<div class="comments">
<div class="paragraph">
This entry point is used by the routine at <a href="25012.html">25012</a> to update the SRB for the current animatory state and location of the character.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="24888"></span>24888</td>
<td class="instruction">LD A,(32767)</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=leftmost column of the play area on screen (0-160)</td>
</tr>
<tr>
<td class="address-1"><span id="24891"></span>24891</td>
<td class="instruction">SUB 3</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-1"><span id="24893"></span>24893</td>
<td class="instruction">JR C,24897</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-1"><span id="24895"></span>24895</td>
<td class="instruction">CP E</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-1"><span id="24896"></span>24896</td>
<td class="instruction">RET NC</td>
<td class="comment-1" rowspan="1">Return if the character is entirely off-screen to the left</td>
</tr>
<tr>
<td class="address-2"><span id="24897"></span>24897</td>
<td class="instruction">ADD A,34</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-1"><span id="24899"></span>24899</td>
<td class="instruction">CP E</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-1"><span id="24900"></span>24900</td>
<td class="instruction">RET C</td>
<td class="comment-1" rowspan="1">Return if the character is entirely off-screen to the right</td>
</tr>
<tr>
<td class="address-1"><span id="24901"></span>24901</td>
<td class="instruction">SUB 32</td>
<td class="comment-1" rowspan="3"><span class="register">A</span>=<span class="register">E</span>-(<a href="32767.html">32767</a>): the character's relative x-coordinate (-2 to 31)</td>
</tr>
<tr>
<td class="address-1"><span id="24903"></span>24903</td>
<td class="instruction">CPL</td>
</tr>
<tr>
<td class="address-1"><span id="24904"></span>24904</td>
<td class="instruction">ADD A,E</td>
</tr>
<tr>
<td class="address-1"><span id="24905"></span>24905</td>
<td class="instruction">LD B,3</td>
<td class="comment-1" rowspan="1">The sprites are 3 tiles wide</td>
</tr>
<tr>
<td class="address-1"><span id="24907"></span>24907</td>
<td class="instruction">PUSH HL</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-1"><span id="24908"></span>24908</td>
<td class="instruction">LD H,215</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-1"><span id="24910"></span>24910</td>
<td class="instruction">CP 254</td>
<td class="comment-1" rowspan="1">Is the character either fully on-screen or walking off it to the right?</td>
</tr>
<tr>
<td class="address-1"><span id="24912"></span>24912</td>
<td class="instruction">JR C,24924</td>
<td class="comment-1" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="address-1"><span id="24914"></span>24914</td>
<td class="instruction">LD H,219</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-1"><span id="24916"></span>24916</td>
<td class="instruction">DEC B</td>
<td class="comment-1" rowspan="1"><span class="register">B</span>=2</td>
</tr>
<tr>
<td class="address-1"><span id="24917"></span>24917</td>
<td class="instruction">INC A</td>
<td class="comment-1" rowspan="1">Is the character one-third off (two-thirds on) at the left?</td>
</tr>
<tr>
<td class="address-1"><span id="24918"></span>24918</td>
<td class="instruction">JR Z,24924</td>
<td class="comment-1" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="address-1"><span id="24920"></span>24920</td>
<td class="instruction">LD H,223</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-1"><span id="24922"></span>24922</td>
<td class="instruction">DEC B</td>
<td class="comment-1" rowspan="1"><span class="register">B</span>=1 (the character is one-third on-screen at the left)</td>
</tr>
<tr>
<td class="address-1"><span id="24923"></span>24923</td>
<td class="instruction">XOR A</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-2"><span id="24924"></span>24924</td>
<td class="instruction">LD E,A</td>
<td class="comment-1" rowspan="1"><span class="register">E</span>=leftmost column of the screen occupied by the character's sprite (0-31)</td>
</tr>
<tr>
<td class="address-1"><span id="24925"></span>24925</td>
<td class="instruction">SUB 30</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-1"><span id="24927"></span>24927</td>
<td class="instruction">JR C,24932</td>
<td class="comment-1" rowspan="1">Jump if the character is one- or two-thirds off-screen to the right</td>
</tr>
<tr>
<td class="address-1"><span id="24929"></span>24929</td>
<td class="instruction">CPL</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-1"><span id="24930"></span>24930</td>
<td class="instruction">ADD A,B</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-1"><span id="24931"></span>24931</td>
<td class="instruction">LD B,A</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="24932"></span>
<div class="comments">
<div class="paragraph">
Now <span class="register">B</span> holds a value (1, 2 or 3) equal to the number of columns of the screen occupied by the character's sprite.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="24932"></span>24932</td>
<td class="instruction">LD L,C</td>
<td class="comment-1" rowspan="1"><span class="register">L</span>=animatory state</td>
</tr>
<tr>
<td class="address-1"><span id="24933"></span>24933</td>
<td class="instruction">LD C,0</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-1"><span id="24935"></span>24935</td>
<td class="instruction">BIT 7,L</td>
<td class="comment-1" rowspan="1">Is the character facing left?</td>
</tr>
<tr>
<td class="address-1"><span id="24937"></span>24937</td>
<td class="instruction">JR Z,24945</td>
<td class="comment-1" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="address-1"><span id="24939"></span>24939</td>
<td class="instruction">LD C,248</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-1"><span id="24941"></span>24941</td>
<td class="instruction">LD A,182</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-1"><span id="24943"></span>24943</td>
<td class="instruction">SUB H</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-1"><span id="24944"></span>24944</td>
<td class="instruction">LD H,A</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="24945"></span>
<div class="comments">
<div class="paragraph">
Now <span class="register">H</span> holds 215, 219 or 223 - the page containing the UDG reference for the tile on the top row of the leftmost column of the sprite that is on-screen. <span class="register">C</span> is 0 if the character is facing left, or -8 if he's facing right.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="24945"></span>24945</td>
<td class="instruction">SET 7,L</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at the UDG reference for the sprite tile</td>
</tr>
<tr>
<td class="address-1"><span id="24947"></span>24947</td>
<td class="instruction">LD A,E</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=leftmost column of the screen occupied by the sprite (0-31)</td>
</tr>
<tr>
<td class="address-1"><span id="24948"></span>24948</td>
<td class="instruction">EXX</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-1"><span id="24949"></span>24949</td>
<td class="instruction">AND 7</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-1"><span id="24951"></span>24951</td>
<td class="instruction">ADD A,120</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-1"><span id="24953"></span>24953</td>
<td class="instruction">LD L,A</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-1"><span id="24954"></span>24954</td>
<td class="instruction">LD H,225</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-1"><span id="24956"></span>24956</td>
<td class="instruction">LD C,(HL)</td>
<td class="comment-1" rowspan="1">Pick up a byte from the table at <a href="57720.html">57720</a></td>
</tr>
<tr>
<td class="address-1"><span id="24957"></span>24957</td>
<td class="instruction">EXX</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="24958"></span>
<div class="comments">
<div class="paragraph">
Now <span class="register">C'</span> holds 1, 2, 4, 8, 16, 32, 64 or 128. The bit set in <span class="register">C'</span> corresponds to the bit that needs to be set in the relevant byte of the screen refresh buffer (SRB).
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="24958"></span>24958</td>
<td class="instruction">LD A,E</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=leftmost column of the screen occupied by the sprite</td>
</tr>
<tr>
<td class="address-1"><span id="24959"></span>24959</td>
<td class="instruction">RRCA</td>
<td class="comment-1" rowspan="8">Set <span class="register">A</span> to the LSB of the first byte of the SRB that needs to be modified</td>
</tr>
<tr>
<td class="address-1"><span id="24960"></span>24960</td>
<td class="instruction">RRCA</td>
</tr>
<tr>
<td class="address-1"><span id="24961"></span>24961</td>
<td class="instruction">RRCA</td>
</tr>
<tr>
<td class="address-1"><span id="24962"></span>24962</td>
<td class="instruction">AND 3</td>
</tr>
<tr>
<td class="address-1"><span id="24964"></span>24964</td>
<td class="instruction">ADD A,D</td>
</tr>
<tr>
<td class="address-1"><span id="24965"></span>24965</td>
<td class="instruction">ADD A,D</td>
</tr>
<tr>
<td class="address-1"><span id="24966"></span>24966</td>
<td class="instruction">ADD A,D</td>
</tr>
<tr>
<td class="address-1"><span id="24967"></span>24967</td>
<td class="instruction">ADD A,D</td>
</tr>
<tr>
<td class="address-1"><span id="24968"></span>24968</td>
<td class="instruction">EXX</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-1"><span id="24969"></span>24969</td>
<td class="instruction">LD B,A</td>
<td class="comment-1" rowspan="1">Copy this LSB to <span class="register">B'</span></td>
</tr>
<tr>
<td class="address-1"><span id="24970"></span>24970</td>
<td class="instruction">LD H,127</td>
<td class="comment-1" rowspan="1">The SRB starts at page 127 (<a href="32512.html">32512</a>)</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="24972"></span>
<div class="comments">
<div class="paragraph">
Here we enter a loop to set the appropriate bits in the SRB.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="24972"></span>24972</td>
<td class="instruction">EXX</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-1"><span id="24973"></span>24973</td>
<td class="instruction">LD E,0</td>
<td class="comment-1" rowspan="1"><span class="register">E</span> will count up to 4 (the number of rows occupied by a sprite)</td>
</tr>
<tr>
<td class="address-2"><span id="24975"></span>24975</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1">Pick up the sprite tile UDG reference in <span class="register">A</span></td>
</tr>
<tr>
<td class="address-1"><span id="24976"></span>24976</td>
<td class="instruction">AND A</td>
<td class="comment-1" rowspan="1">Is this the 'null' UDG (blank square)?</td>
</tr>
<tr>
<td class="address-1"><span id="24977"></span>24977</td>
<td class="instruction">JR Z,24989</td>
<td class="comment-1" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="address-1"><span id="24979"></span>24979</td>
<td class="instruction">LD A,E</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=sprite tile row number (0-3)</td>
</tr>
<tr>
<td class="address-1"><span id="24980"></span>24980</td>
<td class="instruction">ADD A,A</td>
<td class="comment-1" rowspan="2">Multiply by 4 (the number of bytes of the SRB that correspond to one row of the screen)</td>
</tr>
<tr>
<td class="address-1"><span id="24981"></span>24981</td>
<td class="instruction">ADD A,A</td>
</tr>
<tr>
<td class="address-1"><span id="24982"></span>24982</td>
<td class="instruction">EXX</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-1"><span id="24983"></span>24983</td>
<td class="instruction">ADD A,B</td>
<td class="comment-1" rowspan="2">Point <span class="register">HL'</span> at the relevant byte of the SRB</td>
</tr>
<tr>
<td class="address-1"><span id="24984"></span>24984</td>
<td class="instruction">LD L,A</td>
</tr>
<tr>
<td class="address-1"><span id="24985"></span>24985</td>
<td class="instruction">LD A,C</td>
<td class="comment-1" rowspan="1">The bit set in <span class="register">A</span> is the bit that needs setting in the SRB byte</td>
</tr>
<tr>
<td class="address-1"><span id="24986"></span>24986</td>
<td class="instruction">OR (HL)</td>
<td class="comment-1" rowspan="2">Set the bit in the SRB</td>
</tr>
<tr>
<td class="address-1"><span id="24987"></span>24987</td>
<td class="instruction">LD (HL),A</td>
</tr>
<tr>
<td class="address-1"><span id="24988"></span>24988</td>
<td class="instruction">EXX</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-2"><span id="24989"></span>24989</td>
<td class="instruction">INC H</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at the UDG reference for the next tile in the sprite (one row down)</td>
</tr>
<tr>
<td class="address-1"><span id="24990"></span>24990</td>
<td class="instruction">INC E</td>
<td class="comment-1" rowspan="1">Next row down in this column of the sprite</td>
</tr>
<tr>
<td class="address-1"><span id="24991"></span>24991</td>
<td class="instruction">BIT 2,E</td>
<td class="comment-1" rowspan="1">Have we done all four rows yet?</td>
</tr>
<tr>
<td class="address-1"><span id="24993"></span>24993</td>
<td class="instruction">JR Z,24975</td>
<td class="comment-1" rowspan="1">Jump back if not</td>
</tr>
<tr>
<td class="address-1"><span id="24995"></span>24995</td>
<td class="instruction">DEC B</td>
<td class="comment-1" rowspan="1">Have we done all the columns occupied by the sprite yet?</td>
</tr>
<tr>
<td class="address-1"><span id="24996"></span>24996</td>
<td class="instruction">JR Z,25009</td>
<td class="comment-1" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="address-1"><span id="24998"></span>24998</td>
<td class="instruction">LD A,H</td>
<td class="comment-1" rowspan="3">Point <span class="register">HL</span> at the UDG reference for the tile in the top row of the next column of the sprite (<span class="register">C</span>=0 if the character's facing left, -8 if facing right)</td>
</tr>
<tr>
<td class="address-1"><span id="24999"></span>24999</td>
<td class="instruction">ADD A,C</td>
</tr>
<tr>
<td class="address-1"><span id="25000"></span>25000</td>
<td class="instruction">LD H,A</td>
</tr>
<tr>
<td class="address-1"><span id="25001"></span>25001</td>
<td class="instruction">EXX</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-1"><span id="25002"></span>25002</td>
<td class="instruction">RRC C</td>
<td class="comment-1" rowspan="1">Move the SRB marker bit one place to the right (possibly wrapping round to bit 7)</td>
</tr>
<tr>
<td class="address-1"><span id="25004"></span>25004</td>
<td class="instruction">JR NC,24972</td>
<td class="comment-1" rowspan="1">Jump back if there are still bits to be set in the current SRB byte</td>
</tr>
<tr>
<td class="address-1"><span id="25006"></span>25006</td>
<td class="instruction">INC B</td>
<td class="comment-1" rowspan="1">Otherwise move to the next SRB byte</td>
</tr>
<tr>
<td class="address-1"><span id="25007"></span>25007</td>
<td class="instruction">JR 24972</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-2"><span id="25009"></span>25009</td>
<td class="instruction">POP HL</td>
<td class="comment-1" rowspan="1">Restore the character number to <span class="register">H</span> (<span class="register">L</span>=0)</td>
</tr>
<tr>
<td class="address-1"><span id="25010"></span>25010</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1"></td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="24878.html">24878</a>
</td>
<td class="up">Up: <a href="../maps/all.html#24880">Map</a></td>
<td class="next">
Next: <a href="25011.html">25011</a>
</td>
</tr>
</table>
<footer>
<div class="release">The complete Back to Skool RAM disassembly 20221122</div>
<div class="copyright">&#169; 1985 Microsphere Computer Services Ltd. &#169; 2022 Richard Dymond.</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 8.8.</div>
<div><a href="../../asm/6130.html">Switch to hexadecimal</a>.</div>
</footer>
</body>
</html>