<!DOCTYPE html>
<html>
<head>
<title>Back to Skool: Routine at 29278</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="Back to Skool" src="../../images/logo-dec.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="29277.html">29277</a>
</td>
<td class="up">Up: <a href="../maps/all.html#29278">Map</a></td>
<td class="next">
Next: <a href="29462.html">29462</a>
</td>
</tr>
</table>
<div class="description">29278: Deal with ERIC when he's riding the bike</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
Called by the routine at <a href="63405.html">63405</a> when bit 0 at <a href="32749.html">32749</a> is set (by the routine at <a href="29462.html">29462</a>). Listens for and responds appropriately to keypresses while ERIC is sitting on the saddle of the bike.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="29278"></span>29278</td>
<td class="instruction">LD HL,32755</td>
<td class="comment-1" rowspan="1"><a href="32755.html">32755</a> holds ERIC's main action timer</td>
</tr>
<tr>
<td class="address-1"><span id="29281"></span>29281</td>
<td class="instruction">DEC (HL)</td>
<td class="comment-1" rowspan="1">Is it time to deal with ERIC yet?</td>
</tr>
<tr>
<td class="address-1"><span id="29282"></span>29282</td>
<td class="instruction">JR NZ,29402</td>
<td class="comment-1" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="address-1"><span id="29284"></span>29284</td>
<td class="instruction">INC (HL)</td>
<td class="comment-1" rowspan="1">Set ERIC's action timer to 1, ensuring that we pass through the following section of code on the next call to this routine if no pedalling is detected this time (if 'left' or 'right' is pressed, the action timer will be reset to 5)</td>
</tr>
<tr>
<td class="address-1"><span id="29285"></span>29285</td>
<td class="instruction">CALL <a href="29178.html">29178</a></td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=value from the <a href="58624.html">keypress offset table</a> corresponding to the key just pressed (if any)</td>
</tr>
<tr>
<td class="address-1"><span id="29288"></span>29288</td>
<td class="instruction">LD HL,32750</td>
<td class="comment-1" rowspan="1"><a href="32750.html">32750</a> holds the offset of the last key pressed while ERIC was riding the bike</td>
</tr>
<tr>
<td class="address-1"><span id="29291"></span>29291</td>
<td class="instruction">JR Z,29402</td>
<td class="comment-1" rowspan="1">Jump if no keys were pressed since the last check</td>
</tr>
<tr>
<td class="address-1"><span id="29293"></span>29293</td>
<td class="instruction">SET 3,A</td>
<td class="comment-1" rowspan="1">We don't distinguish between fast (upper case) and slow (lower case) keypresses while ERIC is riding the bike</td>
</tr>
<tr>
<td class="address-1"><span id="29295"></span>29295</td>
<td class="instruction">CP 88</td>
<td class="comment-1" rowspan="1">Was 'left' pressed?</td>
</tr>
<tr>
<td class="address-1"><span id="29297"></span>29297</td>
<td class="instruction">JR Z,29303</td>
<td class="comment-1" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="address-1"><span id="29299"></span>29299</td>
<td class="instruction">CP 90</td>
<td class="comment-1" rowspan="1">Was 'right' pressed?</td>
</tr>
<tr>
<td class="address-1"><span id="29301"></span>29301</td>
<td class="instruction">JR NZ,29333</td>
<td class="comment-1" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="address-2"><span id="29303"></span>29303</td>
<td class="instruction">CP (HL)</td>
<td class="comment-1" rowspan="1">Was the key just pressed the same as the last one pressed?</td>
</tr>
<tr>
<td class="address-1"><span id="29304"></span>29304</td>
<td class="instruction">JR Z,29402</td>
<td class="comment-1" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="29306"></span>
<div class="comments">
<div class="paragraph">
The 'left' key was pressed after a non-left key, or the 'right' key was pressed after a non-right key. In other words, ERIC pedalled.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="29306"></span>29306</td>
<td class="instruction">LD (HL),A</td>
<td class="comment-1" rowspan="1">Store the offset of the key just pressed in <a href="32750.html">32750</a></td>
</tr>
<tr>
<td class="address-1"><span id="29307"></span>29307</td>
<td class="instruction">LD L,243</td>
<td class="comment-1" rowspan="1"><span class="register">HL</span>=<a href="32755.html">32755</a> (ERIC's main action timer)</td>
</tr>
<tr>
<td class="address-1"><span id="29309"></span>29309</td>
<td class="instruction">LD (HL),5</td>
<td class="comment-1" rowspan="1">Reset this to 5</td>
</tr>
<tr>
<td class="address-1"><span id="29311"></span>29311</td>
<td class="instruction">LD L,240</td>
<td class="comment-1" rowspan="1"><span class="register">HL</span>=<a href="32752.html">32752</a> (bike momentum)</td>
</tr>
<tr>
<td class="address-1"><span id="29313"></span>29313</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="5">Increase the bike's momentum, but not beyond 255</td>
</tr>
<tr>
<td class="address-1"><span id="29314"></span>29314</td>
<td class="instruction">ADD A,12</td>
</tr>
<tr>
<td class="address-1"><span id="29316"></span>29316</td>
<td class="instruction">JR NC,29320</td>
</tr>
<tr>
<td class="address-1"><span id="29318"></span>29318</td>
<td class="instruction">LD A,255</td>
</tr>
<tr>
<td class="address-2"><span id="29320"></span>29320</td>
<td class="instruction">LD (HL),A</td>
</tr>
<tr>
<td class="address-1"><span id="29321"></span>29321</td>
<td class="instruction">LD H,210</td>
<td class="comment-1" rowspan="1">210=ERIC</td>
</tr>
<tr>
<td class="address-1"><span id="29323"></span>29323</td>
<td class="instruction">CALL <a href="25012.html">25012</a></td>
<td class="comment-1" rowspan="1">Update the SRB for ERIC's current animatory state and location</td>
</tr>
<tr>
<td class="address-1"><span id="29326"></span>29326</td>
<td class="instruction">XOR 1</td>
<td class="comment-1" rowspan="1">Now <span class="register">A</span>=ERIC's new animatory state (<a href="../graphics/as.html#12">12</a>, <a href="../graphics/as.html#13">13</a>, <a href="../graphics/as.html#140">140</a> or <a href="../graphics/as.html#141">141</a>)</td>
</tr>
<tr>
<td class="address-1"><span id="29328"></span>29328</td>
<td class="instruction">CALL <a href="24880.html">24880</a></td>
<td class="comment-1" rowspan="1">Update ERIC's animatory state and update the SRB</td>
</tr>
<tr>
<td class="address-1"><span id="29331"></span>29331</td>
<td class="instruction">JR 29402</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="29333"></span>
<div class="comments">
<div class="paragraph">
Neither 'left' nor 'right' was pressed.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="29333"></span>29333</td>
<td class="instruction">CP 92</td>
<td class="comment-1" rowspan="1">Was 'up' pressed?</td>
</tr>
<tr>
<td class="address-1"><span id="29335"></span>29335</td>
<td class="instruction">JR NZ,29382</td>
<td class="comment-1" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="address-1"><span id="29337"></span>29337</td>
<td class="instruction">LD L,237</td>
<td class="comment-1" rowspan="1"><span class="register">HL</span>=<a href="32749.html">32749</a> (ERIC's status flags)</td>
</tr>
<tr>
<td class="address-1"><span id="29339"></span>29339</td>
<td class="instruction">LD (HL),128</td>
<td class="comment-1" rowspan="1">Set bit 7: ERIC is standing on the saddle of the bike</td>
</tr>
<tr>
<td class="address-1"><span id="29341"></span>29341</td>
<td class="instruction">LD H,210</td>
<td class="comment-1" rowspan="1">210=ERIC</td>
</tr>
<tr>
<td class="address-1"><span id="29343"></span>29343</td>
<td class="instruction">CALL <a href="25012.html">25012</a></td>
<td class="comment-1" rowspan="1">Update the SRB for ERIC's current animatory state and location</td>
</tr>
<tr>
<td class="address-1"><span id="29346"></span>29346</td>
<td class="instruction">PUSH DE</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-1"><span id="29347"></span>29347</td>
<td class="instruction">DEC D</td>
<td class="comment-1" rowspan="1"><span class="register">D</span>=ERIC's new y-coordinate (up a level)</td>
</tr>
<tr>
<td class="address-1"><span id="29348"></span>29348</td>
<td class="instruction">NOP</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-1"><span id="29349"></span>29349</td>
<td class="instruction">INC E</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-1"><span id="29350"></span>29350</td>
<td class="instruction">BIT 7,A</td>
<td class="comment-1" rowspan="1">Is ERIC facing left?</td>
</tr>
<tr>
<td class="address-1"><span id="29352"></span>29352</td>
<td class="instruction">JR Z,29356</td>
<td class="comment-1" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="address-1"><span id="29354"></span>29354</td>
<td class="instruction">DEC E</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-1"><span id="29355"></span>29355</td>
<td class="instruction">DEC E</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-2"><span id="29356"></span>29356</td>
<td class="instruction">AND 128</td>
<td class="comment-1" rowspan="1">Now <span class="register">A</span>=ERIC's new animatory state, <span class="register">E</span>=ERIC's new x-coordinate</td>
</tr>
<tr>
<td class="address-1"><span id="29358"></span>29358</td>
<td class="instruction">CALL <a href="24880.html">24880</a></td>
<td class="comment-1" rowspan="1">Update ERIC's animatory state and location and update the SRB</td>
</tr>
<tr>
<td class="address-1"><span id="29361"></span>29361</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=ERIC's animatory state</td>
</tr>
<tr>
<td class="address-1"><span id="29362"></span>29362</td>
<td class="instruction">POP DE</td>
<td class="comment-1" rowspan="1"><span class="register">DE</span>=ERIC's location before he jumped on the saddle or got off the bike</td>
</tr>
<tr>
<td class="address-1"><span id="29363"></span>29363</td>
<td class="instruction">ADD A,25</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=animatory state of the bike standing upright (<a href="../graphics/as.html#25">25 or 153</a>)</td>
</tr>
<tr>
<td class="address-1"><span id="29365"></span>29365</td>
<td class="instruction">INC H</td>
<td class="comment-1" rowspan="1"><span class="register">H</span>=211: bike</td>
</tr>
<tr>
<td class="address-1"><span id="29366"></span>29366</td>
<td class="instruction">CALL <a href="24880.html">24880</a></td>
<td class="comment-1" rowspan="1">Update the bike's animatory state and update the SRB</td>
</tr>
<tr>
<td class="address-1"><span id="29369"></span>29369</td>
<td class="instruction">LD HL,29194</td>
<td class="comment-1" rowspan="2">Place the address of the uninterruptible subcommand routine at <a href="29194.html">29194</a> into bytes 17 and 18 of the bike's buffer</td>
</tr>
<tr>
<td class="address-1"><span id="29372"></span>29372</td>
<td class="instruction">LD (54033),HL</td>
</tr>
<tr>
<td class="address-1"><span id="29375"></span>29375</td>
<td class="instruction">LD HL,32755</td>
<td class="comment-1" rowspan="1"><a href="32755.html">32755</a> holds ERIC's main action timer</td>
</tr>
<tr>
<td class="address-1"><span id="29378"></span>29378</td>
<td class="instruction">LD (HL),5</td>
<td class="comment-1" rowspan="1">Reset this to 5</td>
</tr>
<tr>
<td class="address-1"><span id="29380"></span>29380</td>
<td class="instruction">JR 29436</td>
<td class="comment-1" rowspan="1">Also reset the bike's speed counter (at <a href="32751.html">32751</a>) to 5</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="29382"></span>
<div class="comments">
<div class="paragraph">
Not one of 'left', 'right' and 'up' was pressed.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="29382"></span>29382</td>
<td class="instruction">CP 94</td>
<td class="comment-1" rowspan="1">Was 'down' pressed?</td>
</tr>
<tr>
<td class="address-1"><span id="29384"></span>29384</td>
<td class="instruction">JR NZ,29402</td>
<td class="comment-1" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="address-1"><span id="29386"></span>29386</td>
<td class="instruction">LD L,237</td>
<td class="comment-1" rowspan="1"><span class="register">HL</span>=<a href="32749.html">32749</a> (ERIC's status flags)</td>
</tr>
<tr>
<td class="address-1"><span id="29388"></span>29388</td>
<td class="instruction">LD (HL),0</td>
<td class="comment-1" rowspan="1">Reset all bits here, signalling that ERIC has his feet back on the ground</td>
</tr>
<tr>
<td class="address-1"><span id="29390"></span>29390</td>
<td class="instruction">LD L,251</td>
<td class="comment-1" rowspan="1"><span class="register">HL</span>=<a href="32763.html">32763</a> (ERIC's other status flags)</td>
</tr>
<tr>
<td class="address-1"><span id="29392"></span>29392</td>
<td class="instruction">RES 1,(HL)</td>
<td class="comment-1" rowspan="1">Reset bit 1 here, signalling that <a href="32749.html">32749</a> is empty</td>
</tr>
<tr>
<td class="address-1"><span id="29394"></span>29394</td>
<td class="instruction">LD H,210</td>
<td class="comment-1" rowspan="1">210=ERIC</td>
</tr>
<tr>
<td class="address-1"><span id="29396"></span>29396</td>
<td class="instruction">CALL <a href="25012.html">25012</a></td>
<td class="comment-1" rowspan="1">Update the SRB for ERIC's current animatory state and location</td>
</tr>
<tr>
<td class="address-1"><span id="29399"></span>29399</td>
<td class="instruction">PUSH DE</td>
<td class="comment-1" rowspan="1">Save ERIC's current location</td>
</tr>
<tr>
<td class="address-1"><span id="29400"></span>29400</td>
<td class="instruction">JR 29356</td>
<td class="comment-1" rowspan="1">Jump back to update the animatory state and location of ERIC and the bike</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="29402"></span>
<div class="comments">
<div class="paragraph">
The following section of code is executed on every pass through this routine while ERIC is sitting on the saddle (in other words, unless 'up' or 'down' was pressed).
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="29402"></span>29402</td>
<td class="instruction">LD HL,32752</td>
<td class="comment-1" rowspan="1"><a href="32752.html">32752</a> holds the bike's momentum</td>
</tr>
<tr>
<td class="address-1"><span id="29405"></span>29405</td>
<td class="instruction">DEC (HL)</td>
<td class="comment-1" rowspan="1">Has the bike run out of momentum?</td>
</tr>
<tr>
<td class="address-1"><span id="29406"></span>29406</td>
<td class="instruction">JR NZ,29441</td>
<td class="comment-1" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="address-2"><span id="29408"></span>29408</td>
<td class="instruction">LD H,210</td>
<td class="comment-1" rowspan="1">210=ERIC, who will now fall off the bike</td>
</tr>
<tr>
<td class="address-1"><span id="29410"></span>29410</td>
<td class="instruction">CALL <a href="25012.html">25012</a></td>
<td class="comment-1" rowspan="1">Update the SRB for ERIC's current animatory state and location</td>
</tr>
<tr>
<td class="address-1"><span id="29413"></span>29413</td>
<td class="instruction">PUSH DE</td>
<td class="comment-1" rowspan="1">Save ERIC's coordinates briefly</td>
</tr>
<tr>
<td class="address-1"><span id="29414"></span>29414</td>
<td class="instruction">AND 128</td>
<td class="comment-1" rowspan="1">Keep only the 'direction' bit of ERIC's animatory state</td>
</tr>
<tr>
<td class="address-1"><span id="29416"></span>29416</td>
<td class="instruction">PUSH AF</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-1"><span id="29417"></span>29417</td>
<td class="instruction">ADD A,4</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=<a href="../graphics/as.html#4">4 or 132</a> (ERIC sitting on a chair)</td>
</tr>
<tr>
<td class="address-1"><span id="29419"></span>29419</td>
<td class="instruction">CALL <a href="24880.html">24880</a></td>
<td class="comment-1" rowspan="1">Update ERIC's animatory state and update the ARB</td>
</tr>
<tr>
<td class="address-1"><span id="29422"></span>29422</td>
<td class="instruction">POP AF</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=0 if ERIC's facing left, 128 if facing right</td>
</tr>
<tr>
<td class="address-1"><span id="29423"></span>29423</td>
<td class="instruction">POP DE</td>
<td class="comment-1" rowspan="1">Restore ERIC's coordinates to <span class="register">DE</span></td>
</tr>
<tr>
<td class="address-1"><span id="29424"></span>29424</td>
<td class="instruction">ADD A,24</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=<a href="../graphics/as.html#24">24 or 152</a> (bike lying on the floor)</td>
</tr>
<tr>
<td class="address-1"><span id="29426"></span>29426</td>
<td class="instruction">LD H,211</td>
<td class="comment-1" rowspan="1">211=bike</td>
</tr>
<tr>
<td class="address-1"><span id="29428"></span>29428</td>
<td class="instruction">CALL <a href="24880.html">24880</a></td>
<td class="comment-1" rowspan="1">Update the bike's animatory state and update the SRB</td>
</tr>
<tr>
<td class="address-1"><span id="29431"></span>29431</td>
<td class="instruction">LD HL,32749</td>
<td class="comment-1" rowspan="1"><a href="32749.html">32749</a> holds ERIC's status flags</td>
</tr>
<tr>
<td class="address-1"><span id="29434"></span>29434</td>
<td class="instruction">LD (HL),16</td>
<td class="comment-1" rowspan="1">Set bit 4: ERIC will not land on his feet</td>
</tr>
<tr>
<td class="address-2"><span id="29436"></span>29436</td>
<td class="instruction">LD L,239</td>
<td class="comment-1" rowspan="1"><span class="register">HL</span>=<a href="32751.html">32751</a> (which holds the bike's speed counter)</td>
</tr>
<tr>
<td class="address-1"><span id="29438"></span>29438</td>
<td class="instruction">LD (HL),5</td>
<td class="comment-1" rowspan="1">Reset this to 5</td>
</tr>
<tr>
<td class="address-1"><span id="29440"></span>29440</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="29441"></span>
<div class="comments">
<div class="paragraph">
The bike still has momentum.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="29441"></span>29441</td>
<td class="instruction">LD L,239</td>
<td class="comment-1" rowspan="1"><span class="register">HL</span>=<a href="32751.html">32751</a> (which holds the bike's speed counter)</td>
</tr>
<tr>
<td class="address-1"><span id="29443"></span>29443</td>
<td class="instruction">DEC (HL)</td>
<td class="comment-1" rowspan="1">Is it time to move the bike forward?</td>
</tr>
<tr>
<td class="address-1"><span id="29444"></span>29444</td>
<td class="instruction">RET NZ</td>
<td class="comment-1" rowspan="1">Return if not</td>
</tr>
<tr>
<td class="address-1"><span id="29445"></span>29445</td>
<td class="instruction">LD (HL),7</td>
<td class="comment-1" rowspan="1">Reset the bike's speed counter to 7</td>
</tr>
<tr>
<td class="address-1"><span id="29447"></span>29447</td>
<td class="instruction">LD HL,(53760)</td>
<td class="comment-1" rowspan="3"><span class="register">A</span>=ERIC's animatory state, <span class="register">E</span>=ERIC's x-coordinate</td>
</tr>
<tr>
<td class="address-1"><span id="29450"></span>29450</td>
<td class="instruction">LD A,L</td>
</tr>
<tr>
<td class="address-1"><span id="29451"></span>29451</td>
<td class="instruction">LD E,H</td>
</tr>
<tr>
<td class="address-1"><span id="29452"></span>29452</td>
<td class="instruction">CALL <a href="28672.html">28672</a></td>
<td class="comment-1" rowspan="1">Are there any walls, closed doors or ALBERTs in ERIC's path?</td>
</tr>
<tr>
<td class="address-1"><span id="29455"></span>29455</td>
<td class="instruction">JR C,29408</td>
<td class="comment-1" rowspan="2">Knock ERIC off the bike if so</td>
</tr>
<tr>
<td class="address-1"><span id="29457"></span>29457</td>
<td class="instruction">JR Z,29408</td>
</tr>
<tr>
<td class="address-1"><span id="29459"></span>29459</td>
<td class="instruction">JP <a href="29194.html#29262">29262</a></td>
<td class="comment-1" rowspan="1">Otherwise move ERIC forward one space, update the SRB, and scroll the screen if necessary</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="29277.html">29277</a>
</td>
<td class="up">Up: <a href="../maps/all.html#29278">Map</a></td>
<td class="next">
Next: <a href="29462.html">29462</a>
</td>
</tr>
</table>
<footer>
<div class="release">The complete Back to Skool RAM disassembly 20221122</div>
<div class="copyright">&#169; 1985 Microsphere Computer Services Ltd. &#169; 2022 Richard Dymond.</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 8.8.</div>
<div><a href="../../asm/725E.html">Switch to hexadecimal</a>.</div>
</footer>
</body>
</html>