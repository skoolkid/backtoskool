<!DOCTYPE html>
<html>
<head>
<title>Back to Skool: Routine at 27144</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="Back to Skool" src="../../images/logo-dec.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="27143.html">27143</a>
</td>
<td class="up">Up: <a href="../maps/all.html#27144">Map</a></td>
<td class="next">
Next: <a href="27272.html">27272</a>
</td>
</tr>
</table>
<div class="description">27144: Make a character speak</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
The address of this interruptible subcommand routine is placed into bytes 9 and 10 of the character's buffer by the routine at <a href="61533.html">61533</a>, <a href="61555.html">61555</a>, <a href="61696.html">61696</a>, <a href="62032.html">62032</a> or <a href="62815.html">62815</a>.
</div>
</div>
<table class="input">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">E</td>
<td class="register-desc">Message number</td>
</tr>
<tr>
<td class="register">H</td>
<td class="register-desc">Character number (200-204, 208)</td>
</tr>
</table>
</td>
</tr>
<tr>
<td class="address-2"><span id="27144"></span>27144</td>
<td class="instruction">LD L,11</td>
<td class="comment-1" rowspan="2">Store the message number in byte 11 of the character's buffer</td>
</tr>
<tr>
<td class="address-1"><span id="27146"></span>27146</td>
<td class="instruction">LD (HL),E</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="27147"></span>
<div class="comments">
<div class="paragraph">
The address of this entry point is placed into bytes 9 and 10 of EINSTEIN's buffer by the routine at <a href="61440.html">61440</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="27147"></span>27147</td>
<td class="instruction">LD L,16</td>
<td class="comment-1" rowspan="5">Clear bytes 12-16 of the character's buffer, thus removing the addresses of any old (sub)(sub)messages</td>
</tr>
<tr>
<td class="address-1"><span id="27149"></span>27149</td>
<td class="instruction">LD B,5</td>
</tr>
<tr>
<td class="address-2"><span id="27151"></span>27151</td>
<td class="instruction">LD (HL),0</td>
</tr>
<tr>
<td class="address-1"><span id="27153"></span>27153</td>
<td class="instruction">DEC L</td>
</tr>
<tr>
<td class="address-1"><span id="27154"></span>27154</td>
<td class="instruction">DJNZ 27151</td>
</tr>
<tr>
<td class="address-1"><span id="27156"></span>27156</td>
<td class="instruction">LD E,(HL)</td>
<td class="comment-1" rowspan="1"><span class="register">E</span>=message number</td>
</tr>
<tr>
<td class="address-1"><span id="27157"></span>27157</td>
<td class="instruction">LD D,254</td>
<td class="comment-1" rowspan="7">Pick up the address of the message and place it into bytes 11 and 12 of the character's buffer</td>
</tr>
<tr>
<td class="address-1"><span id="27159"></span>27159</td>
<td class="instruction">LD A,(DE)</td>
</tr>
<tr>
<td class="address-1"><span id="27160"></span>27160</td>
<td class="instruction">LD (HL),A</td>
</tr>
<tr>
<td class="address-1"><span id="27161"></span>27161</td>
<td class="instruction">INC D</td>
</tr>
<tr>
<td class="address-1"><span id="27162"></span>27162</td>
<td class="instruction">LD A,(DE)</td>
</tr>
<tr>
<td class="address-1"><span id="27163"></span>27163</td>
<td class="instruction">INC L</td>
</tr>
<tr>
<td class="address-1"><span id="27164"></span>27164</td>
<td class="instruction">LD (HL),A</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="27165"></span>
<div class="comments">
<div class="paragraph">
If somebody else is already speaking, this entry point is used while this character waits his turn to speak.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="27165"></span>27165</td>
<td class="instruction">LD A,(32760)</td>
<td class="comment-1" rowspan="1"><a href="32760.html">32760</a> holds the LSB of the SRB address corresponding to the lip of the speech bubble (or 0 if there is no bubble on-screen)</td>
</tr>
<tr>
<td class="address-1"><span id="27168"></span>27168</td>
<td class="instruction">LD L,9</td>
<td class="comment-1" rowspan="2">Place the address of the entry point at <a href="27144.html#27165">27165</a> into bytes 9 and 10 of the character's buffer</td>
</tr>
<tr>
<td class="address-1"><span id="27170"></span>27170</td>
<td class="instruction">LD (HL),29</td>
</tr>
<tr>
<td class="address-1"><span id="27172"></span>27172</td>
<td class="instruction">AND A</td>
<td class="comment-1" rowspan="1">Is anyone else speaking at the moment?</td>
</tr>
<tr>
<td class="address-1"><span id="27173"></span>27173</td>
<td class="instruction">RET NZ</td>
<td class="comment-1" rowspan="1">Return if so</td>
</tr>
<tr>
<td class="address-1"><span id="27174"></span>27174</td>
<td class="instruction">LD (HL),46</td>
<td class="comment-1" rowspan="1">Place the address of the entry point at <a href="27144.html#27182">27182</a> into bytes 9 and 10 of the character's buffer</td>
</tr>
<tr>
<td class="address-1"><span id="27176"></span>27176</td>
<td class="instruction">CALL <a href="26958.html">26958</a></td>
<td class="comment-1" rowspan="1">Print the speech bubble if the character's head is on-screen</td>
</tr>
<tr>
<td class="address-1"><span id="27179"></span>27179</td>
<td class="instruction">RET NC</td>
<td class="comment-1" rowspan="1">Return if the character's head is on-screen</td>
</tr>
<tr>
<td class="address-1"><span id="27180"></span>27180</td>
<td class="instruction">JR 27205</td>
<td class="comment-1" rowspan="1">Otherwise make this routine relinquish control of the character</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="27182"></span>
<div class="comments">
<div class="paragraph">
This entry point is used while the character is speaking.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="27182"></span>27182</td>
<td class="instruction">PUSH HL</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-1"><span id="27183"></span>27183</td>
<td class="instruction">CALL <a href="26849.html">26849</a></td>
<td class="comment-1" rowspan="1">Update the SRB so that the speech bubble is not corrupted</td>
</tr>
<tr>
<td class="address-1"><span id="27186"></span>27186</td>
<td class="instruction">POP HL</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-1"><span id="27187"></span>27187</td>
<td class="instruction">JR NC,27202</td>
<td class="comment-1" rowspan="1">Jump if the speech bubble is no longer on-screen</td>
</tr>
<tr>
<td class="address-1"><span id="27189"></span>27189</td>
<td class="instruction">EXX</td>
<td class="comment-1" rowspan="3">Point <span class="register">HL'</span> at the end of the buffer (at <a href="23296.html">23296</a>) which will contain the speech text graphic data</td>
</tr>
<tr>
<td class="address-1"><span id="27190"></span>27190</td>
<td class="instruction">LD HL,23359</td>
</tr>
<tr>
<td class="address-1"><span id="27193"></span>27193</td>
<td class="instruction">EXX</td>
</tr>
<tr>
<td class="address-1"><span id="27194"></span>27194</td>
<td class="instruction">LD B,2</td>
<td class="comment-1" rowspan="1">We scroll the message two letters at a time</td>
</tr>
<tr>
<td class="address-2"><span id="27196"></span>27196</td>
<td class="instruction">CALL <a href="26318.html">26318</a></td>
<td class="comment-1" rowspan="1">Collect in <span class="register">A</span> the next character code from the message</td>
</tr>
<tr>
<td class="address-1"><span id="27199"></span>27199</td>
<td class="instruction">AND A</td>
<td class="comment-1" rowspan="1">Has the message finished?</td>
</tr>
<tr>
<td class="address-1"><span id="27200"></span>27200</td>
<td class="instruction">JR NZ,27208</td>
<td class="comment-1" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="27202"></span>
<div class="comments">
<div class="paragraph">
The message has finished, or the speech bubble has been scrolled off the screen. Either way, the character has finished speaking.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="27202"></span>27202</td>
<td class="instruction">CALL <a href="26910.html">26910</a></td>
<td class="comment-1" rowspan="1">Update the SRB to get rid of the speech bubble</td>
</tr>
<tr>
<td class="address-2"><span id="27205"></span>27205</td>
<td class="instruction">JP <a href="25484.html#25488">25488</a></td>
<td class="comment-1" rowspan="1">Terminate this interruptible subcommand</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="27208"></span>
<div class="comments">
<div class="paragraph">
The character has not finished speaking.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="27208"></span>27208</td>
<td class="instruction">PUSH BC</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-1"><span id="27209"></span>27209</td>
<td class="instruction">CALL <a href="27110.html">27110</a></td>
<td class="comment-1" rowspan="1">Roll the font character bitmap into the message buffer</td>
</tr>
<tr>
<td class="address-1"><span id="27212"></span>27212</td>
<td class="instruction">POP BC</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-1"><span id="27213"></span>27213</td>
<td class="instruction">DJNZ 27196</td>
<td class="comment-1" rowspan="1">Jump back until two more letters have been rolled into the buffer</td>
</tr>
<tr>
<td class="address-1"><span id="27215"></span>27215</td>
<td class="instruction">LD L,29</td>
<td class="comment-1" rowspan="2">Reset the walk/run bit in byte 29 of the character's buffer to make sure he speaks slowly</td>
</tr>
<tr>
<td class="address-1"><span id="27217"></span>27217</td>
<td class="instruction">RES 7,(HL)</td>
</tr>
<tr>
<td class="address-1"><span id="27219"></span>27219</td>
<td class="instruction">LD A,(32760)</td>
<td class="comment-1" rowspan="2">Now <span class="register">A</span>=LSB of the address of the SRB byte corresponding to the top line of the speech bubble</td>
</tr>
<tr>
<td class="address-1"><span id="27222"></span>27222</td>
<td class="instruction">SUB 8</td>
</tr>
<tr>
<td class="address-1"><span id="27224"></span>27224</td>
<td class="instruction">LD L,A</td>
<td class="comment-1" rowspan="13">Set <span class="register">HL</span> to the display file address of the start of the top pixel line of text</td>
</tr>
<tr>
<td class="address-1"><span id="27225"></span>27225</td>
<td class="instruction">RRCA</td>
</tr>
<tr>
<td class="address-1"><span id="27226"></span>27226</td>
<td class="instruction">RRCA</td>
</tr>
<tr>
<td class="address-1"><span id="27227"></span>27227</td>
<td class="instruction">AND 24</td>
</tr>
<tr>
<td class="address-1"><span id="27229"></span>27229</td>
<td class="instruction">ADD A,68</td>
</tr>
<tr>
<td class="address-1"><span id="27231"></span>27231</td>
<td class="instruction">LD H,A</td>
</tr>
<tr>
<td class="address-1"><span id="27232"></span>27232</td>
<td class="instruction">LD A,L</td>
</tr>
<tr>
<td class="address-1"><span id="27233"></span>27233</td>
<td class="instruction">ADD A,A</td>
</tr>
<tr>
<td class="address-1"><span id="27234"></span>27234</td>
<td class="instruction">ADD A,A</td>
</tr>
<tr>
<td class="address-1"><span id="27235"></span>27235</td>
<td class="instruction">ADD A,A</td>
</tr>
<tr>
<td class="address-1"><span id="27236"></span>27236</td>
<td class="instruction">LD L,A</td>
</tr>
<tr>
<td class="address-1"><span id="27237"></span>27237</td>
<td class="instruction">NOP</td>
</tr>
<tr>
<td class="address-1"><span id="27238"></span>27238</td>
<td class="instruction">INC L</td>
</tr>
<tr>
<td class="address-1"><span id="27239"></span>27239</td>
<td class="instruction">LD DE,23298</td>
<td class="comment-1" rowspan="1">The speech text graphic data is stored in the 64-byte buffer at <a href="23296.html">23296</a></td>
</tr>
<tr>
<td class="address-1"><span id="27242"></span>27242</td>
<td class="instruction">EX DE,HL</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-1"><span id="27243"></span>27243</td>
<td class="instruction">CALL 27255</td>
<td class="comment-1" rowspan="1">Print the top 4 pixel rows of the text inside the speech bubble</td>
</tr>
<tr>
<td class="address-1"><span id="27246"></span>27246</td>
<td class="instruction">ADD A,32</td>
<td class="comment-1" rowspan="6">Set <span class="register">DE</span> to the display file address of the start of the 5th pixel row of text</td>
</tr>
<tr>
<td class="address-1"><span id="27248"></span>27248</td>
<td class="instruction">LD E,A</td>
</tr>
<tr>
<td class="address-1"><span id="27249"></span>27249</td>
<td class="instruction">JR C,27256</td>
</tr>
<tr>
<td class="address-1"><span id="27251"></span>27251</td>
<td class="instruction">LD A,D</td>
</tr>
<tr>
<td class="address-1"><span id="27252"></span>27252</td>
<td class="instruction">SUB 8</td>
</tr>
<tr>
<td class="address-1"><span id="27254"></span>27254</td>
<td class="instruction">LD D,A</td>
</tr>
<tr>
<td class="address-2"><span id="27255"></span>27255</td>
<td class="instruction">LD A,E</td>
<td class="comment-1" rowspan="1">Save the LSB of the base display file address</td>
</tr>
<tr>
<td class="address-2"><span id="27256"></span>27256</td>
<td class="instruction">LD B,4</td>
<td class="comment-1" rowspan="1">4 pixel lines at a time</td>
</tr>
<tr>
<td class="address-2"><span id="27258"></span>27258</td>
<td class="instruction">PUSH BC</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-1"><span id="27259"></span>27259</td>
<td class="instruction">LD BC,6</td>
<td class="comment-1" rowspan="1">There are 6 character squares inside the speech bubble</td>
</tr>
<tr>
<td class="address-1"><span id="27262"></span>27262</td>
<td class="instruction">LDIR</td>
<td class="comment-1" rowspan="1">Copy a row of 6 bytes to the screen</td>
</tr>
<tr>
<td class="address-1"><span id="27264"></span>27264</td>
<td class="instruction">INC L</td>
<td class="comment-1" rowspan="2">Move <span class="register">HL</span> to the start of the next row of pixel data in the message buffer</td>
</tr>
<tr>
<td class="address-1"><span id="27265"></span>27265</td>
<td class="instruction">INC L</td>
</tr>
<tr>
<td class="address-1"><span id="27266"></span>27266</td>
<td class="instruction">LD E,A</td>
<td class="comment-1" rowspan="1">Restore the LSB of the base display file address</td>
</tr>
<tr>
<td class="address-1"><span id="27267"></span>27267</td>
<td class="instruction">INC D</td>
<td class="comment-1" rowspan="1">Next pixel row down</td>
</tr>
<tr>
<td class="address-1"><span id="27268"></span>27268</td>
<td class="instruction">POP BC</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-1"><span id="27269"></span>27269</td>
<td class="instruction">DJNZ 27258</td>
<td class="comment-1" rowspan="1">Jump back until all 4 pixel rows in this half have been copied to the screen</td>
</tr>
<tr>
<td class="address-1"><span id="27271"></span>27271</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1"></td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="27143.html">27143</a>
</td>
<td class="up">Up: <a href="../maps/all.html#27144">Map</a></td>
<td class="next">
Next: <a href="27272.html">27272</a>
</td>
</tr>
</table>
<footer>
<div class="release">The complete Back to Skool RAM disassembly 20221122</div>
<div class="copyright">&#169; 1985 Microsphere Computer Services Ltd. &#169; 2022 Richard Dymond.</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 8.8.</div>
<div><a href="../../asm/6A08.html">Switch to hexadecimal</a>.</div>
</footer>
</body>
</html>