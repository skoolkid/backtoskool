<!DOCTYPE html>
<html>
<head>
<title>Back to Skool: Routine at 30555</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="Back to Skool" src="../../images/logo-dec.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="30543.html">30543</a>
</td>
<td class="up">Up: <a href="../maps/all.html#30555">Map</a></td>
<td class="next">
Next: <a href="30643.html">30643</a>
</td>
</tr>
</table>
<div class="description">30555: Make BOY WANDER fire his catapult now and then</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
The address of this continual subcommand routine is placed into bytes 23 and 24 of BOY WANDER's buffer by command lists <a href="58768.html">32</a>, <a href="59488.html">46</a> and <a href="59519.html">50</a>, and is also used by the routine at <a href="63492.html">63492</a>. It decides whether BOY WANDER should let rip with a pellet, and gets the catapult-firing action under way if so.
</div>
</div>
<table class="input">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">H</td>
<td class="register-desc">206 (BOY WANDER)</td>
</tr>
</table>
</td>
</tr>
<tr>
<td class="address-2"><span id="30555"></span>30555</td>
<td class="instruction">LD A,(54546)</td>
<td class="comment-1" rowspan="1">Pick up byte 18 of buffer 213 (BOY WANDER's pellet)</td>
</tr>
<tr>
<td class="address-1"><span id="30558"></span>30558</td>
<td class="instruction">AND A</td>
<td class="comment-1" rowspan="1">Is there a uninterruptible subcommand routine address in bytes 17 and 18 of the buffer?</td>
</tr>
<tr>
<td class="address-1"><span id="30559"></span>30559</td>
<td class="instruction">RET NZ</td>
<td class="comment-1" rowspan="1">Return if so (this buffer is in use)</td>
</tr>
<tr>
<td class="address-1"><span id="30560"></span>30560</td>
<td class="instruction">LD L,A</td>
<td class="comment-1" rowspan="1"><span class="register">L</span>=0</td>
</tr>
<tr>
<td class="address-1"><span id="30561"></span>30561</td>
<td class="instruction">BIT 0,(HL)</td>
<td class="comment-1" rowspan="1">Is BOY WANDER midstride?</td>
</tr>
<tr>
<td class="address-1"><span id="30563"></span>30563</td>
<td class="instruction">RET NZ</td>
<td class="comment-1" rowspan="1">Return if so</td>
</tr>
<tr>
<td class="address-1"><span id="30564"></span>30564</td>
<td class="instruction">INC L</td>
<td class="comment-1" rowspan="1"><span class="register">L</span>=1</td>
</tr>
<tr>
<td class="address-1"><span id="30565"></span>30565</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=BOY WANDER's x-coordinate</td>
</tr>
<tr>
<td class="address-1"><span id="30566"></span>30566</td>
<td class="instruction">AND 3</td>
<td class="comment-1" rowspan="2">Return unless BOY WANDER's x-coordinate is divisible by 4</td>
</tr>
<tr>
<td class="address-1"><span id="30568"></span>30568</td>
<td class="instruction">RET NZ</td>
</tr>
<tr>
<td class="address-1"><span id="30569"></span>30569</td>
<td class="instruction">CALL <a href="30543.html">30543</a></td>
<td class="comment-1" rowspan="1">Is BOY WANDER exactly on the top, middle, or bottom floor?</td>
</tr>
<tr>
<td class="address-1"><span id="30572"></span>30572</td>
<td class="instruction">RET NZ</td>
<td class="comment-1" rowspan="1">Return if not</td>
</tr>
<tr>
<td class="address-1"><span id="30573"></span>30573</td>
<td class="instruction">CALL <a href="25233.html">25233</a></td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=random number</td>
</tr>
<tr>
<td class="address-1"><span id="30576"></span>30576</td>
<td class="instruction">RRCA</td>
<td class="comment-1" rowspan="2">Return half the time</td>
</tr>
<tr>
<td class="address-1"><span id="30577"></span>30577</td>
<td class="instruction">RET NC</td>
</tr>
<tr>
<td class="address-1"><span id="30578"></span>30578</td>
<td class="instruction">CALL <a href="28002.html#28004">28004</a></td>
<td class="comment-1" rowspan="1">Can any adults see BOY WANDER?</td>
</tr>
<tr>
<td class="address-1"><span id="30581"></span>30581</td>
<td class="instruction">RET C</td>
<td class="comment-1" rowspan="1">Return if so</td>
</tr>
<tr>
<td class="address-1"><span id="30582"></span>30582</td>
<td class="instruction">POP BC</td>
<td class="comment-1" rowspan="1">Drop the return address (<a href="25296.html#25431">25431</a>)</td>
</tr>
<tr>
<td class="address-1"><span id="30583"></span>30583</td>
<td class="instruction">POP BC</td>
<td class="comment-1" rowspan="1">Pop the value of <span class="register">HL</span> that was pushed on to the stack by the routine at <a href="25296.html">25296</a> before coming here; RET will now take us back either to <a href="25296.html">25296</a> to move the next character, or to the main loop</td>
</tr>
<tr>
<td class="address-1"><span id="30584"></span>30584</td>
<td class="instruction">CALL <a href="25012.html">25012</a></td>
<td class="comment-1" rowspan="1">Update the SRB for BOY WANDER's current animatory state and location</td>
</tr>
<tr>
<td class="address-1"><span id="30587"></span>30587</td>
<td class="instruction">LD L,20</td>
<td class="comment-1" rowspan="2">Store BOY WANDER's current animatory state in byte 20 of his buffer for the time being</td>
</tr>
<tr>
<td class="address-1"><span id="30589"></span>30589</td>
<td class="instruction">LD (HL),A</td>
</tr>
<tr>
<td class="address-1"><span id="30590"></span>30590</td>
<td class="instruction">AND 240</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-1"><span id="30592"></span>30592</td>
<td class="instruction">ADD A,10</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=<a href="../graphics/as.html#26">26 or 154</a>: BOY WANDER raising his arm to fire</td>
</tr>
<tr>
<td class="address-1"><span id="30594"></span>30594</td>
<td class="instruction">CALL <a href="30534.html">30534</a></td>
<td class="comment-1" rowspan="1">Update BOY WANDER's animatory state and hand over to <a href="30555.html#30597">30597</a> (below)</td>
</tr>
<tr>
<td class="address-2"><span id="30597"></span>30597</td>
<td class="instruction">CALL <a href="25012.html">25012</a></td>
<td class="comment-1" rowspan="1">Update the SRB for BOY WANDER's current animatory state</td>
</tr>
<tr>
<td class="address-1"><span id="30600"></span>30600</td>
<td class="instruction">INC A</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=<a href="../graphics/as.html#27">27 or 155</a>: BOY WANDER firing the catapult</td>
</tr>
<tr>
<td class="address-1"><span id="30601"></span>30601</td>
<td class="instruction">CALL <a href="30534.html">30534</a></td>
<td class="comment-1" rowspan="1">Update BOY WANDER's animatory state and hand over to <a href="30555.html#30604">30604</a> (below)</td>
</tr>
<tr>
<td class="address-2"><span id="30604"></span>30604</td>
<td class="instruction">LD L,17</td>
<td class="comment-1" rowspan="2">Place the address of the uninterruptible subcommand routine at <a href="30643.html">30643</a> into bytes 17 and 18 of BOY WANDER's buffer</td>
</tr>
<tr>
<td class="address-1"><span id="30606"></span>30606</td>
<td class="instruction">LD (HL),179</td>
</tr>
<tr>
<td class="address-1"><span id="30608"></span>30608</td>
<td class="instruction">LD A,(54546)</td>
<td class="comment-1" rowspan="1">Pick up byte 18 of buffer 213 (BOY WANDER's pellet)</td>
</tr>
<tr>
<td class="address-1"><span id="30611"></span>30611</td>
<td class="instruction">AND A</td>
<td class="comment-1" rowspan="1">Is this buffer already being used?</td>
</tr>
<tr>
<td class="address-1"><span id="30612"></span>30612</td>
<td class="instruction">RET NZ</td>
<td class="comment-1" rowspan="1">Return if so</td>
</tr>
<tr>
<td class="address-1"><span id="30613"></span>30613</td>
<td class="instruction">LD B,213</td>
<td class="comment-1" rowspan="1">Use buffer 213 for BOY WANDER's catapult pellet</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="30615"></span>
<div class="comments">
<div class="paragraph">
This entry point is used by the routine at <a href="63861.html">63861</a> with <span class="register">H</span>=210 (ERIC) and <span class="register">B</span>=214 (ERIC's pellet).
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="30615"></span>30615</td>
<td class="instruction">LD L,0</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at byte 0 of the shooter's character buffer</td>
</tr>
<tr>
<td class="address-1"><span id="30617"></span>30617</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=shooter's animatory state</td>
</tr>
<tr>
<td class="address-1"><span id="30618"></span>30618</td>
<td class="instruction">AND 128</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=128 if the pellet will travel right, 0 if left</td>
</tr>
<tr>
<td class="address-1"><span id="30620"></span>30620</td>
<td class="instruction">ADD A,79</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=<a href="../graphics/as.html#79">79/207</a>: catapult pellet travelling left/right</td>
</tr>
<tr>
<td class="address-1"><span id="30622"></span>30622</td>
<td class="instruction">INC L</td>
<td class="comment-1" rowspan="4">Collect the initial coordinates of the pellet from the shooter's buffer into <span class="register">DE</span></td>
</tr>
<tr>
<td class="address-1"><span id="30623"></span>30623</td>
<td class="instruction">LD E,(HL)</td>
</tr>
<tr>
<td class="address-1"><span id="30624"></span>30624</td>
<td class="instruction">INC L</td>
</tr>
<tr>
<td class="address-1"><span id="30625"></span>30625</td>
<td class="instruction">LD D,(HL)</td>
</tr>
<tr>
<td class="address-1"><span id="30626"></span>30626</td>
<td class="instruction">LD H,B</td>
<td class="comment-1" rowspan="1"><span class="register">H</span>=buffer to be used for the pellet (213 if it's BOY WANDER's, 214 if it's ERIC's)</td>
</tr>
<tr>
<td class="address-1"><span id="30627"></span>30627</td>
<td class="instruction">LD (HL),D</td>
<td class="comment-1" rowspan="5">Fill in the initial coordinates and animatory state of the pellet</td>
</tr>
<tr>
<td class="address-1"><span id="30628"></span>30628</td>
<td class="instruction">DEC L</td>
</tr>
<tr>
<td class="address-1"><span id="30629"></span>30629</td>
<td class="instruction">LD (HL),E</td>
</tr>
<tr>
<td class="address-1"><span id="30630"></span>30630</td>
<td class="instruction">DEC L</td>
</tr>
<tr>
<td class="address-1"><span id="30631"></span>30631</td>
<td class="instruction">LD (HL),A</td>
</tr>
<tr>
<td class="address-1"><span id="30632"></span>30632</td>
<td class="instruction">LD L,17</td>
<td class="comment-1" rowspan="4">Place the address of the pellet-controlling uninterruptible subcommand routine at <a href="30380.html">30380</a> into bytes 17 and 18 of the pellet's buffer</td>
</tr>
<tr>
<td class="address-1"><span id="30634"></span>30634</td>
<td class="instruction">LD (HL),172</td>
</tr>
<tr>
<td class="address-1"><span id="30636"></span>30636</td>
<td class="instruction">INC L</td>
</tr>
<tr>
<td class="address-1"><span id="30637"></span>30637</td>
<td class="instruction">LD (HL),118</td>
</tr>
<tr>
<td class="address-1"><span id="30639"></span>30639</td>
<td class="instruction">INC L</td>
<td class="comment-1" rowspan="1"><span class="register">L</span>=19</td>
</tr>
<tr>
<td class="address-1"><span id="30640"></span>30640</td>
<td class="instruction">LD (HL),13</td>
<td class="comment-1" rowspan="1">The pellet will travel 13 spaces</td>
</tr>
<tr>
<td class="address-1"><span id="30642"></span>30642</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1"></td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="30543.html">30543</a>
</td>
<td class="up">Up: <a href="../maps/all.html#30555">Map</a></td>
<td class="next">
Next: <a href="30643.html">30643</a>
</td>
</tr>
</table>
<footer>
<div class="release">The complete Back to Skool RAM disassembly 20200811</div>
<div class="copyright">&#169; 1985 Microsphere Computer Services Ltd. &#169; 2020 Richard Dymond.</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 8.2.</div>
<div><a href="../../asm/775B.html">Switch to hexadecimal</a>.</div>
</footer>
</body>
</html>