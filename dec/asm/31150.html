<!DOCTYPE html>
<html>
<head>
<title>Back to Skool: Routine at 31150</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="Back to Skool" src="../../images/logo-dec.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="31148.html">31148</a>
</td>
<td class="up">Up: <a href="../maps/all.html#31150">Map</a></td>
<td class="next">
Next: <a href="31252.html">31252</a>
</td>
</tr>
</table>
<div class="description">31150: Make any female characters near a mouse start or continue jumping</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
Used by the routine at <a href="31254.html">31254</a>. Does nothing if the mouse is off-screen. Otherwise, for each female character that is facing the mouse and within five spaces to the left or right of it, either (a) makes her stand on a chair or start jumping if she isn't already, or (b) makes her stay on the chair or keep jumping for a little longer.
</div>
</div>
<table class="input">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">H</td>
<td class="register-desc">Mouse's character number (198, 199, 206-208, 212)</td>
</tr>
</table>
</td>
</tr>
<tr>
<td class="address-2"><span id="31150"></span>31150</td>
<td class="instruction">LD A,(32767)</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=leftmost column of the play area on screen</td>
</tr>
<tr>
<td class="address-1"><span id="31153"></span>31153</td>
<td class="instruction">LD B,A</td>
<td class="comment-1" rowspan="1">Copy this to <span class="register">B</span></td>
</tr>
<tr>
<td class="address-1"><span id="31154"></span>31154</td>
<td class="instruction">LD L,1</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at byte 1 of the mouse's buffer</td>
</tr>
<tr>
<td class="address-1"><span id="31156"></span>31156</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=mouse's x-coordinate</td>
</tr>
<tr>
<td class="address-1"><span id="31157"></span>31157</td>
<td class="instruction">LD E,A</td>
<td class="comment-1" rowspan="1">Copy this to <span class="register">E</span></td>
</tr>
<tr>
<td class="address-1"><span id="31158"></span>31158</td>
<td class="instruction">SUB B</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-1"><span id="31159"></span>31159</td>
<td class="instruction">INC A</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-1"><span id="31160"></span>31160</td>
<td class="instruction">CP 32</td>
<td class="comment-1" rowspan="1">Is this mouse off-screen?</td>
</tr>
<tr>
<td class="address-1"><span id="31162"></span>31162</td>
<td class="instruction">RET NC</td>
<td class="comment-1" rowspan="1">Return if so</td>
</tr>
<tr>
<td class="address-1"><span id="31163"></span>31163</td>
<td class="instruction">INC L</td>
<td class="comment-1" rowspan="1"><span class="register">L</span>=2</td>
</tr>
<tr>
<td class="address-1"><span id="31164"></span>31164</td>
<td class="instruction">LD D,(HL)</td>
<td class="comment-1" rowspan="1"><span class="register">D</span>=mouse's y-coordinate</td>
</tr>
<tr>
<td class="address-1"><span id="31165"></span>31165</td>
<td class="instruction">LD H,183</td>
<td class="comment-1" rowspan="1">183=little girl no. 1</td>
</tr>
<tr>
<td class="address-1"><span id="31167"></span>31167</td>
<td class="instruction">LD B,7</td>
<td class="comment-1" rowspan="1">There are 7 little girls to check</td>
</tr>
<tr>
<td class="address-1"><span id="31169"></span>31169</td>
<td class="instruction">CALL 31181</td>
<td class="comment-1" rowspan="1">Make them start jumping if necessary</td>
</tr>
<tr>
<td class="address-1"><span id="31172"></span>31172</td>
<td class="instruction">LD H,204</td>
<td class="comment-1" rowspan="1">204=MISS TAKE</td>
</tr>
<tr>
<td class="address-1"><span id="31174"></span>31174</td>
<td class="instruction">INC B</td>
<td class="comment-1" rowspan="1">B=1</td>
</tr>
<tr>
<td class="address-1"><span id="31175"></span>31175</td>
<td class="instruction">CALL 31181</td>
<td class="comment-1" rowspan="1">Make MISS TAKE start jumping if necessary</td>
</tr>
<tr>
<td class="address-1"><span id="31178"></span>31178</td>
<td class="instruction">LD H,209</td>
<td class="comment-1" rowspan="1">209=HAYLEY</td>
</tr>
<tr>
<td class="address-1"><span id="31180"></span>31180</td>
<td class="instruction">INC B</td>
<td class="comment-1" rowspan="1">B=1</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="31181"></span>
<div class="comments">
<div class="paragraph">
At this point <span class="register">H</span> holds the number of the first female character to check, and <span class="register">B</span> the number of characters to check (for proximity to a mouse).
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="31181"></span>31181</td>
<td class="instruction">LD L,2</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at byte 2 of the female character's buffer</td>
</tr>
<tr>
<td class="address-1"><span id="31183"></span>31183</td>
<td class="instruction">LD A,D</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=mouse's y-coordinate</td>
</tr>
<tr>
<td class="address-1"><span id="31184"></span>31184</td>
<td class="instruction">SUB (HL)</td>
<td class="comment-1" rowspan="1">Subtract that of the female character under consideration</td>
</tr>
<tr>
<td class="address-1"><span id="31185"></span>31185</td>
<td class="instruction">JR Z,31197</td>
<td class="comment-1" rowspan="1">Jump if the female character is standing on the same floor as the mouse</td>
</tr>
<tr>
<td class="address-1"><span id="31187"></span>31187</td>
<td class="instruction">DEC A</td>
<td class="comment-1" rowspan="1">Is the female character one level above the mouse?</td>
</tr>
<tr>
<td class="address-1"><span id="31188"></span>31188</td>
<td class="instruction">JR NZ,31248</td>
<td class="comment-1" rowspan="1">Jump ahead to consider the next character if not</td>
</tr>
<tr>
<td class="address-1"><span id="31190"></span>31190</td>
<td class="instruction">LD L,18</td>
<td class="comment-1" rowspan="2">Pick up the MSB of any uninterruptible subcommand routine address in bytes 17 and 18 of the character's buffer</td>
</tr>
<tr>
<td class="address-1"><span id="31192"></span>31192</td>
<td class="instruction">LD A,(HL)</td>
</tr>
<tr>
<td class="address-1"><span id="31193"></span>31193</td>
<td class="instruction">CP 121</td>
<td class="comment-1" rowspan="1">Is this character jumping (121=MSB of <a href="31078.html">31078</a> or <a href="31092.html">31092</a>)?</td>
</tr>
<tr>
<td class="address-1"><span id="31195"></span>31195</td>
<td class="instruction">JR NZ,31248</td>
<td class="comment-1" rowspan="1">Jump ahead to consider the next character if not</td>
</tr>
<tr>
<td class="address-2"><span id="31197"></span>31197</td>
<td class="instruction">LD L,1</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at byte 1 of the character's buffer</td>
</tr>
<tr>
<td class="address-1"><span id="31199"></span>31199</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=female character's x-coordinate</td>
</tr>
<tr>
<td class="address-1"><span id="31200"></span>31200</td>
<td class="instruction">SUB E</td>
<td class="comment-1" rowspan="1">Subtract that of the mouse</td>
</tr>
<tr>
<td class="address-1"><span id="31201"></span>31201</td>
<td class="instruction">LD L,0</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at byte 0 of the character's buffer</td>
</tr>
<tr>
<td class="address-1"><span id="31203"></span>31203</td>
<td class="instruction">JR Z,31225</td>
<td class="comment-1" rowspan="1">Jump if the girl is standing right where the mouse is</td>
</tr>
<tr>
<td class="address-1"><span id="31205"></span>31205</td>
<td class="instruction">JR NC,31217</td>
<td class="comment-1" rowspan="1">Jump if the girl is standing to the right of the mouse</td>
</tr>
<tr>
<td class="address-1"><span id="31207"></span>31207</td>
<td class="instruction">CP 251</td>
<td class="comment-1" rowspan="1">Is the girl within 5 spaces to the left of the mouse?</td>
</tr>
<tr>
<td class="address-1"><span id="31209"></span>31209</td>
<td class="instruction">JR C,31248</td>
<td class="comment-1" rowspan="1">Jump ahead to consider the next character if not</td>
</tr>
<tr>
<td class="address-1"><span id="31211"></span>31211</td>
<td class="instruction">BIT 7,(HL)</td>
<td class="comment-1" rowspan="1">Is the female character facing left?</td>
</tr>
<tr>
<td class="address-1"><span id="31213"></span>31213</td>
<td class="instruction">JR Z,31248</td>
<td class="comment-1" rowspan="1">Jump ahead to consider the next character if so</td>
</tr>
<tr>
<td class="address-1"><span id="31215"></span>31215</td>
<td class="instruction">JR 31225</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-2"><span id="31217"></span>31217</td>
<td class="instruction">CP 6</td>
<td class="comment-1" rowspan="1">Is the girl within 5 spaces to the right of the mouse?</td>
</tr>
<tr>
<td class="address-1"><span id="31219"></span>31219</td>
<td class="instruction">JR NC,31248</td>
<td class="comment-1" rowspan="1">Jump ahead to consider the next character if not</td>
</tr>
<tr>
<td class="address-1"><span id="31221"></span>31221</td>
<td class="instruction">BIT 7,(HL)</td>
<td class="comment-1" rowspan="1">Is the female character facing right?</td>
</tr>
<tr>
<td class="address-1"><span id="31223"></span>31223</td>
<td class="instruction">JR NZ,31248</td>
<td class="comment-1" rowspan="1">Jump ahead to consider the next character if so</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="31225"></span>
<div class="comments">
<div class="paragraph">
The female character is located within 5 spaces of the mouse, and is facing it. Figure out whether she's already jumping, or can start jumping.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="31225"></span>31225</td>
<td class="instruction">LD L,18</td>
<td class="comment-1" rowspan="2">Pick up the MSB of any uninterruptible subcommand routine address in bytes 17 and 18 of the female character's buffer</td>
</tr>
<tr>
<td class="address-1"><span id="31227"></span>31227</td>
<td class="instruction">LD A,(HL)</td>
</tr>
<tr>
<td class="address-1"><span id="31228"></span>31228</td>
<td class="instruction">CP 121</td>
<td class="comment-1" rowspan="1">Set the zero flag if the routine address is <a href="31078.html">31078</a> or <a href="31092.html">31092</a> (i.e. the character is already jumping)</td>
</tr>
<tr>
<td class="address-1"><span id="31230"></span>31230</td>
<td class="instruction">INC HL</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at byte 19 of the character's buffer</td>
</tr>
<tr>
<td class="address-1"><span id="31231"></span>31231</td>
<td class="instruction">JR NZ,31237</td>
<td class="comment-1" rowspan="1">Jump if the character is not jumping</td>
</tr>
<tr>
<td class="address-1"><span id="31233"></span>31233</td>
<td class="instruction">SET 4,(HL)</td>
<td class="comment-1" rowspan="1">Otherwise ensure this character continues jumping for a little longer by setting the counter in byte 19 to at least 16</td>
</tr>
<tr>
<td class="address-1"><span id="31235"></span>31235</td>
<td class="instruction">JR 31248</td>
<td class="comment-1" rowspan="1">Jump ahead to consider the next character</td>
</tr>
<tr>
<td class="address-2"><span id="31237"></span>31237</td>
<td class="instruction">AND A</td>
<td class="comment-1" rowspan="1">Is there an uninterruptible subcommand routine address other than <a href="31078.html">31078</a> or <a href="31092.html">31092</a> in bytes 17 and 18 of the character's buffer (meaning she is otherwise occupied)?</td>
</tr>
<tr>
<td class="address-1"><span id="31238"></span>31238</td>
<td class="instruction">JR NZ,31248</td>
<td class="comment-1" rowspan="1">Jump ahead to consider the next character if so</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="31240"></span>
<div class="comments">
<div class="paragraph">
The female character is not jumping at the moment. Make her start.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="31240"></span>31240</td>
<td class="instruction">LD (HL),21</td>
<td class="comment-1" rowspan="2">Set the delay parameter at byte 19 determining how long the female character will jump up and down</td>
</tr>
<tr>
<td class="address-1"><span id="31242"></span>31242</td>
<td class="instruction">DEC L</td>
</tr>
<tr>
<td class="address-1"><span id="31243"></span>31243</td>
<td class="instruction">LD (HL),121</td>
<td class="comment-1" rowspan="3">Place the address of the uninterruptible subcommand routine at <a href="31092.html">31092</a> into bytes 17 and 18 of the female character's buffer</td>
</tr>
<tr>
<td class="address-1"><span id="31245"></span>31245</td>
<td class="instruction">DEC L</td>
</tr>
<tr>
<td class="address-1"><span id="31246"></span>31246</td>
<td class="instruction">LD (HL),116</td>
</tr>
<tr>
<td class="address-2"><span id="31248"></span>31248</td>
<td class="instruction">INC H</td>
<td class="comment-1" rowspan="1">Next female character</td>
</tr>
<tr>
<td class="address-1"><span id="31249"></span>31249</td>
<td class="instruction">DJNZ 31181</td>
<td class="comment-1" rowspan="1">Jump back until all the characters have been checked</td>
</tr>
<tr>
<td class="address-1"><span id="31251"></span>31251</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1"></td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="31148.html">31148</a>
</td>
<td class="up">Up: <a href="../maps/all.html#31150">Map</a></td>
<td class="next">
Next: <a href="31252.html">31252</a>
</td>
</tr>
</table>
<footer>
<div class="release">The complete Back to Skool RAM disassembly 20221122</div>
<div class="copyright">&#169; 1985 Microsphere Computer Services Ltd. &#169; 2022 Richard Dymond.</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 8.8.</div>
<div><a href="../../asm/79AE.html">Switch to hexadecimal</a>.</div>
</footer>
</body>
</html>