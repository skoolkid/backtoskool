<!DOCTYPE html>
<html>
<head>
<title>Back to Skool: Routine at 30102</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="Back to Skool" src="../../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="30096.html">30096</a>
</td>
<td class="up">Up: <a href="../maps/all.html#30102">Map</a></td>
<td class="next">
Next: <a href="30202.html">30202</a>
</td>
</tr>
</table>
<div class="description">30102: Deal with a character who has been knocked over</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
The address of this uninterruptible subcommand routine is placed into bytes 17 and 18 of the stricken character's buffer by the routine at <a href="29896.html">29896</a>. It knocks the character to the floor, makes him give lines to any nearby kids (if he's a teacher), and then makes him get up.
</div>
</div>
<table class="input">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">H</td>
<td class="register-desc">Character number (183-209)</td>
</tr>
</table>
</td>
</tr>
<tr>
<td class="address-2"><span id="30102"></span>30102</td>
<td class="instruction">LD L,19</td>
<td class="comment-1" rowspan="1">Byte 19 of the character's buffer holds the knockout delay counter</td>
</tr>
<tr>
<td class="address-1"><span id="30104"></span>30104</td>
<td class="instruction">DEC (HL)</td>
<td class="comment-1" rowspan="1">Has the character already got up?</td>
</tr>
<tr>
<td class="address-1"><span id="30105"></span>30105</td>
<td class="instruction">JP Z,<a href="25484.html#25492">25492</a></td>
<td class="comment-1" rowspan="1">Terminate this uninterruptible subcommand if so</td>
</tr>
<tr>
<td class="address-1"><span id="30108"></span>30108</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=knockout delay counter</td>
</tr>
<tr>
<td class="address-1"><span id="30109"></span>30109</td>
<td class="instruction">DEC A</td>
<td class="comment-1" rowspan="1">Is it time for the character to get up yet?</td>
</tr>
<tr>
<td class="address-1"><span id="30110"></span>30110</td>
<td class="instruction">JR NZ,30121</td>
<td class="comment-1" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="30112"></span>
<div class="comments">
<div class="paragraph">
This entry point is used by the routine at <a href="63801.html">63801</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="30112"></span>30112</td>
<td class="instruction">CALL <a href="25012.html">25012</a></td>
<td class="comment-1" rowspan="1">Update the SRB for the character's current animatory state</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="30115"></span>
<div class="comments">
<div class="paragraph">
This entry point is used by the routine at <a href="28978.html">28978</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="30115"></span>30115</td>
<td class="instruction">LD L,20</td>
<td class="comment-1" rowspan="1">Byte 20 of the character's buffer holds the pre-knockout animatory state saved earlier</td>
</tr>
<tr>
<td class="address-1"><span id="30117"></span>30117</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1">Pick this up in <span class="register">A</span></td>
</tr>
<tr>
<td class="address-1"><span id="30118"></span>30118</td>
<td class="instruction">JP <a href="24880.html">24880</a></td>
<td class="comment-1" rowspan="1">Update the character's animatory state and update the SRB</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="30121"></span>
<div class="comments">
<div class="paragraph">
It's not time for the character to get up yet.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="30121"></span>30121</td>
<td class="instruction">DEC A</td>
<td class="comment-1" rowspan="2">Jump forward unless the knockout delay counter has reached 2</td>
</tr>
<tr>
<td class="address-1"><span id="30122"></span>30122</td>
<td class="instruction">JR NZ,30137</td>
</tr>
<tr>
<td class="address-1"><span id="30124"></span>30124</td>
<td class="instruction">LD A,H</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=number of the stricken character</td>
</tr>
<tr>
<td class="address-1"><span id="30125"></span>30125</td>
<td class="instruction">CP 205</td>
<td class="comment-1" rowspan="1">Is it ALBERT?</td>
</tr>
<tr>
<td class="address-1"><span id="30127"></span>30127</td>
<td class="instruction">RET NZ</td>
<td class="comment-1" rowspan="1">Return if not</td>
</tr>
<tr>
<td class="address-1"><span id="30128"></span>30128</td>
<td class="instruction">LD A,(32740)</td>
<td class="comment-1" rowspan="1">Pick up the MSB of the lesson clock</td>
</tr>
<tr>
<td class="address-1"><span id="30131"></span>30131</td>
<td class="instruction">AND A</td>
<td class="comment-1" rowspan="1">Is the lesson nearly over?</td>
</tr>
<tr>
<td class="address-1"><span id="30132"></span>30132</td>
<td class="instruction">RET Z</td>
<td class="comment-1" rowspan="1">Return if so</td>
</tr>
<tr>
<td class="address-1"><span id="30133"></span>30133</td>
<td class="instruction">LD L,19</td>
<td class="comment-1" rowspan="2">Set the knockout delay counter to 3 so that ALBERT will not get up until the lesson's almost over</td>
</tr>
<tr>
<td class="address-1"><span id="30135"></span>30135</td>
<td class="instruction">INC (HL)</td>
</tr>
<tr>
<td class="address-1"><span id="30136"></span>30136</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="30137"></span>
<div class="comments">
<div class="paragraph">
The knockout delay counter has not reached 2 yet. Is it time to knock the character down?
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="30137"></span>30137</td>
<td class="instruction">CP 15</td>
<td class="comment-1" rowspan="1">Is it time for the character to fall over?</td>
</tr>
<tr>
<td class="address-1"><span id="30139"></span>30139</td>
<td class="instruction">JR NZ,30180</td>
<td class="comment-1" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="address-1"><span id="30141"></span>30141</td>
<td class="instruction">LD A,H</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=number of the stricken character</td>
</tr>
<tr>
<td class="address-1"><span id="30142"></span>30142</td>
<td class="instruction">LD DE,32740</td>
<td class="comment-1" rowspan="1">Point <span class="register">DE</span> at the MSB of the lesson clock</td>
</tr>
<tr>
<td class="address-1"><span id="30145"></span>30145</td>
<td class="instruction">CP 205</td>
<td class="comment-1" rowspan="1">Was ALBERT struck?</td>
</tr>
<tr>
<td class="address-1"><span id="30147"></span>30147</td>
<td class="instruction">JR NZ,30155</td>
<td class="comment-1" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="address-1"><span id="30149"></span>30149</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-1" rowspan="3">Add 12 to the MSB of the lesson clock if ALBERT was knocked down, thus giving ERIC some extra time to work with</td>
</tr>
<tr>
<td class="address-1"><span id="30150"></span>30150</td>
<td class="instruction">ADD A,12</td>
</tr>
<tr>
<td class="address-1"><span id="30152"></span>30152</td>
<td class="instruction">LD (DE),A</td>
</tr>
<tr>
<td class="address-1"><span id="30153"></span>30153</td>
<td class="instruction">JR 30167</td>
<td class="comment-1" rowspan="1">Knock ALBERT down</td>
</tr>
<tr>
<td class="address-2"><span id="30155"></span>30155</td>
<td class="instruction">CP 209</td>
<td class="comment-1" rowspan="1">Was HAYLEY struck?</td>
</tr>
<tr>
<td class="address-1"><span id="30157"></span>30157</td>
<td class="instruction">JR NZ,30167</td>
<td class="comment-1" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="address-1"><span id="30159"></span>30159</td>
<td class="instruction">LD E,226</td>
<td class="comment-1" rowspan="1"><span class="register">DE</span>=<a href="32738.html">32738</a> (kiss counter)</td>
</tr>
<tr>
<td class="address-1"><span id="30161"></span>30161</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-1" rowspan="1">Pick this up in <span class="register">A</span></td>
</tr>
<tr>
<td class="address-1"><span id="30162"></span>30162</td>
<td class="instruction">AND A</td>
<td class="comment-1" rowspan="1">Are there any kisses left?</td>
</tr>
<tr>
<td class="address-1"><span id="30163"></span>30163</td>
<td class="instruction">JR Z,30167</td>
<td class="comment-1" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="address-1"><span id="30165"></span>30165</td>
<td class="instruction">DEC A</td>
<td class="comment-1" rowspan="2">Otherwise decrease the kiss counter by 1</td>
</tr>
<tr>
<td class="address-1"><span id="30166"></span>30166</td>
<td class="instruction">LD (DE),A</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="30167"></span>
<div class="comments">
<div class="paragraph">
Knock the character down.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="30167"></span>30167</td>
<td class="instruction">CALL <a href="25012.html">25012</a></td>
<td class="comment-1" rowspan="1">Update the SRB for the character's current animatory state</td>
</tr>
<tr>
<td class="address-1"><span id="30170"></span>30170</td>
<td class="instruction">LD L,20</td>
<td class="comment-1" rowspan="2">Store the character's current animatory state in byte 20 of the buffer for retrieval later (when the character gets up)</td>
</tr>
<tr>
<td class="address-1"><span id="30172"></span>30172</td>
<td class="instruction">LD (HL),A</td>
</tr>
<tr>
<td class="address-1"><span id="30173"></span>30173</td>
<td class="instruction">AND 248</td>
<td class="comment-1" rowspan="2"><span class="register">A</span>=animatory state of the character sitting or lying on the floor</td>
</tr>
<tr>
<td class="address-1"><span id="30175"></span>30175</td>
<td class="instruction">ADD A,6</td>
</tr>
<tr>
<td class="address-1"><span id="30177"></span>30177</td>
<td class="instruction">JP <a href="24880.html">24880</a></td>
<td class="comment-1" rowspan="1">Update the character's animatory state and update the SRB</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="30180"></span>
<div class="comments">
<div class="paragraph">
It's not time to knock the character down.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="30180"></span>30180</td>
<td class="instruction">CP 8</td>
<td class="comment-1" rowspan="1">Is it time for a felled teacher to give lines?</td>
</tr>
<tr>
<td class="address-1"><span id="30182"></span>30182</td>
<td class="instruction">RET NZ</td>
<td class="comment-1" rowspan="1">Return if not</td>
</tr>
<tr>
<td class="address-1"><span id="30183"></span>30183</td>
<td class="instruction">LD A,H</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=number of the stricken character</td>
</tr>
<tr>
<td class="address-1"><span id="30184"></span>30184</td>
<td class="instruction">CP 200</td>
<td class="comment-1" rowspan="4">Return if it's not a teacher</td>
</tr>
<tr>
<td class="address-1"><span id="30186"></span>30186</td>
<td class="instruction">RET C</td>
</tr>
<tr>
<td class="address-1"><span id="30187"></span>30187</td>
<td class="instruction">CP 205</td>
</tr>
<tr>
<td class="address-1"><span id="30189"></span>30189</td>
<td class="instruction">RET NC</td>
</tr>
<tr>
<td class="address-1"><span id="30190"></span>30190</td>
<td class="instruction">PUSH HL</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-1"><span id="30191"></span>30191</td>
<td class="instruction">CALL <a href="28029.html">28029</a></td>
<td class="comment-1" rowspan="1">Find the main kid who is closest to the teacher and within lines-giving range (if any)</td>
</tr>
<tr>
<td class="address-1"><span id="30194"></span>30194</td>
<td class="instruction">POP HL</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-1"><span id="30195"></span>30195</td>
<td class="instruction">AND A</td>
<td class="comment-1" rowspan="1">Is there a main kid close enough to the felled teacher?</td>
</tr>
<tr>
<td class="address-1"><span id="30196"></span>30196</td>
<td class="instruction">RET Z</td>
<td class="comment-1" rowspan="1">Return if not</td>
</tr>
<tr>
<td class="address-1"><span id="30197"></span>30197</td>
<td class="instruction">LD B,15</td>
<td class="comment-1" rowspan="1">Message <a href="59905.html">15</a>: NOW DON'T DO IT AGAIN</td>
</tr>
<tr>
<td class="address-1"><span id="30199"></span>30199</td>
<td class="instruction">JP <a href="29716.html">29716</a></td>
<td class="comment-1" rowspan="1">Give lines to the nearest main kid</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="30096.html">30096</a>
</td>
<td class="up">Up: <a href="../maps/all.html#30102">Map</a></td>
<td class="next">
Next: <a href="30202.html">30202</a>
</td>
</tr>
</table>
<footer>
<div class="release">The complete Back to Skool RAM disassembly 20191115</div>
<div class="copyright">&#169; 1985 Microsphere Computer Services Ltd. &#169; 2019 Richard Dymond.</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 8.0.</div>
<div><a href="../../asm/7596.html">Switch to hexadecimal</a>.</div>
</footer>
</body>
</html>