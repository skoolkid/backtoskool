<!DOCTYPE html>
<html>
<head>
<title>Back to Skool: Routine at 606C</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="Back to Skool" src="../images/logo-hex.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="6065.html">6065</a>
</td>
<td class="up">Up: <a href="../maps/all.html#606c">Map</a></td>
<td class="next">
Next: <a href="612E.html">612E</a>
</td>
</tr>
</table>
<div class="description">606C: Print a tile</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
Used by the routines at <a href="61C2.html">61C2</a>, <a href="61F8.html">61F8</a> and <a href="62A0.html">62A0</a>. Copies a tile of the play area into the back buffer at <a href="E170.html">E170</a>, superimposes character sprite tiles as appropriate, and then copies the resultant tile to the screen. Also sets the corresponding attribute byte.
</div>
<div class="paragraph">
The play area graphic data is laid out across pages 0x80 to 0xB5:
</div>
<div class="paragraph">
<table class="default">
<tr>
<th colspan="1" rowspan="1">Page(s)</th>
<th colspan="1" rowspan="1">Bytes</th>
<th colspan="1" rowspan="1">Contents</th>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">0x80-0x87</td>
<td class="centre" colspan="1" rowspan="1">0x00-0xFF</td>
<td class="" colspan="1" rowspan="1">Skool graphic data</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">0x88-0x8F</td>
<td class="centre" colspan="1" rowspan="1">0x00-0xFF</td>
<td class="" colspan="1" rowspan="1">Skool graphic data</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">0x90-0x97</td>
<td class="centre" colspan="1" rowspan="1">0x00-0xFF</td>
<td class="" colspan="1" rowspan="1">Skool graphic data (except bytes 0x01, 0x0B, 0x15, 0x1E)</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">0x98-0x9F</td>
<td class="centre" colspan="1" rowspan="1">0x00-0xF9</td>
<td class="" colspan="1" rowspan="1">Skool graphic data (except bytes 0xE0-0xEF)</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="3">0xA0-0xB4</td>
<td class="centre" colspan="1" rowspan="1">0x00-0x8F</td>
<td class="" colspan="1" rowspan="1">LSBs of tile base addresses</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">0x90-0xB3</td>
<td class="" colspan="1" rowspan="1">Tile MSB indicator bit-pairs (see below)</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">0xB4-0xFB</td>
<td class="" colspan="1" rowspan="1">Tile BRIGHT/PAPER attribute nibbles</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">0xB5</td>
<td class="centre" colspan="1" rowspan="1">0x00-0xBF</td>
<td class="" colspan="1" rowspan="1">Q (0x00&lt;=Q&lt;=0x8F; see below)</td>
</tr>
</table>
</div>
<div class="paragraph">
For the tile at skool coordinates (X,Y) (0&lt;=X&lt;=191, 0&lt;=Y&lt;=20), the column pointer Q (0x00&lt;=Q&lt;=0x8F) is collected from byte X of page <a href="B500.html">0xB5</a>. Then Q and Y together determine the location of the attribute byte, and where to look up the base address of the tile graphic data.
</div>
<div class="paragraph">
The BRIGHT/PAPER bits for row Y are arranged in a set of 144 nibbles in bytes 0xB4-0xFB of page Y+0xA0, from bits 7-4 of byte 0xB4 (nibble 0x00) to bits 3-0 of byte 0xFB (nibble 0x8F). Q is the index of the nibble that corresponds to the tile at (X,Y). In other words, the BRIGHT/PAPER bits for the skool location (X,Y) can be found in byte 0xB4+INT(Q/2) of page Y+0xA0: bits 4-7 if Q is even, bits 0-3 if Q is odd.
</div>
<div class="paragraph">
By default, the INK is 0 (black). However, if the BRIGHT/PAPER bits are all 0, this indicates a tile with non-black INK, of which there are normally four: the three shields in MR WACKER's study (which are red, blue, and red), and the top of the entrance to the girls' skool (which is blue). (However, when the left study door is open - which never happens in an unhacked game - there is a fifth tile with non-black INK: the top of the left study doorway, which is magenta.) When a tile has non-black INK, the BRIGHT/PAPER bits are taken from byte 0xB4+INT(Q/2) of page Y+0xA1 (i.e. the attribute byte corresponding to the skool location (X,Y+1)); then the INK is 2 (red) if Q is even, 1 (blue) if 4|Q-1, or 3 (magenta) if 4|Q-3.
</div>
<div class="paragraph">
So much for the attributes. The LSB of the base address of the tile graphic data is found in byte Q of page Y+0xA0. Information on which MSB (0x80, 0x88, 0x90 or 0x98) applies is arranged in a set of 144 bit-pairs in bytes 0x90-0xB3 of page Y+0xA0. Bit-pair 0x00 is bits 7 and 3 of byte 0x90; bit-pair 0x01 is bits 6 and 2; bit-pair 0x02 is bits 5 and 1; bit-pair 0x03 is bits 4 and 0; bit-pair 0x04 is bits 7 and 3 of byte 0x91; and so on up to bit-pair 0x8F, which is bits 4 and 0 of byte 0xB3. Q is the index of the bit-pair that corresponds to the tile at (X,Y). In other words, the tile MSB indicator for the skool location (X,Y) can be found in byte 0x90+INT(Q/4) of page Y+0xA0: bits 7 and 3 if 4|Q, 6 and 2 if 4|Q-1, 5 and 1 if 4|Q-2, 4 and 0 if 4|Q-3. The bit-pair forms a 2-digit binary number from 0 to 3; if we call this P, then the MSB is 0x80+8P.
</div>
<div class="paragraph">
To summarise, then, the attributes and graphic data for the tile at skool location (X,Y) can be found thus, where Q=PEEK(<a href="B500.html">B500</a>+X):
</div>
<div class="paragraph">
<table class="default">
<tr>
<th colspan="1" rowspan="1">Data</th>
<th colspan="1" rowspan="1">Look at...</th>
</tr>
<tr>
<td class="" colspan="1" rowspan="1">BRIGHT/PAPER</td>
<td class="" colspan="1" rowspan="1">Nibble Q of bytes 0xB4-0xFB in page Y+0xA0 (or Y+0xA1 if nibble Q in page Y+0xA0 is 0)</td>
</tr>
<tr>
<td class="" colspan="1" rowspan="1">INK</td>
<td class="" colspan="1" rowspan="1">0 if nibble Q in page Y+0xA0 is not 0; 1, 2 or 3 as explained above otherwise</td>
</tr>
<tr>
<td class="" colspan="1" rowspan="1">Tile LSB</td>
<td class="" colspan="1" rowspan="1">Byte Q in page Y+0xA0</td>
</tr>
<tr>
<td class="" colspan="1" rowspan="1">Tile MSB</td>
<td class="" colspan="1" rowspan="1">Bit-pair Q of bytes 0x90-0xB3 in page Y+0xA0</td>
</tr>
</table>
</div>
</div>
<table class="input">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">H</td>
<td class="register-desc">Screen row number (0-20)</td>
</tr>
<tr>
<td class="register">L</td>
<td class="register-desc">Screen column number (0-31)</td>
</tr>
</table>
</td>
</tr>
<tr>
<td class="address-2"><span id="606c"></span>606C</td>
<td class="instruction">PUSH HL</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-1"><span id="606d"></span>606D</td>
<td class="instruction">LD A,H</td>
<td class="comment-1" rowspan="17">Compute the appropriate attribute file address in <span class="register">BC</span> and the appropriate display file address in <span class="register">DE</span></td>
</tr>
<tr>
<td class="address-1"><span id="606e"></span>606E</td>
<td class="instruction">AND $18</td>
</tr>
<tr>
<td class="address-1"><span id="6070"></span>6070</td>
<td class="instruction">LD D,A</td>
</tr>
<tr>
<td class="address-1"><span id="6071"></span>6071</td>
<td class="instruction">LD A,H</td>
</tr>
<tr>
<td class="address-1"><span id="6072"></span>6072</td>
<td class="instruction">RRCA</td>
</tr>
<tr>
<td class="address-1"><span id="6073"></span>6073</td>
<td class="instruction">RRCA</td>
</tr>
<tr>
<td class="address-1"><span id="6074"></span>6074</td>
<td class="instruction">RRCA</td>
</tr>
<tr>
<td class="address-1"><span id="6075"></span>6075</td>
<td class="instruction">LD H,A</td>
</tr>
<tr>
<td class="address-1"><span id="6076"></span>6076</td>
<td class="instruction">AND $E0</td>
</tr>
<tr>
<td class="address-1"><span id="6078"></span>6078</td>
<td class="instruction">ADD A,L</td>
</tr>
<tr>
<td class="address-1"><span id="6079"></span>6079</td>
<td class="instruction">LD E,A</td>
</tr>
<tr>
<td class="address-1"><span id="607a"></span>607A</td>
<td class="instruction">LD C,A</td>
</tr>
<tr>
<td class="address-1"><span id="607b"></span>607B</td>
<td class="instruction">LD A,H</td>
</tr>
<tr>
<td class="address-1"><span id="607c"></span>607C</td>
<td class="instruction">AND $03</td>
</tr>
<tr>
<td class="address-1"><span id="607e"></span>607E</td>
<td class="instruction">ADD A,$58</td>
</tr>
<tr>
<td class="address-1"><span id="6080"></span>6080</td>
<td class="instruction">LD B,A</td>
</tr>
<tr>
<td class="address-1"><span id="6081"></span>6081</td>
<td class="instruction">SET 6,D</td>
</tr>
<tr>
<td class="address-1"><span id="6083"></span>6083</td>
<td class="instruction">EX DE,HL</td>
<td class="comment-1" rowspan="2">Place the display file address on the stack and get (row,col) back in <span class="register">HL</span></td>
</tr>
<tr>
<td class="address-1"><span id="6084"></span>6084</td>
<td class="instruction">EX (SP),HL</td>
</tr>
<tr>
<td class="address-1"><span id="6085"></span>6085</td>
<td class="instruction">LD A,($7FFF)</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=leftmost column of the play area on screen (0-160)</td>
</tr>
<tr>
<td class="address-1"><span id="6088"></span>6088</td>
<td class="instruction">ADD A,L</td>
<td class="comment-1" rowspan="2"><span class="register">L</span>=X: column of the play area corresponding to the character square under consideration (0-191)</td>
</tr>
<tr>
<td class="address-1"><span id="6089"></span>6089</td>
<td class="instruction">LD L,A</td>
</tr>
<tr>
<td class="address-1"><span id="608a"></span>608A</td>
<td class="instruction">PUSH HL</td>
<td class="comment-1" rowspan="1">Push the skool coordinates (X,Y) onto the stack</td>
</tr>
<tr>
<td class="address-1"><span id="608b"></span>608B</td>
<td class="instruction">LD A,H</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=Y (0-20)</td>
</tr>
<tr>
<td class="address-1"><span id="608c"></span>608C</td>
<td class="instruction">LD H,$B5</td>
<td class="comment-1" rowspan="1"><span class="register">HL</span>=<a href="B500.html">B500</a>+X</td>
</tr>
<tr>
<td class="address-1"><span id="608e"></span>608E</td>
<td class="instruction">LD L,(HL)</td>
<td class="comment-1" rowspan="1"><span class="register">L</span>=Q (0x00&lt;=Q&lt;=0x8F)</td>
</tr>
<tr>
<td class="address-1"><span id="608f"></span>608F</td>
<td class="instruction">ADD A,$A0</td>
<td class="comment-1" rowspan="2"><span class="register">H</span>=Y+0xA0</td>
</tr>
<tr>
<td class="address-1"><span id="6091"></span>6091</td>
<td class="instruction">LD H,A</td>
</tr>
<tr>
<td class="address-1"><span id="6092"></span>6092</td>
<td class="instruction">LD E,L</td>
<td class="comment-1" rowspan="1"><span class="register">E</span>=Q (0x00&lt;=Q&lt;=0x8F)</td>
</tr>
<tr>
<td class="address-1"><span id="6093"></span>6093</td>
<td class="instruction">LD A,L</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=Q</td>
</tr>
<tr>
<td class="address-1"><span id="6094"></span>6094</td>
<td class="instruction">RRA</td>
<td class="comment-1" rowspan="1">Is Q odd?</td>
</tr>
<tr>
<td class="address-1"><span id="6095"></span>6095</td>
<td class="instruction">JR C,$60B2</td>
<td class="comment-1" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="6097"></span>
<div class="comments">
<div class="paragraph">
Q (the contents of (<a href="B500.html">B500</a>+X)) is even, which means the PAPER colour and BRIGHT status can be found in bits 4-7 of byte 0xB4+Q/2 in page Y+0xA0. At this point <span class="register">A</span>=Q/2.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="6097"></span>6097</td>
<td class="instruction">ADD A,$B4</td>
<td class="comment-1" rowspan="1">0xB4&lt;=<span class="register">A</span>&lt;=0xFB</td>
</tr>
<tr>
<td class="address-1"><span id="6099"></span>6099</td>
<td class="instruction">LD L,A</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at the attribute byte</td>
</tr>
<tr>
<td class="address-1"><span id="609a"></span>609A</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1">Pick up the attribute byte in <span class="register">A</span></td>
</tr>
<tr>
<td class="address-1"><span id="609b"></span>609B</td>
<td class="instruction">AND $F0</td>
<td class="comment-1" rowspan="1">The PAPER colour and BRIGHT status are in bits 4-7</td>
</tr>
<tr>
<td class="address-1"><span id="609d"></span>609D</td>
<td class="instruction">RR A</td>
<td class="comment-1" rowspan="1">Shift them into bits 3-6</td>
</tr>
<tr>
<td class="address-1"><span id="609f"></span>609F</td>
<td class="instruction">JR NZ,$60C6</td>
<td class="comment-1" rowspan="1">Jump if this character square has INK 0</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="60a1"></span>
<div class="comments">
<div class="paragraph">
We are dealing with one of the few character squares with non-black INK. In this case the PAPER colour and BRIGHT status can be found in bits 4-7 (since Q is even) of byte 0xB4+Q/2 in page Y+0xA1.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="60a1"></span>60A1</td>
<td class="instruction">INC H</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at the attribute byte in page Y+0xA1</td>
</tr>
<tr>
<td class="address-1"><span id="60a2"></span>60A2</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1">Pick up the attribute byte in <span class="register">A</span></td>
</tr>
<tr>
<td class="address-1"><span id="60a3"></span>60A3</td>
<td class="instruction">AND $F0</td>
<td class="comment-1" rowspan="1">The PAPER colour and BRIGHT status are in bits 4-7</td>
</tr>
<tr>
<td class="address-1"><span id="60a5"></span>60A5</td>
<td class="instruction">RRA</td>
<td class="comment-1" rowspan="1">Shift them into bits 3-6</td>
</tr>
<tr>
<td class="address-2"><span id="60a6"></span>60A6</td>
<td class="instruction">LD L,A</td>
<td class="comment-1" rowspan="1"><span class="register">L</span> holds the PAPER colour and BRIGHT status</td>
</tr>
<tr>
<td class="address-1"><span id="60a7"></span>60A7</td>
<td class="instruction">LD A,E</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=Q (0x00&lt;=Q&lt;=0x8F)</td>
</tr>
<tr>
<td class="address-1"><span id="60a8"></span>60A8</td>
<td class="instruction">AND $03</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=0, 1, 2 or 3</td>
</tr>
<tr>
<td class="address-1"><span id="60aa"></span>60AA</td>
<td class="instruction">JR NZ,$60AE</td>
<td class="comment-1" rowspan="1">Jump if the INK is blue, red, or magenta</td>
</tr>
<tr>
<td class="address-1"><span id="60ac"></span>60AC</td>
<td class="instruction">ADD A,$02</td>
<td class="comment-1" rowspan="1">A=2: INK 2 (red)</td>
</tr>
<tr>
<td class="address-2"><span id="60ae"></span>60AE</td>
<td class="instruction">OR L</td>
<td class="comment-1" rowspan="1">OR on the PAPER colour and BRIGHT status</td>
</tr>
<tr>
<td class="address-1"><span id="60af"></span>60AF</td>
<td class="instruction">DEC H</td>
<td class="comment-1" rowspan="1"><span class="register">H</span>=Y+0xA0</td>
</tr>
<tr>
<td class="address-1"><span id="60b0"></span>60B0</td>
<td class="instruction">JR $60C6</td>
<td class="comment-1" rowspan="1">Jump forward to transfer the attribute byte in <span class="register">A</span> onto the screen</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="60b2"></span>
<div class="comments">
<div class="paragraph">
Q (the contents of (<a href="B500.html">B500</a>+X)) is odd, which means the PAPER colour and BRIGHT status can be found in bits 0-3 of byte 0xB4+(Q-1)/2 in page Y+0xA0. At this point <span class="register">A</span>=(Q-1)/2.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="60b2"></span>60B2</td>
<td class="instruction">ADD A,$B4</td>
<td class="comment-1" rowspan="1">0xB4&lt;=<span class="register">A</span>&lt;=0xFB</td>
</tr>
<tr>
<td class="address-1"><span id="60b4"></span>60B4</td>
<td class="instruction">LD L,A</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at the attribute byte</td>
</tr>
<tr>
<td class="address-1"><span id="60b5"></span>60B5</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1">Pick up the attribute byte in <span class="register">A</span></td>
</tr>
<tr>
<td class="address-1"><span id="60b6"></span>60B6</td>
<td class="instruction">AND $0F</td>
<td class="comment-1" rowspan="1">The PAPER colour and BRIGHT status are in bits 0-3</td>
</tr>
<tr>
<td class="address-1"><span id="60b8"></span>60B8</td>
<td class="instruction">JR NZ,$60C3</td>
<td class="comment-1" rowspan="1">Jump if this character square has INK 0</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="60ba"></span>
<div class="comments">
<div class="paragraph">
We are dealing with one of the few character squares with non-black INK. In this case the PAPER colour and BRIGHT status can be found in bits 0-3 (since Q is odd) of byte 0xB4+(Q-1)/2 in page Y+0xA1.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="60ba"></span>60BA</td>
<td class="instruction">INC H</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at the attribute byte in page Y+0xA1</td>
</tr>
<tr>
<td class="address-1"><span id="60bb"></span>60BB</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1">Pick up the attribute byte in <span class="register">A</span></td>
</tr>
<tr>
<td class="address-1"><span id="60bc"></span>60BC</td>
<td class="instruction">AND $0F</td>
<td class="comment-1" rowspan="1">The PAPER colour and BRIGHT status are in bits 0-3</td>
</tr>
<tr>
<td class="address-1"><span id="60be"></span>60BE</td>
<td class="instruction">ADD A,A</td>
<td class="comment-1" rowspan="3">Shift the PAPER and BRIGHT bits from bits 0-3 to bits 3-6</td>
</tr>
<tr>
<td class="address-1"><span id="60bf"></span>60BF</td>
<td class="instruction">ADD A,A</td>
</tr>
<tr>
<td class="address-1"><span id="60c0"></span>60C0</td>
<td class="instruction">ADD A,A</td>
</tr>
<tr>
<td class="address-1"><span id="60c1"></span>60C1</td>
<td class="instruction">JR $60A6</td>
<td class="comment-1" rowspan="1">Jump back to fill in the INK bits</td>
</tr>
<tr>
<td class="address-2"><span id="60c3"></span>60C3</td>
<td class="instruction">ADD A,A</td>
<td class="comment-1" rowspan="3">Shift the PAPER and BRIGHT bits from bits 0-3 to bits 3-6, and set the INK to 0</td>
</tr>
<tr>
<td class="address-1"><span id="60c4"></span>60C4</td>
<td class="instruction">ADD A,A</td>
</tr>
<tr>
<td class="address-1"><span id="60c5"></span>60C5</td>
<td class="instruction">ADD A,A</td>
</tr>
<tr>
<td class="address-2"><span id="60c6"></span>60C6</td>
<td class="instruction">NOP</td>
<td class="comment-1" rowspan="1">Do nothing (during the startup sequence), or poke the attribute byte onto the screen (this instruction is set to LD (BC),A before the game starts; see <a href="53A0.html">53A0</a>)</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="60c7"></span>
<div class="comments">
<div class="paragraph">
The appropriate attribute byte has been poked onto the screen. Now to find the appropriate tile graphic data.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="60c7"></span>60C7</td>
<td class="instruction">LD L,E</td>
<td class="comment-1" rowspan="1"><span class="register">L</span>=Q (0x00&lt;=Q&lt;=0x8F), <span class="register">H</span>=Y+0xA0</td>
</tr>
<tr>
<td class="address-1"><span id="60c8"></span>60C8</td>
<td class="instruction">LD E,(HL)</td>
<td class="comment-1" rowspan="1"><span class="register">E</span>=LSB of the base address of the tile graphic data</td>
</tr>
<tr>
<td class="address-1"><span id="60c9"></span>60C9</td>
<td class="instruction">LD A,$88</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=10001000</td>
</tr>
<tr>
<td class="address-1"><span id="60cb"></span>60CB</td>
<td class="instruction">SRL L</td>
<td class="comment-1" rowspan="7">Shift <span class="register">A</span> right (Q AND 3) times</td>
</tr>
<tr>
<td class="address-1"><span id="60cd"></span>60CD</td>
<td class="instruction">JR NC,$60D0</td>
</tr>
<tr>
<td class="address-1"><span id="60cf"></span>60CF</td>
<td class="instruction">RRCA</td>
</tr>
<tr>
<td class="address-2"><span id="60d0"></span>60D0</td>
<td class="instruction">SRL L</td>
</tr>
<tr>
<td class="address-1"><span id="60d2"></span>60D2</td>
<td class="instruction">JR NC,$60D6</td>
</tr>
<tr>
<td class="address-1"><span id="60d4"></span>60D4</td>
<td class="instruction">RRCA</td>
</tr>
<tr>
<td class="address-1"><span id="60d5"></span>60D5</td>
<td class="instruction">RRCA</td>
</tr>
<tr>
<td class="address-2"><span id="60d6"></span>60D6</td>
<td class="instruction">LD C,A</td>
<td class="comment-1" rowspan="1"><span class="register">C</span>=10001000, 01000100, 00100010 or 00010001</td>
</tr>
<tr>
<td class="address-1"><span id="60d7"></span>60D7</td>
<td class="instruction">LD A,L</td>
<td class="comment-1" rowspan="3">Point <span class="register">HL</span> at the byte containing the MSB indicator bit-pair: <span class="register">H</span>=Y+0xA0, 0x90&lt;=<span class="register">L</span>=0x90+INT(Q/4)&lt;=0xB3</td>
</tr>
<tr>
<td class="address-1"><span id="60d8"></span>60D8</td>
<td class="instruction">ADD A,$90</td>
</tr>
<tr>
<td class="address-1"><span id="60da"></span>60DA</td>
<td class="instruction">LD L,A</td>
</tr>
<tr>
<td class="address-1"><span id="60db"></span>60DB</td>
<td class="instruction">LD A,C</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=10001000, 01000100, 00100010 or 00010001</td>
</tr>
<tr>
<td class="address-1"><span id="60dc"></span>60DC</td>
<td class="instruction">AND (HL)</td>
<td class="comment-1" rowspan="1">Keep only the bits of the bit-pair</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="60dd"></span>
<div class="comments">
<div class="paragraph">
The base page of the tile graphic data depends on the bits set in <span class="register">A</span>.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="60dd"></span>60DD</td>
<td class="instruction">LD D,$80</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-1"><span id="60df"></span>60DF</td>
<td class="instruction">CP $10</td>
<td class="comment-1" rowspan="1">Are any of bits 4-7 in <span class="register">A</span> set?</td>
</tr>
<tr>
<td class="address-1"><span id="60e1"></span>60E1</td>
<td class="instruction">JR C,$60E5</td>
<td class="comment-1" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="address-1"><span id="60e3"></span>60E3</td>
<td class="instruction">LD D,$90</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-2"><span id="60e5"></span>60E5</td>
<td class="instruction">AND $0F</td>
<td class="comment-1" rowspan="1">Are any of bits 0-3 in <span class="register">A</span> set?</td>
</tr>
<tr>
<td class="address-1"><span id="60e7"></span>60E7</td>
<td class="instruction">JR Z,$60EB</td>
<td class="comment-1" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="address-1"><span id="60e9"></span>60E9</td>
<td class="instruction">SET 3,D</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="60eb"></span>
<div class="comments">
<div class="paragraph">
Now <span class="register">D</span>=0x80, 0x88, 0x90 or 0x98, and <span class="register">DE</span> points at the first byte of the graphic data for the tile at skool coordinates (X,Y).
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="60eb"></span>60EB</td>
<td class="instruction">LD HL,$E170</td>
<td class="comment-1" rowspan="2">We're going to copy the tile into the 8-byte back buffer at <a href="E170.html">E170</a></td>
</tr>
<tr>
<td class="address-1"><span id="60ee"></span>60EE</td>
<td class="instruction">LD B,$08</td>
</tr>
<tr>
<td class="address-2"><span id="60f0"></span>60F0</td>
<td class="instruction">XOR A</td>
<td class="comment-1" rowspan="1">Use a blank graphic byte (during startup), or collect the tile graphic byte (this instruction is set to LD A,(DE) before the game starts; see <a href="53A0.html">53A0</a>)</td>
</tr>
<tr>
<td class="address-1"><span id="60f1"></span>60F1</td>
<td class="instruction">INC D</td>
<td class="comment-1" rowspan="1">Point <span class="register">DE</span> at the next graphic byte</td>
</tr>
<tr>
<td class="address-1"><span id="60f2"></span>60F2</td>
<td class="instruction">LD (HL),A</td>
<td class="comment-1" rowspan="1">Copy the graphic byte into the back buffer</td>
</tr>
<tr>
<td class="address-1"><span id="60f3"></span>60F3</td>
<td class="instruction">INC L</td>
<td class="comment-1" rowspan="1">Move to the next slot in the back buffer</td>
</tr>
<tr>
<td class="address-1"><span id="60f4"></span>60F4</td>
<td class="instruction">DJNZ $60F0</td>
<td class="comment-1" rowspan="1">Jump back until the entire tile has been copied</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="60f6"></span>
<div class="comments">
<div class="paragraph">
The appropriate play area tile has been copied into the back buffer at <a href="E170.html">E170</a>. Now it's time to superimpose game character sprite tiles (if any).
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="60f6"></span>60F6</td>
<td class="instruction">LD H,$B7</td>
<td class="comment-1" rowspan="1">0xB7=character number of little girl no. 1</td>
</tr>
<tr>
<td class="address-1"><span id="60f8"></span>60F8</td>
<td class="instruction">POP DE</td>
<td class="comment-1" rowspan="1"><span class="register">D</span>=Y (0-20), <span class="register">E</span>=X (0-191)</td>
</tr>
<tr>
<td class="address-1"><span id="60f9"></span>60F9</td>
<td class="instruction">LD A,($7FFF)</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=leftmost column of the play area on screen (0-160)</td>
</tr>
<tr>
<td class="address-1"><span id="60fc"></span>60FC</td>
<td class="instruction">CP $78</td>
<td class="comment-1" rowspan="1">This x-coordinate is roughly halfway between the tree and the gate</td>
</tr>
<tr>
<td class="address-1"><span id="60fe"></span>60FE</td>
<td class="instruction">JR C,$610B</td>
<td class="comment-1" rowspan="1">Jump if columns 144 onwards (girls' skool + half the girls' playground) are off-screen</td>
</tr>
<tr>
<td class="address-1"><span id="6100"></span>6100</td>
<td class="instruction">LD B,$07</td>
<td class="comment-1" rowspan="1">7 little girls</td>
</tr>
<tr>
<td class="address-1"><span id="6102"></span>6102</td>
<td class="instruction">CALL <a href="6000.html">$6000</a></td>
<td class="comment-1" rowspan="1">Superimpose graphic bytes for the little girls if necessary</td>
</tr>
<tr>
<td class="address-1"><span id="6105"></span>6105</td>
<td class="instruction">LD H,$C6</td>
<td class="comment-1" rowspan="1">0xC6=character number of little boy no. 9</td>
</tr>
<tr>
<td class="address-1"><span id="6107"></span>6107</td>
<td class="instruction">LD B,$11</td>
<td class="comment-1" rowspan="1">2 little boys, 11 main characters, plus the objects using character buffers 0xD3-0xD6</td>
</tr>
<tr>
<td class="address-1"><span id="6109"></span>6109</td>
<td class="instruction">JR $611E</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-2"><span id="610b"></span>610B</td>
<td class="instruction">CP $50</td>
<td class="comment-1" rowspan="1">This is the x-coordinate of the assembly hall stage (or thereabouts)</td>
</tr>
<tr>
<td class="address-1"><span id="610d"></span>610D</td>
<td class="instruction">JR C,$611A</td>
<td class="comment-1" rowspan="1">Jump if columns 104 onwards (everything to the right of the tree, roughly) are off-screen</td>
</tr>
<tr>
<td class="address-1"><span id="610f"></span>610F</td>
<td class="instruction">LD B,$03</td>
<td class="comment-1" rowspan="1">3 little girls (0xB7-0xB9)</td>
</tr>
<tr>
<td class="address-1"><span id="6111"></span>6111</td>
<td class="instruction">CALL <a href="6000.html">$6000</a></td>
<td class="comment-1" rowspan="1">Superimpose graphic bytes for these little girls if necessary</td>
</tr>
<tr>
<td class="address-1"><span id="6114"></span>6114</td>
<td class="instruction">LD H,$C1</td>
<td class="comment-1" rowspan="1">0xC1=character number of little boy no. 4</td>
</tr>
<tr>
<td class="address-1"><span id="6116"></span>6116</td>
<td class="instruction">LD B,$16</td>
<td class="comment-1" rowspan="1">7 little boys, 11 main characters, plus the objects using character buffers 0xD3-0xD6</td>
</tr>
<tr>
<td class="address-1"><span id="6118"></span>6118</td>
<td class="instruction">JR $611E</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-2"><span id="611a"></span>611A</td>
<td class="instruction">LD H,$BE</td>
<td class="comment-1" rowspan="1">0xBE=character number of little boy no. 1</td>
</tr>
<tr>
<td class="address-1"><span id="611c"></span>611C</td>
<td class="instruction">LD B,$19</td>
<td class="comment-1" rowspan="1">All 10 little boys, 11 main characters, plus the objects using character buffers 0xD3-0xD6</td>
</tr>
<tr>
<td class="address-2"><span id="611e"></span>611E</td>
<td class="instruction">CALL <a href="6000.html">$6000</a></td>
<td class="comment-1" rowspan="1">Superimpose graphic bytes for these characters if necessary</td>
</tr>
<tr>
<td class="address-1"><span id="6121"></span>6121</td>
<td class="instruction">LD HL,$E170</td>
<td class="comment-1" rowspan="1">The 8-byte back buffer at <a href="E170.html">E170</a> now contains the tile to be copied to the screen</td>
</tr>
<tr>
<td class="address-1"><span id="6124"></span>6124</td>
<td class="instruction">POP DE</td>
<td class="comment-1" rowspan="1">Retrieve the appropriate display file address in <span class="register">DE</span></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="6125"></span>
<div class="comments">
<div class="paragraph">
This entry point is used by the routine at <a href="693D.html">693D</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="6125"></span>6125</td>
<td class="instruction">LD B,$08</td>
<td class="comment-1" rowspan="1">There are 8 bytes per character square</td>
</tr>
<tr>
<td class="address-2"><span id="6127"></span>6127</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="5">Transfer the graphic bytes to the screen</td>
</tr>
<tr>
<td class="address-1"><span id="6128"></span>6128</td>
<td class="instruction">LD (DE),A</td>
</tr>
<tr>
<td class="address-1"><span id="6129"></span>6129</td>
<td class="instruction">INC L</td>
</tr>
<tr>
<td class="address-1"><span id="612a"></span>612A</td>
<td class="instruction">INC D</td>
</tr>
<tr>
<td class="address-1"><span id="612b"></span>612B</td>
<td class="instruction">DJNZ $6127</td>
</tr>
<tr>
<td class="address-1"><span id="612d"></span>612D</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1"></td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="6065.html">6065</a>
</td>
<td class="up">Up: <a href="../maps/all.html#606c">Map</a></td>
<td class="next">
Next: <a href="612E.html">612E</a>
</td>
</tr>
</table>
<footer>
<div class="release">The complete Back to Skool RAM disassembly 20200811</div>
<div class="copyright">&#169; 1985 Microsphere Computer Services Ltd. &#169; 2020 Richard Dymond.</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 8.2.</div>
<div><a href="../dec/asm/24684.html">Switch to decimal</a>.</div>
</footer>
</body>
</html>