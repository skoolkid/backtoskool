<!DOCTYPE html>
<html>
<head>
<title>Back to Skool: Routine at 6A8C</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../style.css" />

</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="Back to Skool" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a href="6A88.html">6A88</a></span></td>
<td class="up">Up: <a href="../maps/all.html#6a8c">Map</a></td>
<td class="next"><span class="next-1">Next: <a href="6AE3.html">6AE3</a></span></td>
</tr>
</table>
<div class="description">6A8C: Save the area of the screen that will be overwritten by a message box</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="4">
<div class="details">
<div class="paragraph">
Used by the routines at <a href="7414.html">7414</a>, <a href="74C8.html">74C8</a> and <a href="F4CC.html">F4CC</a>. Returns with the carry flag set if the message box would be off-screen. Otherwise copies the area of the screen that will be overwritten by the message box into the buffer at <a href="E328.html">E328</a>, and returns with the attribute file address for the top-left corner of the message box in <span class="register">DE</span>.
</div>
</div>
<table class="input-1">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">DE</td>
<td class="register-desc">Coordinates of the point above the character's head</td>
</tr>
</table>
<table class="output-0">
<tr class="asm-output-header">
<th colspan="2">Output</th>
</tr>

</table>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="6a8c"></span>6A8C</td>
<td class="instruction">LD A,($7FFF)</td>
<td class="comment-11" rowspan="2"><span class="register">B</span>=leftmost column of the play area on screen</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6a8f"></span>6A8F</td>
<td class="instruction">LD B,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6a90"></span>6A90</td>
<td class="instruction">LD A,E</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=x-coordinate of the character's head</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6a91"></span>6A91</td>
<td class="instruction">AND $F8</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=x-coordinate of the left edge of the message box</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6a93"></span>6A93</td>
<td class="instruction">SUB B</td>
<td class="comment-11" rowspan="4">Return with the carry flag set if the message box would be off-screen to the right</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6a94"></span>6A94</td>
<td class="instruction">CP $20</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6a96"></span>6A96</td>
<td class="instruction">CCF</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6a97"></span>6A97</td>
<td class="instruction">RET C</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6a98"></span>6A98</td>
<td class="instruction">LD E,A</td>
<td class="comment-11" rowspan="1"><span class="register">E</span>=0, 8, 16 or 24: screen x-coordinate of the left edge of the message box</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6a99"></span>6A99</td>
<td class="instruction">LD A,D</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=y-coordinate of the point above the character's head</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6a9a"></span>6A9A</td>
<td class="instruction">SUB $03</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=y-coordinate of the top line of the message box</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6a9c"></span>6A9C</td>
<td class="instruction">RET C</td>
<td class="comment-11" rowspan="1">Return with the carry flag set if this would be off the top of the screen</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="6a9d"></span>
<div class="comments">
<div class="paragraph">
The message box is going to be printed. Prepare for that by saving the area of the screen that will be overwritten.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6a9d"></span>6A9D</td>
<td class="instruction">LD D,$00</td>
<td class="comment-11" rowspan="1"><span class="register">DE</span>=0, 8, 16 or 24</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6a9f"></span>6A9F</td>
<td class="instruction">PUSH HL</td>
<td class="comment-11" rowspan="1">Save <span class="register">HL</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6aa0"></span>6AA0</td>
<td class="instruction">ADD A,A</td>
<td class="comment-11" rowspan="8">Set <span class="register">HL</span> the to the attribute file address for the top left corner of the message box</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6aa1"></span>6AA1</td>
<td class="instruction">ADD A,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6aa2"></span>6AA2</td>
<td class="instruction">ADD A,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6aa3"></span>6AA3</td>
<td class="instruction">LD L,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6aa4"></span>6AA4</td>
<td class="instruction">LD H,$16</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6aa6"></span>6AA6</td>
<td class="instruction">ADD HL,HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6aa7"></span>6AA7</td>
<td class="instruction">ADD HL,HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6aa8"></span>6AA8</td>
<td class="instruction">ADD HL,DE</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6aa9"></span>6AA9</td>
<td class="instruction">PUSH HL</td>
<td class="comment-11" rowspan="1">Save this base attribute file address</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6aaa"></span>6AAA</td>
<td class="instruction">LD DE,$E328</td>
<td class="comment-11" rowspan="1">Point <span class="register">DE</span> at the buffer used to save the screen area overwritten by the message box (at <a href="E328.html">E328</a>)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6aad"></span>6AAD</td>
<td class="instruction">LD A,$03</td>
<td class="comment-11" rowspan="7">Copy three rows of eight attribute bytes each from the screen into the first 24 bytes of the buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="6aaf"></span>6AAF</td>
<td class="instruction">LD BC,$0008</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6ab2"></span>6AB2</td>
<td class="instruction">LDIR</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6ab4"></span>6AB4</td>
<td class="instruction">LD C,$18</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6ab6"></span>6AB6</td>
<td class="instruction">ADD HL,BC</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6ab7"></span>6AB7</td>
<td class="instruction">DEC A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6ab8"></span>6AB8</td>
<td class="instruction">JR NZ,$6AAF</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6aba"></span>6ABA</td>
<td class="instruction">POP HL</td>
<td class="comment-11" rowspan="1">Restore the base attribute file address to <span class="register">HL</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6abb"></span>6ABB</td>
<td class="instruction">PUSH HL</td>
<td class="comment-11" rowspan="1">And save it again</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6abc"></span>6ABC</td>
<td class="instruction">LD A,H</td>
<td class="comment-11" rowspan="6">Set <span class="register">HL</span> to the display file address for the top left corner of the message box</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6abd"></span>6ABD</td>
<td class="instruction">SUB $50</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6abf"></span>6ABF</td>
<td class="instruction">ADD A,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6ac0"></span>6AC0</td>
<td class="instruction">ADD A,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6ac1"></span>6AC1</td>
<td class="instruction">ADD A,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6ac2"></span>6AC2</td>
<td class="instruction">LD H,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6ac3"></span>6AC3</td>
<td class="instruction">LD C,$03</td>
<td class="comment-11" rowspan="1">There are 3 rows of UDGs to copy</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="6ac5"></span>6AC5</td>
<td class="instruction">LD A,$08</td>
<td class="comment-11" rowspan="1">8 pixel rows per UDG</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6ac7"></span>6AC7</td>
<td class="instruction">PUSH BC</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="6ac8"></span>6AC8</td>
<td class="instruction">PUSH HL</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6ac9"></span>6AC9</td>
<td class="instruction">LD C,$08</td>
<td class="comment-11" rowspan="1">8 UDGs per row</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6acb"></span>6ACB</td>
<td class="instruction">LDIR</td>
<td class="comment-11" rowspan="1">Copy one row of pixels into the buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6acd"></span>6ACD</td>
<td class="instruction">POP HL</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6ace"></span>6ACE</td>
<td class="instruction">INC H</td>
<td class="comment-11" rowspan="1">Move <span class="register">HL</span> to the next row of pixels on screen</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6acf"></span>6ACF</td>
<td class="instruction">DEC A</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6ad0"></span>6AD0</td>
<td class="instruction">JR NZ,$6AC8</td>
<td class="comment-11" rowspan="1">Jump back until all 8 pixel rows for this row of UDGs have been copied into the buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6ad2"></span>6AD2</td>
<td class="instruction">LD A,L</td>
<td class="comment-11" rowspan="7">Move <span class="register">HL</span> to the display file address for the start of the top row of pixels for the next row of UDGs</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6ad3"></span>6AD3</td>
<td class="instruction">ADD A,$20</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6ad5"></span>6AD5</td>
<td class="instruction">LD L,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6ad6"></span>6AD6</td>
<td class="instruction">JR C,$6ADC</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6ad8"></span>6AD8</td>
<td class="instruction">LD A,H</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6ad9"></span>6AD9</td>
<td class="instruction">SUB $08</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6adb"></span>6ADB</td>
<td class="instruction">LD H,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="6adc"></span>6ADC</td>
<td class="instruction">POP BC</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6add"></span>6ADD</td>
<td class="instruction">DEC C</td>
<td class="comment-11" rowspan="1">One more row of UDGs copied</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6ade"></span>6ADE</td>
<td class="instruction">JR NZ,$6AC5</td>
<td class="comment-11" rowspan="1">Jump back until all 3 rows have been done</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6ae0"></span>6AE0</td>
<td class="instruction">POP DE</td>
<td class="comment-11" rowspan="1">Drop the base attribute file address into <span class="register">DE</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6ae1"></span>6AE1</td>
<td class="instruction">POP HL</td>
<td class="comment-11" rowspan="1">Restore the original contents of <span class="register">HL</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6ae2"></span>6AE2</td>
<td class="instruction">RET</td>
<td class="comment-11" rowspan="1">Return with the carry flag reset</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a href="6A88.html">6A88</a></span></td>
<td class="up">Up: <a href="../maps/all.html#6a8c">Map</a></td>
<td class="next"><span class="next-1">Next: <a href="6AE3.html">6AE3</a></span></td>
</tr>
</table>
<footer>
<div class="release">The complete Back to Skool RAM disassembly 20151012</div>
<div class="copyright">&#169; 1985 Microsphere Computer Services Ltd (Back to Skool). &#169; 2015 Richard Dymond (this disassembly).</div>
<div class="created">Created using <a href="http://skoolkit.ca/">SkoolKit</a> 5.1.</div>
</footer>
</body>
</html>