<!DOCTYPE html>
<html>
<head>
<title>Back to Skool: Routine at 62A0</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="Back to Skool" src="../images/logo-hex.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="6291.html">6291</a>
</td>
<td class="up">Up: <a href="../maps/all.html#62a0">Map</a></td>
<td class="next">
Next: <a href="62D0.html">62D0</a>
</td>
</tr>
</table>
<div class="description">62A0: Update the display</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
Used by the routines at <a href="51DC.html">51DC</a>, <a href="6E00.html">6E00</a>, <a href="F28E.html">F28E</a> and <a href="F6EA.html">F6EA</a>. Goes through the <a href="7F00.html">screen refresh buffer</a> (SRB) and for every set bit found, updates the corresponding character square on-screen.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="62a0"></span>62A0</td>
<td class="instruction">CALL <a href="68E1.html">$68E1</a></td>
<td class="comment-1" rowspan="1">Update the SRB so that speech bubbles are not corrupted by moving characters</td>
</tr>
<tr>
<td class="address-1"><span id="62a3"></span>62A3</td>
<td class="instruction">LD B,$54</td>
<td class="comment-1" rowspan="1">21 screen rows, 4 bytes (32 bits) per row</td>
</tr>
<tr>
<td class="address-2"><span id="62a5"></span>62A5</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1">Pick up a byte from the screen refresh buffer</td>
</tr>
<tr>
<td class="address-1"><span id="62a6"></span>62A6</td>
<td class="instruction">AND A</td>
<td class="comment-1" rowspan="1">Anything need updating in this particular 8-tile segment?</td>
</tr>
<tr>
<td class="address-1"><span id="62a7"></span>62A7</td>
<td class="instruction">JR Z,$62CC</td>
<td class="comment-1" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="address-1"><span id="62a9"></span>62A9</td>
<td class="instruction">PUSH BC</td>
<td class="comment-1" rowspan="1">Save the SRB byte counter</td>
</tr>
<tr>
<td class="address-1"><span id="62aa"></span>62AA</td>
<td class="instruction">LD A,L</td>
<td class="comment-1" rowspan="5">For this particular byte of the SRB, compute the corresponding screen row number (0-20) in <span class="register">D</span></td>
</tr>
<tr>
<td class="address-1"><span id="62ab"></span>62AB</td>
<td class="instruction">AND $FC</td>
</tr>
<tr>
<td class="address-1"><span id="62ad"></span>62AD</td>
<td class="instruction">RRCA</td>
</tr>
<tr>
<td class="address-1"><span id="62ae"></span>62AE</td>
<td class="instruction">RRCA</td>
</tr>
<tr>
<td class="address-1"><span id="62af"></span>62AF</td>
<td class="instruction">LD D,A</td>
</tr>
<tr>
<td class="address-1"><span id="62b0"></span>62B0</td>
<td class="instruction">LD A,L</td>
<td class="comment-1" rowspan="5">Also for this particular SRB byte, compute the column of the screen (0, 8, 16 or 24) corresponding to bit 7</td>
</tr>
<tr>
<td class="address-1"><span id="62b1"></span>62B1</td>
<td class="instruction">AND $03</td>
</tr>
<tr>
<td class="address-1"><span id="62b3"></span>62B3</td>
<td class="instruction">ADD A,A</td>
</tr>
<tr>
<td class="address-1"><span id="62b4"></span>62B4</td>
<td class="instruction">ADD A,A</td>
</tr>
<tr>
<td class="address-1"><span id="62b5"></span>62B5</td>
<td class="instruction">ADD A,A</td>
</tr>
<tr>
<td class="address-1"><span id="62b6"></span>62B6</td>
<td class="instruction">DEC A</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-1"><span id="62b7"></span>62B7</td>
<td class="instruction">LD E,A</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-2"><span id="62b8"></span>62B8</td>
<td class="instruction">INC E</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-1"><span id="62b9"></span>62B9</td>
<td class="instruction">SLA (HL)</td>
<td class="comment-1" rowspan="1">Does a character square need printing?</td>
</tr>
<tr>
<td class="address-1"><span id="62bb"></span>62BB</td>
<td class="instruction">JR C,$62C1</td>
<td class="comment-1" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="address-1"><span id="62bd"></span>62BD</td>
<td class="instruction">JR NZ,$62B8</td>
<td class="comment-1" rowspan="1">Jump back if there are still non-zero bits left in this SRB byte</td>
</tr>
<tr>
<td class="address-1"><span id="62bf"></span>62BF</td>
<td class="instruction">JR $62CB</td>
<td class="comment-1" rowspan="1">Jump forward to consider the next SRB byte</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="62c1"></span>
<div class="comments">
<div class="paragraph">
We found a set bit in the current SRB byte. Print the corresponding character square.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="62c1"></span>62C1</td>
<td class="instruction">PUSH HL</td>
<td class="comment-1" rowspan="1">Save the SRB pointer</td>
</tr>
<tr>
<td class="address-1"><span id="62c2"></span>62C2</td>
<td class="instruction">PUSH DE</td>
<td class="comment-1" rowspan="1">Save the screen (row,column) pointer</td>
</tr>
<tr>
<td class="address-1"><span id="62c3"></span>62C3</td>
<td class="instruction">EX DE,HL</td>
<td class="comment-1" rowspan="1">Switch the screen (row,column) pointer to <span class="register">HL</span></td>
</tr>
<tr>
<td class="address-1"><span id="62c4"></span>62C4</td>
<td class="instruction">CALL <a href="606C.html">$606C</a></td>
<td class="comment-1" rowspan="1">Print the character square at this row and column</td>
</tr>
<tr>
<td class="address-1"><span id="62c7"></span>62C7</td>
<td class="instruction">POP DE</td>
<td class="comment-1" rowspan="1">Restore the screen (row,column) pointer to <span class="register">DE</span></td>
</tr>
<tr>
<td class="address-1"><span id="62c8"></span>62C8</td>
<td class="instruction">POP HL</td>
<td class="comment-1" rowspan="1">Restore the SRB pointer to <span class="register">HL</span></td>
</tr>
<tr>
<td class="address-1"><span id="62c9"></span>62C9</td>
<td class="instruction">JR $62B8</td>
<td class="comment-1" rowspan="1">Examine the next bit of the current SRB byte</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="62cb"></span>
<div class="comments">
<div class="paragraph">
There are no set bits remaining in the current SRB byte. Move to the next SRB byte.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="62cb"></span>62CB</td>
<td class="instruction">POP BC</td>
<td class="comment-1" rowspan="1">Restore the SRB byte counter to <span class="register">B</span></td>
</tr>
<tr>
<td class="address-2"><span id="62cc"></span>62CC</td>
<td class="instruction">INC L</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at the next SRB byte</td>
</tr>
<tr>
<td class="address-1"><span id="62cd"></span>62CD</td>
<td class="instruction">DJNZ $62A5</td>
<td class="comment-1" rowspan="1">Jump back until all 84 SRB bytes have been dealt with</td>
</tr>
<tr>
<td class="address-1"><span id="62cf"></span>62CF</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1"></td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="6291.html">6291</a>
</td>
<td class="up">Up: <a href="../maps/all.html#62a0">Map</a></td>
<td class="next">
Next: <a href="62D0.html">62D0</a>
</td>
</tr>
</table>
<footer>
<div class="release">The complete Back to Skool RAM disassembly 20221122</div>
<div class="copyright">&#169; 1985 Microsphere Computer Services Ltd. &#169; 2022 Richard Dymond.</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 8.8.</div>
<div><a href="../dec/asm/25248.html">Switch to decimal</a>.</div>
</footer>
</body>
</html>