<!DOCTYPE html>
<html>
<head>
<title>Back to Skool: Routine at 7B0E</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../style.css" />

</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="Back to Skool" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a href="7AE6.html">7AE6</a></span></td>
<td class="up">Up: <a href="../maps/all.html#7b0e">Map</a></td>
<td class="next"><span class="next-1">Next: <a href="7B54.html">7B54</a></span></td>
</tr>
</table>
<div class="description">7B0E: Prepare character buffers for released mice</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="4">
<div class="details">
<div class="paragraph">
Used by the routine at <a href="7AE6.html">7AE6</a>. Releases up to five mice from ERIC's pocket. Each mouse will use a character buffer at page 0xC6, 0xC7 or 0xCE-0xD0, provided that the character who usually occupies it is off-screen.
</div>
</div>
<table class="input-1">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">DE</td>
<td class="register-desc">Coordinates at which to release the mice</td>
</tr>
</table>
<table class="output-0">
<tr class="asm-output-header">
<th colspan="2">Output</th>
</tr>

</table>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="7b0e"></span>7B0E</td>
<td class="instruction">LD H,$C6</td>
<td class="comment-11" rowspan="2">Use buffers 0xC6 and 0xC7 (little boys nos. 9 and 10) for released mice if possible</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="7b10"></span>7B10</td>
<td class="instruction">LD B,$02</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="7b12"></span>7B12</td>
<td class="instruction">CALL $7B1A</td>
<td class="comment-11" rowspan="1">Prepare these buffers</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="7b15"></span>7B15</td>
<td class="instruction">RET Z</td>
<td class="comment-11" rowspan="1">Return if ERIC has no mice left</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="7b16"></span>7B16</td>
<td class="instruction">LD H,$CE</td>
<td class="comment-11" rowspan="2">Also use buffers 0xCE-0xD0 (BOY WANDER, ANGELFACE and EINSTEIN) for released mice if possible</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="7b18"></span>7B18</td>
<td class="instruction">LD B,$03</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="7b1a"></span>7B1A</td>
<td class="instruction">LD L,$12</td>
<td class="comment-11" rowspan="2">Pick up the MSB of the uninterruptible subcommand routine address in bytes 0x11 and 0x12 of the character's buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="7b1c"></span>7B1C</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="7b1d"></span>7B1D</td>
<td class="instruction">CP $7A</td>
<td class="comment-11" rowspan="1">Does the MSB match that of <a href="7A16.html">7A16</a>?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="7b1f"></span>7B1F</td>
<td class="instruction">JR Z,$7B50</td>
<td class="comment-11" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="7b21"></span>7B21</td>
<td class="instruction">LD L,$01</td>
<td class="comment-11" rowspan="2"><span class="register">A</span>=x-coordinate of the character using this buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="7b23"></span>7B23</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="7b24"></span>7B24</td>
<td class="instruction">CP $8E</td>
<td class="comment-11" rowspan="1">Is this character inside or close to the girls' skool?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="7b26"></span>7B26</td>
<td class="instruction">JR NC,$7B50</td>
<td class="comment-11" rowspan="1">Jump if so (we can't use his buffer)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="7b28"></span>7B28</td>
<td class="instruction">DEC L</td>
<td class="comment-11" rowspan="1"><span class="register">L</span>=0x00</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="7b29"></span>7B29</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=character's animatory state</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="7b2a"></span>7B2A</td>
<td class="instruction">LD L,$0F</td>
<td class="comment-11" rowspan="2">Store this in byte 0x0F of the buffer for retrieval when the mouse dies</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="7b2c"></span>7B2C</td>
<td class="instruction">LD (HL),A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="7b2d"></span>7B2D</td>
<td class="instruction">CALL <a href="6291.html">$6291</a></td>
<td class="comment-11" rowspan="3"><span class="register">A</span>=random number between 0x0A and 0x29; this determines the lifespan of the mouse</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="7b30"></span>7B30</td>
<td class="instruction">AND $1F</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="7b32"></span>7B32</td>
<td class="instruction">ADD A,$0A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="7b34"></span>7B34</td>
<td class="instruction">INC L</td>
<td class="comment-11" rowspan="2">Store this lifespan parameter in byte 0x10 of the buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="7b35"></span>7B35</td>
<td class="instruction">LD (HL),A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="7b36"></span>7B36</td>
<td class="instruction">INC L</td>
<td class="comment-11" rowspan="4">Place the address of the uninterruptible subcommand routine at <a href="7A16.html">7A16</a> into bytes 0x11 and 0x12 of the character's buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="7b37"></span>7B37</td>
<td class="instruction">LD (HL),$16</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="7b39"></span>7B39</td>
<td class="instruction">INC L</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="7b3a"></span>7B3A</td>
<td class="instruction">LD (HL),$7A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="7b3c"></span>7B3C</td>
<td class="instruction">XOR A</td>
<td class="comment-11" rowspan="5">Set bytes 0x13 and 0x14 to 0 so that the mouse is initially hidden (see <a href="7A16.html">7A16</a> for details on how these bytes are used)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="7b3d"></span>7B3D</td>
<td class="instruction">INC L</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="7b3e"></span>7B3E</td>
<td class="instruction">LD (HL),A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="7b3f"></span>7B3F</td>
<td class="instruction">INC L</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="7b40"></span>7B40</td>
<td class="instruction">LD (HL),A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="7b41"></span>7B41</td>
<td class="instruction">INC L</td>
<td class="comment-11" rowspan="2">Set byte 0x15 (time remaining before coming out of hiding) to 3, 2 or 1</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="7b42"></span>7B42</td>
<td class="instruction">LD (HL),B</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="7b43"></span>7B43</td>
<td class="instruction">INC L</td>
<td class="comment-11" rowspan="2">Store the x-coordinate of the mouse in byte 0x16, so it appears there when it comes out of hiding</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="7b44"></span>7B44</td>
<td class="instruction">LD (HL),E</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="7b45"></span>7B45</td>
<td class="instruction">LD L,$02</td>
<td class="comment-11" rowspan="2">Store the y-coordinate in byte 0x02</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="7b47"></span>7B47</td>
<td class="instruction">LD (HL),D</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="7b48"></span>7B48</td>
<td class="instruction">LD A,($7FE1)</td>
<td class="comment-11" rowspan="1"><a href="7FE1.html">7FE1</a> holds the number of mice ERIC has caught</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="7b4b"></span>7B4B</td>
<td class="instruction">DEC A</td>
<td class="comment-11" rowspan="2">One fewer now</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="7b4c"></span>7B4C</td>
<td class="instruction">LD ($7FE1),A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="7b4f"></span>7B4F</td>
<td class="instruction">RET Z</td>
<td class="comment-11" rowspan="1">Return if ERIC has no mice left</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="7b50"></span>7B50</td>
<td class="instruction">INC H</td>
<td class="comment-11" rowspan="1">Point to the next potential buffer for a released mouse</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="7b51"></span>7B51</td>
<td class="instruction">DJNZ $7B1A</td>
<td class="comment-11" rowspan="1">Jump back until all have been considered</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="7b53"></span>7B53</td>
<td class="instruction">RET</td>
<td class="comment-11" rowspan="1"></td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a href="7AE6.html">7AE6</a></span></td>
<td class="up">Up: <a href="../maps/all.html#7b0e">Map</a></td>
<td class="next"><span class="next-1">Next: <a href="7B54.html">7B54</a></span></td>
</tr>
</table>
<footer>
<div class="release">The complete Back to Skool RAM disassembly 20170515</div>
<div class="copyright">&#169; 1985 Microsphere Computer Services Ltd. &#169; 2017 Richard Dymond.</div>
<div class="created">Created using <a href="http://skoolkit.ca/">SkoolKit</a> 6.0.</div>
</footer>
</body>
</html>