<!DOCTYPE html>
<html>
<head>
<title>Back to Skool: Routine at 6C18</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../style.css" />

</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="Back to Skool" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a href="6C17.html">6C17</a></span></td>
<td class="up">Up: <a href="../maps/all.html#6c18">Map</a></td>
<td class="next"><span class="next-1">Next: <a href="6C9B.html">6C9B</a></span></td>
</tr>
</table>
<div class="description">6C18: Alter UDG references in the play area for a door, a window, a cup or the bike</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="4">
<div class="details">
<div class="paragraph">
Used by the routines at <a href="5DDC.html">5DDC</a>, <a href="6CD4.html">6CD4</a>, <a href="7040.html">7040</a> and <a href="FA4D.html">FA4D</a>. The UDG reference tables used by this routine are organised into entries of four bytes each. Each entry corresponds to a single UDG within the matrix of UDGs for the door, window, cup or bike:
</div>
<div class="paragraph">
<table class="default">
<tr>
<th colspan="1" rowspan="1">Byte</th>
<th colspan="1" rowspan="1">Contents</th>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">1</td>
<td class="" colspan="1" rowspan="1">y-coordinate</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">2</td>
<td class="" colspan="1" rowspan="1">x-coordinate</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">3</td>
<td class="" colspan="1" rowspan="1">UDG reference</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">4 (bits 0-3)</td>
<td class="" colspan="1" rowspan="1">BRIGHT/PAPER attributes</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">4 (bits 6 &amp; 7)</td>
<td class="" colspan="1" rowspan="1">UDG base page identifier</td>
</tr>
</table>
</div>
<div class="paragraph">
The data tables used are located as follows:
</div>
<div class="paragraph">
<table class="default">
<tr>
<th colspan="1" rowspan="1">Address</th>
<th colspan="1" rowspan="1">Object</th>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1"><a href="DD3D.html">DD3D</a></td>
<td class="" colspan="1" rowspan="1">Left study door (closed)</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1"><a href="DE3D.html">DE3D</a></td>
<td class="" colspan="1" rowspan="1">Left study door (open)</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1"><a href="DF00.html">DF00</a></td>
<td class="" colspan="1" rowspan="1">Right study door (closed)</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1"><a href="E000.html">E000</a></td>
<td class="" colspan="1" rowspan="1">Right study door (open)</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1"><a href="DD00.html">DD00</a></td>
<td class="" colspan="1" rowspan="1">Science Lab storeroom door (closed)</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1"><a href="DE00.html">DE00</a></td>
<td class="" colspan="1" rowspan="1">Science Lab storeroom door (open)</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1"><a href="DF3D.html">DF3D</a></td>
<td class="" colspan="1" rowspan="1">Boys' skool door (closed)</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1"><a href="E03D.html">E03D</a></td>
<td class="" colspan="1" rowspan="1">Boys' skool door (open)</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1"><a href="F900.html">F900</a></td>
<td class="" colspan="1" rowspan="1">Skool gate (closed)</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1"><a href="FA00.html">FA00</a></td>
<td class="" colspan="1" rowspan="1">Skool gate (open)</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1"><a href="DB00.html">DB00</a></td>
<td class="" colspan="1" rowspan="1">Drinks cabinet door (closed)</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1"><a href="DC00.html">DC00</a></td>
<td class="" colspan="1" rowspan="1">Drinks cabinet door (open)</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1"><a href="D700.html">D700</a></td>
<td class="" colspan="1" rowspan="1">Top-floor window (closed)</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1"><a href="D800.html">D800</a></td>
<td class="" colspan="1" rowspan="1">Top-floor window (open)</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1"><a href="D900.html">D900</a></td>
<td class="" colspan="1" rowspan="1">Middle-floor window (closed)</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1"><a href="DA00.html">DA00</a></td>
<td class="" colspan="1" rowspan="1">Middle-floor window (open)</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1"><a href="DB11.html">DB11</a></td>
<td class="" colspan="1" rowspan="1">Cups in the boys' skool (empty)</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1"><a href="DD76.html">DD76</a></td>
<td class="" colspan="1" rowspan="1">Leftmost cup in the boys' skool (containing water)</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1"><a href="DD7B.html">DD7B</a></td>
<td class="" colspan="1" rowspan="1">Leftmost cup in the boys' skool (containing sherry)</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1"><a href="DE76.html">DE76</a></td>
<td class="" colspan="1" rowspan="1">Middle cup in the boys' skool (containing water)</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1"><a href="DE7B.html">DE7B</a></td>
<td class="" colspan="1" rowspan="1">Middle cup in the boys' skool (containing sherry)</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1"><a href="DF76.html">DF76</a></td>
<td class="" colspan="1" rowspan="1">Rightmost cup in the boys' skool (containing water)</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1"><a href="DF7B.html">DF7B</a></td>
<td class="" colspan="1" rowspan="1">Rightmost cup in the boys' skool (containing sherry)</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1"><a href="DC11.html">DC11</a></td>
<td class="" colspan="1" rowspan="1">Cup in the girls' skool (empty)</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1"><a href="E076.html">E076</a></td>
<td class="" colspan="1" rowspan="1">Cup in the girls' skool (containing water)</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1"><a href="E07B.html">E07B</a></td>
<td class="" colspan="1" rowspan="1">Cup in the girls' skool (containing sherry)</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1"><a href="E100.html">E100</a></td>
<td class="" colspan="1" rowspan="1">Tree (with no bike attached)</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1"><a href="E200.html">E200</a></td>
<td class="" colspan="1" rowspan="1">Tree (with bike attached)</td>
</tr>
</table>
</div>
</div>
<table class="input-1">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">HL</td>
<td class="register-desc">UDG reference table address</td>
</tr>
</table>
<table class="output-0">
<tr class="asm-output-header">
<th colspan="2">Output</th>
</tr>

</table>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="6c18"></span>6C18</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="2">Pick up the y-coordinate (Y) in <span class="register">D</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6c19"></span>6C19</td>
<td class="instruction">LD D,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6c1a"></span>6C1A</td>
<td class="instruction">INC A</td>
<td class="comment-11" rowspan="2">Return if we found the end-of-table marker (255)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6c1b"></span>6C1B</td>
<td class="instruction">RET Z</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6c1c"></span>6C1C</td>
<td class="instruction">INC HL</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL</span> at byte 2 of this table entry</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6c1d"></span>6C1D</td>
<td class="instruction">LD E,(HL)</td>
<td class="comment-11" rowspan="1">Pick up the x-coordinate (X) in <span class="register">E</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6c1e"></span>6C1E</td>
<td class="instruction">INC HL</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL</span> at byte 3 of this table entry</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6c1f"></span>6C1F</td>
<td class="instruction">PUSH HL</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6c20"></span>6C20</td>
<td class="instruction">LD A,($7FFF)</td>
<td class="comment-11" rowspan="2"><span class="register">C</span>=leftmost column of the play area on screen</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6c23"></span>6C23</td>
<td class="instruction">LD C,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6c24"></span>6C24</td>
<td class="instruction">LD A,E</td>
<td class="comment-11" rowspan="5">Jump if (X,Y) is off-screen (no need to update the screen refresh buffer)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6c25"></span>6C25</td>
<td class="instruction">SUB C</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6c26"></span>6C26</td>
<td class="instruction">JR C,$6C45</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6c28"></span>6C28</td>
<td class="instruction">CP $20</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6c2a"></span>6C2A</td>
<td class="instruction">JR NC,$6C45</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="6c2c"></span>
<div class="comments">
<div class="paragraph">
(X,Y) corresponds to a location that is currently on-screen, so we have to update the <a href="7F00.html">screen refresh buffer</a> (SRB).
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6c2c"></span>6C2C</td>
<td class="instruction">LD C,A</td>
<td class="comment-11" rowspan="1">0&lt;=<span class="register">C</span>&lt;=31 (screen x-coordinate)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6c2d"></span>6C2D</td>
<td class="instruction">AND $07</td>
<td class="comment-11" rowspan="4">Point <span class="register">HL</span> at an entry in the 8-byte table at <a href="E178.html">E178</a>, whose contents are (128, 64, 32, 16, 8, 4, 2, 1)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6c2f"></span>6C2F</td>
<td class="instruction">ADD A,$78</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6c31"></span>6C31</td>
<td class="instruction">LD L,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6c32"></span>6C32</td>
<td class="instruction">LD H,$E1</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6c34"></span>6C34</td>
<td class="instruction">LD B,(HL)</td>
<td class="comment-11" rowspan="1">Pick up this entry in <span class="register">B</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6c35"></span>6C35</td>
<td class="instruction">LD A,C</td>
<td class="comment-11" rowspan="1">0&lt;=<span class="register">A</span>&lt;=31 (screen x-coordinate)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6c36"></span>6C36</td>
<td class="instruction">RRCA</td>
<td class="comment-11" rowspan="10">Point <span class="register">HL</span> at the byte of the SRB corresponding to (X,Y)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6c37"></span>6C37</td>
<td class="instruction">RRCA</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6c38"></span>6C38</td>
<td class="instruction">RRCA</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6c39"></span>6C39</td>
<td class="instruction">AND $03</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6c3b"></span>6C3B</td>
<td class="instruction">ADD A,D</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6c3c"></span>6C3C</td>
<td class="instruction">ADD A,D</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6c3d"></span>6C3D</td>
<td class="instruction">ADD A,D</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6c3e"></span>6C3E</td>
<td class="instruction">ADD A,D</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6c3f"></span>6C3F</td>
<td class="instruction">LD L,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6c40"></span>6C40</td>
<td class="instruction">LD H,$7F</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6c42"></span>6C42</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="3">Set the appropriate bit in the SRB byte</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6c43"></span>6C43</td>
<td class="instruction">OR B</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6c44"></span>6C44</td>
<td class="instruction">LD (HL),A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="6c45"></span>
<div class="comments">
<div class="paragraph">
The UDG reference (i.e. the LSB of the base address of the skool UDG) for the skool location (X,Y) must be modified to reflect the change in status of the door, window, cup or bike.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="6c45"></span>6C45</td>
<td class="instruction">LD L,E</td>
<td class="comment-11" rowspan="2">Point <span class="register">HL</span> at the Q value (0&lt;=Q&lt;=143) in page <a href="B500.html">181</a> for the x-coordinate X (see <a href="606C.html">606C</a>)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6c46"></span>6C46</td>
<td class="instruction">LD H,$B5</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6c48"></span>6C48</td>
<td class="instruction">LD E,(HL)</td>
<td class="comment-11" rowspan="1">Pick up the Q value in <span class="register">E</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6c49"></span>6C49</td>
<td class="instruction">LD A,D</td>
<td class="comment-11" rowspan="3">Set <span class="register">DE</span> to the address where the UDG reference for (X,Y) is stored</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6c4a"></span>6C4A</td>
<td class="instruction">ADD A,$A0</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6c4c"></span>6C4C</td>
<td class="instruction">LD D,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6c4d"></span>6C4D</td>
<td class="instruction">POP HL</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL</span> at byte 3 of the table entry</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6c4e"></span>6C4E</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="1">Pick up the replacement UDG reference in <span class="register">A</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6c4f"></span>6C4F</td>
<td class="instruction">INC HL</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL</span> at byte 4 of the table entry</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6c50"></span>6C50</td>
<td class="instruction">LD (DE),A</td>
<td class="comment-11" rowspan="1">Replace the UDG reference for the skool location (X,Y) with the one collected from the table entry</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="6c51"></span>
<div class="comments">
<div class="paragraph">
The attribute byte for the skool location (X,Y) must be modified too.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6c51"></span>6C51</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="1">Pick up byte 4 of the table entry in <span class="register">A</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6c52"></span>6C52</td>
<td class="instruction">AND $0F</td>
<td class="comment-11" rowspan="1">Keep only bits 0-3 (the BRIGHT and PAPER attributes)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6c54"></span>6C54</td>
<td class="instruction">LD B,A</td>
<td class="comment-11" rowspan="1">Copy them to <span class="register">B</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6c55"></span>6C55</td>
<td class="instruction">LD A,E</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=Q (0&lt;=Q&lt;=143)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6c56"></span>6C56</td>
<td class="instruction">LD C,A</td>
<td class="comment-11" rowspan="1">Save the Q value in <span class="register">C</span> for later</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6c57"></span>6C57</td>
<td class="instruction">ADD A,$68</td>
<td class="comment-11" rowspan="4">Point <span class="register">DE</span> at byte 180+INT(Q/2) of page Y+160, where the BRIGHT and PAPER attributes for the skool location (X,Y) are stored</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6c59"></span>6C59</td>
<td class="instruction">SCF</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6c5a"></span>6C5A</td>
<td class="instruction">RRA</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6c5b"></span>6C5B</td>
<td class="instruction">LD E,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6c5c"></span>6C5C</td>
<td class="instruction">JR C,$6C69</td>
<td class="comment-11" rowspan="1">Jump if Q is odd (BRIGHT and PAPER in bits 0-3)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6c5e"></span>6C5E</td>
<td class="instruction">LD A,B</td>
<td class="comment-11" rowspan="6">Shift the BRIGHT and PAPER attributes from bits 0-3 to bits 4-7 of <span class="register">B</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6c5f"></span>6C5F</td>
<td class="instruction">RRCA</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6c60"></span>6C60</td>
<td class="instruction">RRCA</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6c61"></span>6C61</td>
<td class="instruction">RRCA</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6c62"></span>6C62</td>
<td class="instruction">RRCA</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6c63"></span>6C63</td>
<td class="instruction">LD B,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6c64"></span>6C64</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-11" rowspan="2">Pick up the current attribute byte for the skool location (X,Y), keeping bits 0-3 as they are</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6c65"></span>6C65</td>
<td class="instruction">AND $0F</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6c67"></span>6C67</td>
<td class="instruction">JR $6C6C</td>
<td class="comment-11" rowspan="1">Jump forward to adjust bits 4-7 appropriately</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="6c69"></span>6C69</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-11" rowspan="2">Pick up the current attribute byte for the skool location (X,Y), keeping bits 4-7 as they are</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6c6a"></span>6C6A</td>
<td class="instruction">AND $F0</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="6c6c"></span>6C6C</td>
<td class="instruction">OR B</td>
<td class="comment-11" rowspan="2">Adjust bits 0-3 (if Q is odd) or bits 4-7 (Q is even) of the attribute byte for the skool location (X,Y)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6c6d"></span>6C6D</td>
<td class="instruction">LD (DE),A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="6c6e"></span>
<div class="comments">
<div class="paragraph">
Finally, the base page (128, 136, 144 or 152) for the new skool UDG reference must be set.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6c6e"></span>6C6E</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="1">Pick up byte 4 of the table entry in <span class="register">A</span> again</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6c6f"></span>6C6F</td>
<td class="instruction">AND $C0</td>
<td class="comment-11" rowspan="1">Keep only bits 6 and 7</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6c71"></span>6C71</td>
<td class="instruction">BIT 6,A</td>
<td class="comment-11" rowspan="4">Set <span class="register">B</span>=10001000 if these bits are 11, 10000000 (10), 00001000 (01) or 00000000 (00)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6c73"></span>6C73</td>
<td class="instruction">JR Z,$6C77</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6c75"></span>6C75</td>
<td class="instruction">SUB $38</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="6c77"></span>6C77</td>
<td class="instruction">LD B,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6c78"></span>6C78</td>
<td class="instruction">LD A,C</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=Q</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6c79"></span>6C79</td>
<td class="instruction">LD C,$88</td>
<td class="comment-11" rowspan="1"><span class="register">C</span>=10001000</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6c7b"></span>6C7B</td>
<td class="instruction">SRL A</td>
<td class="comment-11" rowspan="10">Set <span class="register">A</span>=INT(Q/4), and shift <span class="register">B</span> and <span class="register">C</span> right (Q AND 3) times</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6c7d"></span>6C7D</td>
<td class="instruction">JR NC,$6C83</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6c7f"></span>6C7F</td>
<td class="instruction">RRC B</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6c81"></span>6C81</td>
<td class="instruction">RRC C</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="6c83"></span>6C83</td>
<td class="instruction">SRL A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6c85"></span>6C85</td>
<td class="instruction">JR NC,$6C8F</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6c87"></span>6C87</td>
<td class="instruction">RRC B</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6c89"></span>6C89</td>
<td class="instruction">RRC C</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6c8b"></span>6C8B</td>
<td class="instruction">RRC B</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6c8d"></span>6C8D</td>
<td class="instruction">RRC C</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="6c8f"></span>6C8F</td>
<td class="instruction">ADD A,$90</td>
<td class="comment-11" rowspan="2">Point <span class="register">DE</span> at byte 144+INT(Q/4) of page Y+160, where the UDG MSB identifier bit-pair for skool location (X,Y) is held (see <a href="606C.html">606C</a>)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6c91"></span>6C91</td>
<td class="instruction">LD E,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6c92"></span>6C92</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-11" rowspan="1">Pick up the current MSB identifier byte in <span class="register">A</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6c93"></span>6C93</td>
<td class="instruction">OR C</td>
<td class="comment-11" rowspan="3">Replace bits (0,4), (1,5), (2,6) or (3,7) in this byte with the corresponding bits in <span class="register">B</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6c94"></span>6C94</td>
<td class="instruction">XOR C</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6c95"></span>6C95</td>
<td class="instruction">OR B</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6c96"></span>6C96</td>
<td class="instruction">LD (DE),A</td>
<td class="comment-11" rowspan="1">Store the new MSB identifier byte</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="6c97"></span>
<div class="comments">
<div class="paragraph">
Move to the next entry in the table.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6c97"></span>6C97</td>
<td class="instruction">INC HL</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL</span> at the first byte of the next entry in the table</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6c98"></span>6C98</td>
<td class="instruction">JP $6C18</td>
<td class="comment-11" rowspan="1">Jump back to process it</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a href="6C17.html">6C17</a></span></td>
<td class="up">Up: <a href="../maps/all.html#6c18">Map</a></td>
<td class="next"><span class="next-1">Next: <a href="6C9B.html">6C9B</a></span></td>
</tr>
</table>
<footer>
<div class="release">The complete Back to Skool RAM disassembly 20151012</div>
<div class="copyright">&#169; 1985 Microsphere Computer Services Ltd (Back to Skool). &#169; 2015 Richard Dymond (this disassembly).</div>
<div class="created">Created using <a href="http://skoolkit.ca/">SkoolKit</a> 5.1.</div>
</footer>
</body>
</html>