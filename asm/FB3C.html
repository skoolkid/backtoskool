<!DOCTYPE html>
<html>
<head>
<title>Back to Skool: Routine at FB3C</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../style.css" />

</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="Back to Skool" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a href="FB03.html">FB03</a></span></td>
<td class="up">Up: <a href="../maps/all.html#fb3c">Map</a></td>
<td class="next"><span class="next-1">Next: <a href="FBA0.html">FBA0</a></span></td>
</tr>
</table>
<div class="description">FB3C: Deal with ERIC when he's standing on a plant or plant pot</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="4">
<div class="details">
<div class="paragraph">
Used by the routine at <a href="F7AD.html">F7AD</a> when bit 1 at <a href="7FED.html">7FED</a> is set (by the routine at <a href="5D63.html">5D63</a>). If 'down', 'left' or 'right' is pressed while ERIC is standing on a plant or plant pot, this routine will set bit 2 or 3 of ERIC's status flags at <a href="7FED.html">7FED</a> as follows:
</div>
<div class="paragraph">
<table class="default">
<tr>
<th colspan="1" rowspan="1">Bit(s)</th>
<th colspan="1" rowspan="1">Meaning</th>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">2</td>
<td class="" colspan="1" rowspan="1">ERIC is stepping off a plant or plant pot straight to the floor</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">3</td>
<td class="" colspan="1" rowspan="1">ERIC is falling and will land on his feet ('down' pressed)</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">2 &amp; 3</td>
<td class="" colspan="1" rowspan="1">ERIC is stepping off a fully grown plant in the direction of an open window or the closed skool gate</td>
</tr>
</table>
</div>
</div>
<table class="input-0">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>

</table>
<table class="output-0">
<tr class="asm-output-header">
<th colspan="2">Output</th>
</tr>

</table>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="fb3c"></span>FB3C</td>
<td class="instruction">LD HL,$7FF3</td>
<td class="comment-11" rowspan="1"><a href="7FF3.html">7FF3</a> holds ERIC's main action timer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="fb3f"></span>FB3F</td>
<td class="instruction">DEC (HL)</td>
<td class="comment-11" rowspan="1">Is it time to deal with ERIC yet?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="fb40"></span>FB40</td>
<td class="instruction">RET NZ</td>
<td class="comment-11" rowspan="1">Return if not</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="fb41"></span>FB41</td>
<td class="instruction">INC (HL)</td>
<td class="comment-11" rowspan="1">Set ERIC's main action timer to 1, ensuring that we pass through the following section of code on the next call to this routine if no keypress is detected this time</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="fb42"></span>FB42</td>
<td class="instruction">CALL <a href="71FA.html">$71FA</a></td>
<td class="comment-11" rowspan="1">Get the value from the <a href="E500.html">keypress offset table</a> corresponding to the last key pressed (if any)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="fb45"></span>FB45</td>
<td class="instruction">RET Z</td>
<td class="comment-11" rowspan="1">Return if no keys were pressed</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="fb46"></span>
<div class="comments">
<div class="paragraph">
A key was pressed while ERIC was standing on a plant or plant pot.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="fb46"></span>FB46</td>
<td class="instruction">LD HL,$7FF3</td>
<td class="comment-11" rowspan="2">Reset ERIC's main action timer at <a href="7FF3.html">7FF3</a> to 5</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="fb49"></span>FB49</td>
<td class="instruction">LD (HL),$05</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="fb4b"></span>FB4B</td>
<td class="instruction">RES 3,A</td>
<td class="comment-11" rowspan="1">Reset bit 3 of the keypress code to make it lower case</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="fb4d"></span>FB4D</td>
<td class="instruction">CP $56</td>
<td class="comment-11" rowspan="1">Was 'down' pressed?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="fb4f"></span>FB4F</td>
<td class="instruction">JR NZ,$FB56</td>
<td class="comment-11" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="fb51"></span>
<div class="comments">
<div class="paragraph">
'Down' was pressed, so make ERIC descend gracefully.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="fb51"></span>FB51</td>
<td class="instruction">LD L,$ED</td>
<td class="comment-11" rowspan="1"><span class="register">HL</span>=<a href="7FED.html">7FED</a> (ERIC's secondary status flags)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="fb53"></span>FB53</td>
<td class="instruction">LD (HL),$08</td>
<td class="comment-11" rowspan="1">Set bit 3: ERIC is falling and will land on his feet</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="fb55"></span>FB55</td>
<td class="instruction">RET</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="fb56"></span>
<div class="comments">
<div class="paragraph">
It wasn't 'down'. Was it 'left' or 'right'?
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="fb56"></span>FB56</td>
<td class="instruction">EX DE,HL</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="fb57"></span>FB57</td>
<td class="instruction">LD HL,$D200</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL</span> at byte 0x00 of ERIC's buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="fb5a"></span>FB5A</td>
<td class="instruction">CP $52</td>
<td class="comment-11" rowspan="1">Was 'right' pressed?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="fb5c"></span>FB5C</td>
<td class="instruction">JR NZ,$FB90</td>
<td class="comment-11" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="fb5e"></span>
<div class="comments">
<div class="paragraph">
'Right' was pressed.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="fb5e"></span>FB5E</td>
<td class="instruction">BIT 7,(HL)</td>
<td class="comment-11" rowspan="1">Is ERIC facing left?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="fb60"></span>FB60</td>
<td class="instruction">JP Z,<a href="6E38.html">$6E38</a></td>
<td class="comment-11" rowspan="1">Turn ERIC round if so</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="fb63"></span>FB63</td>
<td class="instruction">INC L</td>
<td class="comment-11" rowspan="1"><span class="register">L</span>=0x01</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="fb64"></span>FB64</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=ERIC's x-coordinate</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="fb65"></span>FB65</td>
<td class="instruction">EX DE,HL</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="fb66"></span>FB66</td>
<td class="instruction">INC L</td>
<td class="comment-11" rowspan="1"><span class="register">HL</span>=<a href="7FF4.html">7FF4</a> (which holds the door/window status flags)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="fb67"></span>FB67</td>
<td class="instruction">CP $84</td>
<td class="comment-11" rowspan="1">This is the x-coordinate of the plant pot to the left of the gate</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="fb69"></span>FB69</td>
<td class="instruction">JR C,$FB7F</td>
<td class="comment-11" rowspan="1">Jump if ERIC is standing on a plant pot in the boys' skool</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="fb6b"></span>FB6B</td>
<td class="instruction">JR Z,$FB72</td>
<td class="comment-11" rowspan="1">Jump if ERIC is standing on one of the plant pots beside the gate</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="fb6d"></span>FB6D</td>
<td class="instruction">LD A,$04</td>
<td class="comment-11" rowspan="2">Make a sound effect, update the SRB, and set bit 2 at <a href="7FED.html">7FED</a> (ERIC is stepping off a plant/plant pot)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="fb6f"></span>FB6F</td>
<td class="instruction">JP <a href="FAF2.html#faf4">$FAF4</a></td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="fb72"></span>
<div class="comments">
<div class="paragraph">
ERIC is standing on one of the plant pots on either side of the skool gate, and has tried to step off the plant or plant pot in the direction of the gate.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="fb72"></span>FB72</td>
<td class="instruction">BIT 4,(HL)</td>
<td class="comment-11" rowspan="1">Is the skool gate open?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="fb74"></span>FB74</td>
<td class="instruction">JR NZ,$FB6D</td>
<td class="comment-11" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="fb76"></span>FB76</td>
<td class="instruction">LD B,$0E</td>
<td class="comment-11" rowspan="1">This is the y-coordinate of ERIC if he's standing on a fully grown plant on the bottom floor</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="fb78"></span>FB78</td>
<td class="instruction">INC E</td>
<td class="comment-11" rowspan="1">Point <span class="register">DE</span> at byte 0x02 of ERIC's buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="fb79"></span>FB79</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=ERIC's y-coordinate</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="fb7a"></span>FB7A</td>
<td class="instruction">CP B</td>
<td class="comment-11" rowspan="1">Is ERIC on top of a fully grown plant?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="fb7b"></span>FB7B</td>
<td class="instruction">RET NZ</td>
<td class="comment-11" rowspan="1">Return if not</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="fb7c"></span>FB7C</td>
<td class="instruction">JP <a href="FAF2.html">$FAF2</a></td>
<td class="comment-11" rowspan="1">Otherwise make a sound effect, update the SRB, and set bits 2 and 3 at <a href="7FED.html">7FED</a></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="fb7f"></span>
<div class="comments">
<div class="paragraph">
ERIC is standing on one of the plant pots in the boys' skool, and has tried to step off in the direction of the window.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="fb7f"></span>FB7F</td>
<td class="instruction">CP $5B</td>
<td class="comment-11" rowspan="1">Is ERIC standing on the top-floor plant pot?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="fb81"></span>FB81</td>
<td class="instruction">JR NZ,$FB8A</td>
<td class="comment-11" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="fb83"></span>FB83</td>
<td class="instruction">LD B,$00</td>
<td class="comment-11" rowspan="1">This is the y-coordinate of ERIC if he's standing on a fully-grown plant on the top floor</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="fb85"></span>FB85</td>
<td class="instruction">BIT 6,(HL)</td>
<td class="comment-11" rowspan="1">Is the top-floor window closed?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="fb87"></span>FB87</td>
<td class="instruction">RET Z</td>
<td class="comment-11" rowspan="1">Return if so</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="fb88"></span>FB88</td>
<td class="instruction">JR $FB78</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="fb8a"></span>FB8A</td>
<td class="instruction">LD B,$07</td>
<td class="comment-11" rowspan="1">This is the y-coordinate of ERIC if he's standing on a fully-grown plant on the middle floor</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="fb8c"></span>FB8C</td>
<td class="instruction">BIT 7,(HL)</td>
<td class="comment-11" rowspan="1">Set the zero flag if the middle-floor window is closed</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="fb8e"></span>FB8E</td>
<td class="instruction">JR $FB87</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="fb90"></span>
<div class="comments">
<div class="paragraph">
'Right' wasn't pressed. Was it 'left'?
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="fb90"></span>FB90</td>
<td class="instruction">CP $50</td>
<td class="comment-11" rowspan="1">Was 'left' pressed?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="fb92"></span>FB92</td>
<td class="instruction">RET NZ</td>
<td class="comment-11" rowspan="1">Return if not</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="fb93"></span>
<div class="comments">
<div class="paragraph">
'Left' was pressed.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="fb93"></span>FB93</td>
<td class="instruction">BIT 7,(HL)</td>
<td class="comment-11" rowspan="1">Is ERIC facing right?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="fb95"></span>FB95</td>
<td class="instruction">JP NZ,<a href="6E38.html">$6E38</a></td>
<td class="comment-11" rowspan="1">Turn ERIC round if so</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="fb98"></span>FB98</td>
<td class="instruction">INC L</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL</span> at byte 0x01 of ERIC's buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="fb99"></span>FB99</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=ERIC's x-coordinate</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="fb9a"></span>FB9A</td>
<td class="instruction">EX DE,HL</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="fb9b"></span>FB9B</td>
<td class="instruction">INC L</td>
<td class="comment-11" rowspan="1"><span class="register">HL</span>=<a href="7FF4.html">7FF4</a> (which holds the door/window status flags)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="fb9c"></span>FB9C</td>
<td class="instruction">CP $87</td>
<td class="comment-11" rowspan="1">This is the x-coordinate of the plant pot to the right of the gate; set the carry flag if ERIC is to the left of this, or set the zero flag if he's standing on it</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="fb9e"></span>FB9E</td>
<td class="instruction">JR $FB6B</td>
<td class="comment-11" rowspan="1"></td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a href="FB03.html">FB03</a></span></td>
<td class="up">Up: <a href="../maps/all.html#fb3c">Map</a></td>
<td class="next"><span class="next-1">Next: <a href="FBA0.html">FBA0</a></span></td>
</tr>
</table>
<footer>
<div class="release">The complete Back to Skool RAM disassembly 20181019</div>
<div class="copyright">&#169; 1985 Microsphere Computer Services Ltd. &#169; 2018 Richard Dymond.</div>
<div class="created">Created using <a href="http://skoolkit.ca/">SkoolKit</a> 7.0.</div>
<div><a href="http://skoolkit.ca/disassemblies/back_to_skool/asm/64316.html">Switch to decimal</a>.</div>
</footer>
</body>
</html>