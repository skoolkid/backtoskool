<!DOCTYPE html>
<html>
<head>
<title>Back to Skool: Routine at 6558</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../style.css" />

</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="Back to Skool" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a href="6554.html">6554</a></span></td>
<td class="up">Up: <a href="../maps/all.html#6558">Map</a></td>
<td class="next"><span class="next-1">Next: <a href="65CE.html">65CE</a></span></td>
</tr>
</table>
<div class="description">6558: Make a teacher find ERIC</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="4">
<div class="details">
<div class="paragraph">
Used by the routines at <a href="7E7B.html">7E7B</a>, <a href="F09B.html">F09B</a>, <a href="F54A.html">F54A</a> and <a href="F55F.html">F55F</a>. Computes the teacher's next move in the search for ERIC.
</div>
</div>
<table class="input-1">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">H</td>
<td class="register-desc">Teacher's character number (0xC8-0xCC)</td>
</tr>
</table>
<table class="output-0">
<tr class="asm-output-header">
<th colspan="2">Output</th>
</tr>

</table>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="6558"></span>6558</td>
<td class="instruction">LD L,$00</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL</span> at byte 0x00 of the character's buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="655a"></span>655A</td>
<td class="instruction">BIT 0,(HL)</td>
<td class="comment-11" rowspan="1">Is the teacher midstride?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="655c"></span>655C</td>
<td class="instruction">JR Z,$656B</td>
<td class="comment-11" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="655e"></span>
<div class="comments">
<div class="paragraph">
This entry point is used by the routines at <a href="7E7B.html">7E7B</a>, <a href="F09B.html">F09B</a> and <a href="F54A.html">F54A</a> to make the teacher who his chasing ERIC finish his stride.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="655e"></span>655E</td>
<td class="instruction">CALL <a href="61B4.html">$61B4</a></td>
<td class="comment-11" rowspan="1">Update the SRB for the teacher's current animatory state and location</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6561"></span>6561</td>
<td class="instruction">LD B,A</td>
<td class="comment-11" rowspan="1">Save the animatory state in <span class="register">B</span> temporarily</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6562"></span>6562</td>
<td class="instruction">LD L,$0F</td>
<td class="comment-11" rowspan="2">Byte 0x0F holds the y-coordinate adjustment to make as the teacher finishes this stride: 0 normally, 1 if descending a staircase (see later in this routine)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6564"></span>6564</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6565"></span>6565</td>
<td class="instruction">ADD A,D</td>
<td class="comment-11" rowspan="2">Make the appropriate y-coordinate adjustment</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6566"></span>6566</td>
<td class="instruction">LD D,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6567"></span>6567</td>
<td class="instruction">LD A,B</td>
<td class="comment-11" rowspan="1">Restore the animatory state to <span class="register">A</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6568"></span>6568</td>
<td class="instruction">JP <a href="63ED.html#6400">$6400</a></td>
<td class="comment-11" rowspan="1">Make the teacher finish his stride</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="656b"></span>
<div class="comments">
<div class="paragraph">
The teacher is not midstride. Is he close enough to ERIC to stop the chase?
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="656b"></span>656B</td>
<td class="instruction">CALL <a href="6E50.html#6e52">$6E52</a></td>
<td class="comment-11" rowspan="1">Is the teacher on a staircase?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="656e"></span>656E</td>
<td class="instruction">JR C,$6597</td>
<td class="comment-11" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6570"></span>6570</td>
<td class="instruction">LD DE,($D201)</td>
<td class="comment-11" rowspan="1">Pick up ERIC's coordinates in <span class="register">DE</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6574"></span>6574</td>
<td class="instruction">LD L,$00</td>
<td class="comment-11" rowspan="1">Byte 0x00 holds the teacher's animatory state</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6576"></span>6576</td>
<td class="instruction">BIT 7,(HL)</td>
<td class="comment-11" rowspan="1">Is the teacher facing left?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6578"></span>6578</td>
<td class="instruction">LD L,$01</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="657a"></span>657A</td>
<td class="instruction">JR Z,$6580</td>
<td class="comment-11" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="657c"></span>657C</td>
<td class="instruction">LD A,E</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=ERIC's x-coordinate</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="657d"></span>657D</td>
<td class="instruction">SUB (HL)</td>
<td class="comment-11" rowspan="1">Subtract that of the teacher</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="657e"></span>657E</td>
<td class="instruction">JR $6582</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="6580"></span>6580</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=teacher's x-coordinate</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6581"></span>6581</td>
<td class="instruction">SUB E</td>
<td class="comment-11" rowspan="1">Subtract that of ERIC</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="6582"></span>6582</td>
<td class="instruction">CP $04</td>
<td class="comment-11" rowspan="1">Is ERIC less than 4 horizontal spaces in front of the teacher?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6584"></span>6584</td>
<td class="instruction">JR NC,$6594</td>
<td class="comment-11" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6586"></span>6586</td>
<td class="instruction">INC L</td>
<td class="comment-11" rowspan="1"><span class="register">L</span>=0x02</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6587"></span>6587</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=teacher's y-coordinate</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6588"></span>6588</td>
<td class="instruction">SUB $04</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="658a"></span>658A</td>
<td class="instruction">JR C,$658F</td>
<td class="comment-11" rowspan="1">Jump if the teacher's on the top floor</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="658c"></span>658C</td>
<td class="instruction">CP D</td>
<td class="comment-11" rowspan="1">Is ERIC at least 4 vertical spaces above the teacher?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="658d"></span>658D</td>
<td class="instruction">JR NC,$6594</td>
<td class="comment-11" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="658f"></span>658F</td>
<td class="instruction">ADD A,$07</td>
<td class="comment-11" rowspan="2">Set the carry flag if ERIC is at least 4 vertical spaces below the teacher</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6591"></span>6591</td>
<td class="instruction">CP D</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6592"></span>6592</td>
<td class="instruction">CCF</td>
<td class="comment-11" rowspan="2">Return if ERIC is within 3 vertical spaces either side of the teacher</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6593"></span>6593</td>
<td class="instruction">RET C</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="6594"></span>
<div class="comments">
<div class="paragraph">
The teacher is not close enough to ERIC yet to stop chasing him. Now to figure out the teacher's next move.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="6594"></span>6594</td>
<td class="instruction">CALL <a href="63BE.html">$63BE</a></td>
<td class="comment-11" rowspan="1"><span class="register">D</span>=ERIC's y-coordinate (or the y-coordinate of the floor he's closest to if his feet are not on the floor)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="6597"></span>6597</td>
<td class="instruction">CALL <a href="64F3.html">$64F3</a></td>
<td class="comment-11" rowspan="1">Work out how the teacher can reach ERIC from here</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="659a"></span>659A</td>
<td class="instruction">BIT 3,A</td>
<td class="comment-11" rowspan="1">Is there a closed door in the way?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="659c"></span>659C</td>
<td class="instruction">JP NZ,<a href="708E.html#70a2">$70A2</a></td>
<td class="comment-11" rowspan="1">Open it if so</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="659f"></span>
<div class="comments">
<div class="paragraph">
There is no closed door in the way. Is the teacher on a staircase?
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="659f"></span>659F</td>
<td class="instruction">LD BC,$0000</td>
<td class="comment-11" rowspan="1">Initialise the staircase indicator to 0</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="65a2"></span>65A2</td>
<td class="instruction">CP $02</td>
<td class="comment-11" rowspan="1">Is the teacher descending a staircase?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="65a4"></span>65A4</td>
<td class="instruction">JR NZ,$65A7</td>
<td class="comment-11" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="65a6"></span>65A6</td>
<td class="instruction">INC B</td>
<td class="comment-11" rowspan="1"><span class="register">B</span>=1 (teacher is descending a staircase)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="65a7"></span>65A7</td>
<td class="instruction">JR NC,$65AA</td>
<td class="comment-11" rowspan="1">Jump if the teacher is not ascending a staircase</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="65a9"></span>65A9</td>
<td class="instruction">DEC C</td>
<td class="comment-11" rowspan="1"><span class="register">C</span>=-1 (teacher is ascending a staircase)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="65aa"></span>65AA</td>
<td class="instruction">CP $03</td>
<td class="comment-11" rowspan="1">Is the teacher on a staircase?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="65ac"></span>65AC</td>
<td class="instruction">JR C,$65BD</td>
<td class="comment-11" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="65ae"></span>65AE</td>
<td class="instruction">LD L,$00</td>
<td class="comment-11" rowspan="1">Byte 0x00 holds the teacher's animatory state</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="65b0"></span>65B0</td>
<td class="instruction">CP $04</td>
<td class="comment-11" rowspan="1">Set the carry flag if the teacher should go left</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="65b2"></span>65B2</td>
<td class="instruction">BIT 7,(HL)</td>
<td class="comment-11" rowspan="1">Set the zero flag if the teacher is facing left</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="65b4"></span>65B4</td>
<td class="instruction">JR C,$65BB</td>
<td class="comment-11" rowspan="1">Jump if the teacher must go left to reach ERIC</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="65b6"></span>65B6</td>
<td class="instruction">JR NZ,$65BD</td>
<td class="comment-11" rowspan="1">Jump if the teacher is facing right</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="65b8"></span>65B8</td>
<td class="instruction">JP <a href="63ED.html#6430">$6430</a></td>
<td class="comment-11" rowspan="1">Turn the teacher round</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="65bb"></span>65BB</td>
<td class="instruction">JR NZ,$65B8</td>
<td class="comment-11" rowspan="1">Turn the teacher round if he's facing right</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="65bd"></span>
<div class="comments">
<div class="paragraph">
Now <span class="register">BC</span> is still 0 if the teacher is not on a staircase. Otherwise, <span class="register">B</span>=1 and <span class="register">C</span>=0 if he's descending a staircase, or <span class="register">B</span>=0 and <span class="register">C</span>=-1 if he's ascending a staircase. The value in <span class="register">B</span> is the y-coordinate adjustment to make when the teacher finishes this stride later, and the value in <span class="register">C</span> is the y-coordinate adjustment to make as he goes midstride now.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="65bd"></span>65BD</td>
<td class="instruction">LD L,$0F</td>
<td class="comment-11" rowspan="2">Set byte 0x0F of teacher's buffer to 1 if the teacher is descending a staircase, or 0 if he's ascending a staircase or not on one</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="65bf"></span>65BF</td>
<td class="instruction">LD (HL),B</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="65c0"></span>65C0</td>
<td class="instruction">PUSH BC</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="65c1"></span>65C1</td>
<td class="instruction">CALL <a href="61B4.html">$61B4</a></td>
<td class="comment-11" rowspan="1">Update the SRB for the teacher's current animatory state and location</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="65c4"></span>65C4</td>
<td class="instruction">POP BC</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="65c5"></span>65C5</td>
<td class="instruction">BIT 0,C</td>
<td class="comment-11" rowspan="1">Is the teacher ascending a staircase?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="65c7"></span>65C7</td>
<td class="instruction">JR Z,$65CA</td>
<td class="comment-11" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="65c9"></span>65C9</td>
<td class="instruction">DEC D</td>
<td class="comment-11" rowspan="1">Up a stair as the teacher goes midstride</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="65ca"></span>65CA</td>
<td class="instruction">INC A</td>
<td class="comment-11" rowspan="1">One foot forward (midstride)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="65cb"></span>65CB</td>
<td class="instruction">JP <a href="6130.html">$6130</a></td>
<td class="comment-11" rowspan="1">Update the teacher's animatory state and location and update the SRB</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a href="6554.html">6554</a></span></td>
<td class="up">Up: <a href="../maps/all.html#6558">Map</a></td>
<td class="next"><span class="next-1">Next: <a href="65CE.html">65CE</a></span></td>
</tr>
</table>
<footer>
<div class="release">The complete Back to Skool RAM disassembly 20170515</div>
<div class="copyright">&#169; 1985 Microsphere Computer Services Ltd. &#169; 2017 Richard Dymond.</div>
<div class="created">Created using <a href="http://skoolkit.ca/">SkoolKit</a> 6.0.</div>
</footer>
</body>
</html>