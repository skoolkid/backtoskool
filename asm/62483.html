<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html
    PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Back to Skool: Routine at 62483</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../bts.css" />

</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a class="link" href="../index.html"><img alt="Back to Skool" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a class="link" href="62480.html">62480</a></span></td>
<td class="up">Up: <a class="link" href="../maps/all.html#62483">Map</a></td>
<td class="next"><span class="next-1">Next: <a class="link" href="62560.html">62560</a></span></td>
</tr>
</table>
<div class="description">62483: Collect a keypress during the game (or simulate one in demo mode)</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="4">
<div class="details">
<div class="paragraph">
Called from the main loop at <a class="link" href="63210.html">63210</a>. Returns with <span class="register">A</span> holding the offset from the keypress table corresponding to the last (actual or simulated) keypress, or 0 if there was no (actual or simulated) keypress.
</div>
</div>
<table class="input-0">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>

</table>
<table class="output-0">
<tr class="asm-output-header">
<th colspan="2">Output</th>
</tr>

</table>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="62483"></a>62483</td>
<td class="instruction">LD A,(32734)</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=255 if we're in demo mode, 0 otherwise</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="62486"></a>62486</td>
<td class="instruction">INC A</td>
<td class="comment-11" rowspan="1">Are we in demo mode?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="62487"></a>62487</td>
<td class="instruction">JP NZ,<a class="link" href="29178.html">29178</a></td>
<td class="comment-11" rowspan="1">Read the keyboard if not</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="62490"></a>
<div class="comments">
<div class="paragraph">
We're in demo mode.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="62490"></a>62490</td>
<td class="instruction">LD HL,0</td>
<td class="comment-11" rowspan="3">Set the score (held at <a class="link" href="32741.html">32741</a>) and the number of lines (held at <a class="link" href="32743.html">32743</a>) to 0</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="62493"></a>62493</td>
<td class="instruction">LD (32741),HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="62496"></a>62496</td>
<td class="instruction">LD (32743),HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="62499"></a>62499</td>
<td class="instruction">CALL <a class="link" href="29118.html">29118</a></td>
<td class="comment-11" rowspan="1">Check for keypresses</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="62502"></a>62502</td>
<td class="instruction">JP NZ,<a class="link" href="63189.html">63189</a></td>
<td class="comment-11" rowspan="1">Start a new game if there was one</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="62505"></a>
<div class="comments">
<div class="paragraph">
No keys have been pressed, so figure out ERIC's next move by seeing what little boy no. 10 is doing.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="62505"></a>62505</td>
<td class="instruction">LD DE,(50945)</td>
<td class="comment-11" rowspan="1">Pick up the coordinates of little boy no. 10 in <span class="register">DE</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="62509"></a>62509</td>
<td class="instruction">LD H,210</td>
<td class="comment-11" rowspan="1">210=ERIC</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="62511"></a>62511</td>
<td class="instruction">CALL <a class="link" href="25843.html">25843</a></td>
<td class="comment-11" rowspan="1">Compare the coordinates of ERIC and little boy no. 10</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="62514"></a>62514</td>
<td class="instruction">AND A</td>
<td class="comment-11" rowspan="1">Are they the same?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="62515"></a>62515</td>
<td class="instruction">JR Z,62533</td>
<td class="comment-11" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="62517"></a>62517</td>
<td class="instruction">DEC A</td>
<td class="comment-11" rowspan="1">Now <span class="register">A</span>=0 (ERIC is on a staircase facing up), 1 (on a staircase facing down), 2 (to the right of little boy no. 10), or 3 (to his left)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="62518"></a>62518</td>
<td class="instruction">LD HL,23672</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL</span> at the LSB of the system variable FRAMES</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="62521"></a>62521</td>
<td class="instruction">XOR 2</td>
<td class="comment-11" rowspan="1">Flip bit 1 of <span class="register">A</span></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="62523"></a>
<div class="comments">
<div class="paragraph">
Now <span class="register">A</span> holds a value that will be translated into a simulated keypress depending on ERIC's location:
</div>
<div class="paragraph">
<table class="default">
<tr>
<th colspan="1" rowspan="1"><span class="register">A</span></th>
<th colspan="1" rowspan="1">ERIC's location</th>
<th colspan="1" rowspan="1">Keypress</th>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">0</td>
<td class="" colspan="1" rowspan="1">To the right of little boy no. 10</td>
<td class="" colspan="1" rowspan="1">Left</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">1</td>
<td class="" colspan="1" rowspan="1">To the left of little boy no. 10</td>
<td class="" colspan="1" rowspan="1">Right</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">2</td>
<td class="" colspan="1" rowspan="1">On a staircase, facing up</td>
<td class="" colspan="1" rowspan="1">Up</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">3</td>
<td class="" colspan="1" rowspan="1">On a staircase, facing down</td>
<td class="" colspan="1" rowspan="1">Down</td>
</tr>
</table>
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="62523"></a>62523</td>
<td class="instruction">BIT 7,(HL)</td>
<td class="comment-11" rowspan="1">Is the LSB of FRAMES &lt; 128?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="62525"></a>62525</td>
<td class="instruction">JR Z,62529</td>
<td class="comment-11" rowspan="1">Jump if so: this will be an upper case (fast) keypress</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="62527"></a>62527</td>
<td class="instruction">ADD A,4</td>
<td class="comment-11" rowspan="1">4&lt;=<span class="register">A</span>&lt;=7: force a lower case (slow) keypress</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="62529"></a>62529</td>
<td class="instruction">ADD A,A</td>
<td class="comment-11" rowspan="2"><span class="register">A</span>=80+2n where 0&lt;=n&lt;=7 (simulated keypress for LEFT, RIGHT, UP, DOWN or left, right, up, down)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="62530"></a>62530</td>
<td class="instruction">ADD A,80</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="62532"></a>62532</td>
<td class="instruction">RET</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="62533"></a>
<div class="comments">
<div class="paragraph">
ERIC's coordinates match those of little boy no. 10 exactly.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="62533"></a>62533</td>
<td class="instruction">LD A,(50944)</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=animatory state of little boy no. 10</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="62536"></a>62536</td>
<td class="instruction">CP 68</td>
<td class="comment-11" rowspan="1"><a class="link" href="../graphics/as.html#68">68</a>: little boy sitting in a chair</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="62538"></a>62538</td>
<td class="instruction">LD HL,53760</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL</span> at byte 0 of ERIC's buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="62541"></a>62541</td>
<td class="instruction">JR Z,62549</td>
<td class="comment-11" rowspan="1">Jump if little boy no. 10 is sitting in a chair</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="62543"></a>62543</td>
<td class="instruction">CP 197</td>
<td class="comment-11" rowspan="1"><a class="link" href="../graphics/as.html#197">197</a>: Is little boy no. 10 sitting on the floor facing right (as in assembly)?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="62545"></a>62545</td>
<td class="instruction">JR Z,62549</td>
<td class="comment-11" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="62547"></a>62547</td>
<td class="instruction">XOR A</td>
<td class="comment-11" rowspan="1">No simulated keypress (ERIC stays still)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="62548"></a>62548</td>
<td class="instruction">RET</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="62549"></a>
<div class="comments">
<div class="paragraph">
Little boy no. 10 is sitting in a chair or sitting on the floor facing right (as in assembly), and ERIC is standing. Make ERIC face the same way and sit too (in the same spot as little boy no. 10).
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="62549"></a>62549</td>
<td class="instruction">XOR (HL)</td>
<td class="comment-11" rowspan="2">Set the carry flag if ERIC and little boy no. 10 are facing in opposite directions</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="62550"></a>62550</td>
<td class="instruction">RLCA</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="62551"></a>62551</td>
<td class="instruction">LD A,98</td>
<td class="comment-11" rowspan="1">98=keypress code for 'S' (sit)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="62553"></a>62553</td>
<td class="instruction">RET NC</td>
<td class="comment-11" rowspan="1">Return if ERIC and little boy no. 10 are facing the same way</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="62554"></a>62554</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=ERIC's animatory state</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="62555"></a>62555</td>
<td class="instruction">RLCA</td>
<td class="comment-11" rowspan="4">Set <span class="register">A</span> to 1 if ERIC is facing left (leading to a simulated keypress code of 82, or RIGHT), 0 if he's facing right (leading to a simulated keypress code of 80, or LEFT); that is, make ERIC turn round</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="62556"></a>62556</td>
<td class="instruction">SBC A,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="62557"></a>62557</td>
<td class="instruction">INC A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="62558"></a>62558</td>
<td class="instruction">JR 62529</td>
<td class="comment-01" rowspan="1"></td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a class="link" href="62480.html">62480</a></span></td>
<td class="up">Up: <a class="link" href="../maps/all.html#62483">Map</a></td>
<td class="next"><span class="next-1">Next: <a class="link" href="62560.html">62560</a></span></td>
</tr>
</table>
<div class="footer">
<div class="release">The complete Back to Skool RAM disassembly 20150415</div>
<div class="copyright">&#169; 1985 Microsphere Computer Services Ltd (Back to Skool). &#169; 2015 Richard Dymond (this disassembly).</div>
<div class="created">Created using <a class="link" href="http://skoolkit.ca/">SkoolKit</a> 4.3.</div>
</div>
</body>
</html>