<!DOCTYPE html>
<html>
<head>
<title>Back to Skool: Routine at 6791</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="Back to Skool" src="../images/logo-hex.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="6790.html">6790</a>
</td>
<td class="up">Up: <a href="../maps/all.html#6791">Map</a></td>
<td class="next">
Next: <a href="680D.html">680D</a>
</td>
</tr>
</table>
<div class="description">6791: Write a single character on a blackboard</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
Used by the routine at <a href="6880.html">6880</a>. Returns with the zero flag set if the end of the message has been reached.
</div>
</div>
<table class="input">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">H</td>
<td class="register-desc">Number of the character writing on the board (0xC8-0xCC, 0xCE)</td>
</tr>
</table>
</td>
</tr>
<tr>
<td class="address-2"><span id="6791"></span>6791</td>
<td class="instruction">CALL <a href="66CE.html">$66CE</a></td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=ASCII code of the next character from the message being written</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="6794"></span>
<div class="comments">
<div class="paragraph">
This entry point is used by the routine at <a href="5E6F.html">5E6F</a> when ERIC's writing on a board.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="6794"></span>6794</td>
<td class="instruction">LD C,A</td>
<td class="comment-1" rowspan="1"><span class="register">C</span>=ASCII code of the next character from the message being written</td>
</tr>
<tr>
<td class="address-1"><span id="6795"></span>6795</td>
<td class="instruction">CALL <a href="6755.html">$6755</a></td>
<td class="comment-1" rowspan="1">Collect information about the blackboard</td>
</tr>
<tr>
<td class="address-1"><span id="6798"></span>6798</td>
<td class="instruction">LD A,C</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-1"><span id="6799"></span>6799</td>
<td class="instruction">LD C,B</td>
<td class="comment-1" rowspan="2">Point <span class="register">BC</span> at the blackboard's buffer (<a href="7F54.html">7F54</a>, <a href="7F5A.html">7F5A</a>, <a href="7F60.html">7F60</a>, <a href="7F66.html">7F66</a> or <a href="7F6C.html">7F6C</a>)</td>
</tr>
<tr>
<td class="address-1"><span id="679a"></span>679A</td>
<td class="instruction">LD B,$7F</td>
</tr>
<tr>
<td class="address-1"><span id="679c"></span>679C</td>
<td class="instruction">AND A</td>
<td class="comment-1" rowspan="1">Have we reached the end of the message?</td>
</tr>
<tr>
<td class="address-1"><span id="679d"></span>679D</td>
<td class="instruction">JR NZ,$67A3</td>
<td class="comment-1" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="address-1"><span id="679f"></span>679F</td>
<td class="instruction">DEC A</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=0xFF</td>
</tr>
<tr>
<td class="address-2"><span id="67a0"></span>67A0</td>
<td class="instruction">LD (BC),A</td>
<td class="comment-1" rowspan="1">Set the first byte of the blackboard's buffer to 0xFF if the message is finished, or the the pixel column number for the next letter to be written otherwise</td>
</tr>
<tr>
<td class="address-1"><span id="67a1"></span>67A1</td>
<td class="instruction">INC A</td>
<td class="comment-1" rowspan="1">Set the zero flag if the end of the message has been reached</td>
</tr>
<tr>
<td class="address-1"><span id="67a2"></span>67A2</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="67a3"></span>
<div class="comments">
<div class="paragraph">
We haven't reached the end of the message yet. Examine the next character to be written.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="67a3"></span>67A3</td>
<td class="instruction">CP $02</td>
<td class="comment-1" rowspan="1">Character code 0x02 is newline</td>
</tr>
<tr>
<td class="address-1"><span id="67a5"></span>67A5</td>
<td class="instruction">JR NZ,$67AB</td>
<td class="comment-1" rowspan="1">Jump unless we're starting a new line</td>
</tr>
<tr>
<td class="address-1"><span id="67a7"></span>67A7</td>
<td class="instruction">LD A,$40</td>
<td class="comment-1" rowspan="1">This is the pixel column number of the start of the bottom line of the blackboard</td>
</tr>
<tr>
<td class="address-1"><span id="67a9"></span>67A9</td>
<td class="instruction">JR $67A0</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="67ab"></span>
<div class="comments">
<div class="paragraph">
The next character to be written is printable (as opposed to newline).
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="67ab"></span>67AB</td>
<td class="instruction">PUSH HL</td>
<td class="comment-1" rowspan="1">Save the character number (in <span class="register">H</span>) for now</td>
</tr>
<tr>
<td class="address-1"><span id="67ac"></span>67AC</td>
<td class="instruction">LD L,A</td>
<td class="comment-1" rowspan="1">Place the ASCII code of the character to be written in <span class="register">L</span></td>
</tr>
<tr>
<td class="address-1"><span id="67ad"></span>67AD</td>
<td class="instruction">LD H,$D7</td>
<td class="comment-1" rowspan="1">Now (<span class="register">HL</span>)=bit width of this character</td>
</tr>
<tr>
<td class="address-1"><span id="67af"></span>67AF</td>
<td class="instruction">LD A,(BC)</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=current pixel column number on the blackboard</td>
</tr>
<tr>
<td class="address-1"><span id="67b0"></span>67B0</td>
<td class="instruction">AND $3F</td>
<td class="comment-1" rowspan="4">Set the carry flag if there's not enough room on the current line to print the next character (plus one blank pixel column)</td>
</tr>
<tr>
<td class="address-1"><span id="67b2"></span>67B2</td>
<td class="instruction">ADD A,$C0</td>
</tr>
<tr>
<td class="address-1"><span id="67b4"></span>67B4</td>
<td class="instruction">SCF</td>
</tr>
<tr>
<td class="address-1"><span id="67b5"></span>67B5</td>
<td class="instruction">ADC A,(HL)</td>
</tr>
<tr>
<td class="address-1"><span id="67b6"></span>67B6</td>
<td class="instruction">LD A,(BC)</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=current pixel column number on the blackboard</td>
</tr>
<tr>
<td class="address-1"><span id="67b7"></span>67B7</td>
<td class="instruction">JR NC,$67BD</td>
<td class="comment-1" rowspan="1">Jump if there's enough room on the current line for the character</td>
</tr>
<tr>
<td class="address-1"><span id="67b9"></span>67B9</td>
<td class="instruction">CPL</td>
<td class="comment-1" rowspan="3">Otherwise move to the other line of the blackboard by setting the current pixel column number to 0 or 64 as appropriate</td>
</tr>
<tr>
<td class="address-1"><span id="67ba"></span>67BA</td>
<td class="instruction">AND $40</td>
</tr>
<tr>
<td class="address-1"><span id="67bc"></span>67BC</td>
<td class="instruction">LD (BC),A</td>
</tr>
<tr>
<td class="address-2"><span id="67bd"></span>67BD</td>
<td class="instruction">RRCA</td>
<td class="comment-1" rowspan="4">Divide the pixel column number by 8 to get the corresponding character square number (0-7); also keep bit 3 for now to check which line of the board we're on</td>
</tr>
<tr>
<td class="address-1"><span id="67be"></span>67BE</td>
<td class="instruction">RRCA</td>
</tr>
<tr>
<td class="address-1"><span id="67bf"></span>67BF</td>
<td class="instruction">RRCA</td>
</tr>
<tr>
<td class="address-1"><span id="67c0"></span>67C0</td>
<td class="instruction">AND $0F</td>
</tr>
<tr>
<td class="address-1"><span id="67c2"></span>67C2</td>
<td class="instruction">CP $08</td>
<td class="comment-1" rowspan="1">Are we on the top line of the board?</td>
</tr>
<tr>
<td class="address-1"><span id="67c4"></span>67C4</td>
<td class="instruction">JR C,$67C9</td>
<td class="comment-1" rowspan="1">Jump if so (<span class="register">A</span>=0-7)</td>
</tr>
<tr>
<td class="address-1"><span id="67c6"></span>67C6</td>
<td class="instruction">INC D</td>
<td class="comment-1" rowspan="1"><span class="register">D</span>=4 or 9 (y-coordinate of the bottom line of the board)</td>
</tr>
<tr>
<td class="address-1"><span id="67c7"></span>67C7</td>
<td class="instruction">AND $07</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=0-7</td>
</tr>
<tr>
<td class="address-2"><span id="67c9"></span>67C9</td>
<td class="instruction">ADD A,E</td>
<td class="comment-1" rowspan="2"><span class="register">E</span>=x-coordinate of the blackboard tile on which the next character will be written</td>
</tr>
<tr>
<td class="address-1"><span id="67ca"></span>67CA</td>
<td class="instruction">LD E,A</td>
</tr>
<tr>
<td class="address-1"><span id="67cb"></span>67CB</td>
<td class="instruction">CALL <a href="670C.html">$670C</a></td>
<td class="comment-1" rowspan="1">Update the SRB for this blackboard</td>
</tr>
<tr>
<td class="address-1"><span id="67ce"></span>67CE</td>
<td class="instruction">LD A,(BC)</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=current pixel column number on the blackboard</td>
</tr>
<tr>
<td class="address-1"><span id="67cf"></span>67CF</td>
<td class="instruction">AND $07</td>
<td class="comment-1" rowspan="7">Modify the RES n,(HL) instruction at <a href="6791.html#67f1">67F1</a> below to reset the appropriate bit for the current pixel column</td>
</tr>
<tr>
<td class="address-1"><span id="67d1"></span>67D1</td>
<td class="instruction">ADD A,A</td>
</tr>
<tr>
<td class="address-1"><span id="67d2"></span>67D2</td>
<td class="instruction">ADD A,A</td>
</tr>
<tr>
<td class="address-1"><span id="67d3"></span>67D3</td>
<td class="instruction">ADD A,A</td>
</tr>
<tr>
<td class="address-1"><span id="67d4"></span>67D4</td>
<td class="instruction">CPL</td>
</tr>
<tr>
<td class="address-1"><span id="67d5"></span>67D5</td>
<td class="instruction">SUB $41</td>
</tr>
<tr>
<td class="address-1"><span id="67d7"></span>67D7</td>
<td class="instruction">LD ($67F2),A</td>
</tr>
<tr>
<td class="address-1"><span id="67da"></span>67DA</td>
<td class="instruction">LD A,(BC)</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=current pixel column number on the blackboard</td>
</tr>
<tr>
<td class="address-1"><span id="67db"></span>67DB</td>
<td class="instruction">ADD A,(HL)</td>
<td class="comment-1" rowspan="1">Add the bit-width of character to be written</td>
</tr>
<tr>
<td class="address-1"><span id="67dc"></span>67DC</td>
<td class="instruction">INC A</td>
<td class="comment-1" rowspan="1">Add 1 to make a blank vertical pixel line after the character to be written</td>
</tr>
<tr>
<td class="address-1"><span id="67dd"></span>67DD</td>
<td class="instruction">LD (BC),A</td>
<td class="comment-1" rowspan="1">Set the pixel column number for the next character to be written</td>
</tr>
<tr>
<td class="address-1"><span id="67de"></span>67DE</td>
<td class="instruction">LD C,(HL)</td>
<td class="comment-1" rowspan="1"><span class="register">C</span>=bit-width of the character to be written</td>
</tr>
<tr>
<td class="address-1"><span id="67df"></span>67DF</td>
<td class="instruction">EX DE,HL</td>
<td class="comment-1" rowspan="1">Now <span class="register">DE</span> points at the bitmap data for the character to be written on the board, and <span class="register">HL</span> holds the coordinates of the blackboard tile on which the character will be written</td>
</tr>
<tr>
<td class="address-1"><span id="67e0"></span>67E0</td>
<td class="instruction">LD A,H</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=blackboard tile y-coordinate</td>
</tr>
<tr>
<td class="address-1"><span id="67e1"></span>67E1</td>
<td class="instruction">LD H,$B5</td>
<td class="comment-1" rowspan="2">Pick up the Q value (0x00&lt;=Q&lt;=0x8F) for the blackboard tile from page <a href="B500.html">0xB5</a> in <span class="register">L</span> (see <a href="606C.html">606C</a>)</td>
</tr>
<tr>
<td class="address-1"><span id="67e3"></span>67E3</td>
<td class="instruction">LD L,(HL)</td>
</tr>
<tr>
<td class="address-1"><span id="67e4"></span>67E4</td>
<td class="instruction">ADD A,$A0</td>
<td class="comment-1" rowspan="3">Collect the LSB of the base address of the skool UDG for the blackboard tile in <span class="register">L</span></td>
</tr>
<tr>
<td class="address-1"><span id="67e6"></span>67E6</td>
<td class="instruction">LD H,A</td>
</tr>
<tr>
<td class="address-1"><span id="67e7"></span>67E7</td>
<td class="instruction">LD L,(HL)</td>
</tr>
<tr>
<td class="address-2"><span id="67e8"></span>67E8</td>
<td class="instruction">LD H,$80</td>
<td class="comment-1" rowspan="1">The base page for all blackboard tile UDGs is 0x80</td>
</tr>
<tr>
<td class="address-1"><span id="67ea"></span>67EA</td>
<td class="instruction">INC D</td>
<td class="comment-1" rowspan="1">Point <span class="register">DE</span> at the next pixel column of bitmap data for the character to be written</td>
</tr>
<tr>
<td class="address-1"><span id="67eb"></span>67EB</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-1" rowspan="1">Pick this up in <span class="register">A</span></td>
</tr>
<tr>
<td class="address-1"><span id="67ec"></span>67EC</td>
<td class="instruction">LD B,$08</td>
<td class="comment-1" rowspan="1">8 horizontal pixel lines in each character square</td>
</tr>
<tr>
<td class="address-2"><span id="67ee"></span>67EE</td>
<td class="instruction">RLCA</td>
<td class="comment-1" rowspan="1">Should a bit of chalk appear here?</td>
</tr>
<tr>
<td class="address-1"><span id="67ef"></span>67EF</td>
<td class="instruction">JR NC,$67F3</td>
<td class="comment-1" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="address-1"><span id="67f1"></span>67F1</td>
<td class="instruction">RES 7,(HL)</td>
<td class="comment-1" rowspan="1">Reset the appropriate bit in the skool UDG for the blackboard tile, thus making a bit of chalk appear; this instruction is modified by this routine to reset the required bit</td>
</tr>
<tr>
<td class="address-2"><span id="67f3"></span>67F3</td>
<td class="instruction">INC H</td>
<td class="comment-1" rowspan="1">Next row of the blackboard tile UDG</td>
</tr>
<tr>
<td class="address-1"><span id="67f4"></span>67F4</td>
<td class="instruction">DJNZ $67EE</td>
<td class="comment-1" rowspan="1">Jump back until all 8 rows are done</td>
</tr>
<tr>
<td class="address-1"><span id="67f6"></span>67F6</td>
<td class="instruction">LD A,($67F2)</td>
<td class="comment-1" rowspan="5">Change the RES n,(HL) instruction at <a href="6791.html#67f1">67F1</a> above to RES n-1,(HL) if n&gt;0, or RES 7,(HL) if n=0</td>
</tr>
<tr>
<td class="address-1"><span id="67f9"></span>67F9</td>
<td class="instruction">OR $40</td>
</tr>
<tr>
<td class="address-1"><span id="67fb"></span>67FB</td>
<td class="instruction">SUB $08</td>
</tr>
<tr>
<td class="address-1"><span id="67fd"></span>67FD</td>
<td class="instruction">AND $BF</td>
</tr>
<tr>
<td class="address-1"><span id="67ff"></span>67FF</td>
<td class="instruction">LD ($67F2),A</td>
</tr>
<tr>
<td class="address-1"><span id="6802"></span>6802</td>
<td class="instruction">CP $BE</td>
<td class="comment-1" rowspan="1">Did we just draw the rightmost vertical pixel line in the current blackboard tile?</td>
</tr>
<tr>
<td class="address-1"><span id="6804"></span>6804</td>
<td class="instruction">JR NZ,$6807</td>
<td class="comment-1" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="address-1"><span id="6806"></span>6806</td>
<td class="instruction">INC L</td>
<td class="comment-1" rowspan="1">Set <span class="register">L</span> to the LSB of the base address of the skool UDG for the next blackboard tile to the right</td>
</tr>
<tr>
<td class="address-2"><span id="6807"></span>6807</td>
<td class="instruction">DEC C</td>
<td class="comment-1" rowspan="1">Next pixel column of the character bitmap</td>
</tr>
<tr>
<td class="address-1"><span id="6808"></span>6808</td>
<td class="instruction">JR NZ,$67E8</td>
<td class="comment-1" rowspan="1">Jump back to do the remaining pixel columns</td>
</tr>
<tr>
<td class="address-1"><span id="680a"></span>680A</td>
<td class="instruction">INC C</td>
<td class="comment-1" rowspan="1">Reset the zero flag (the message is not finished yet)</td>
</tr>
<tr>
<td class="address-1"><span id="680b"></span>680B</td>
<td class="instruction">POP HL</td>
<td class="comment-1" rowspan="1">Restore the character number to <span class="register">H</span></td>
</tr>
<tr>
<td class="address-1"><span id="680c"></span>680C</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1"></td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="6790.html">6790</a>
</td>
<td class="up">Up: <a href="../maps/all.html#6791">Map</a></td>
<td class="next">
Next: <a href="680D.html">680D</a>
</td>
</tr>
</table>
<footer>
<div class="release">The complete Back to Skool RAM disassembly 20221122</div>
<div class="copyright">&#169; 1985 Microsphere Computer Services Ltd. &#169; 2022 Richard Dymond.</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 8.8.</div>
<div><a href="../dec/asm/26513.html">Switch to decimal</a>.</div>
</footer>
</body>
</html>