<!DOCTYPE html>
<html>
<head>
<title>Back to Skool: Routine at F55F</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="Back to Skool" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="F54A.html">F54A</a>
</td>
<td class="up">Up: <a href="../maps/all.html#f55f">Map</a></td>
<td class="next">
Next: <a href="F5B7.html">F5B7</a>
</td>
</tr>
</table>
<div class="description">F55F: Make MR WACKER find and expel ERIC</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
The address of this routine is found in the command list at <a href="F530.html">F530</a>, the address of which is placed into bytes 0x1B and 0x1C of MR WACKER's buffer by the routine at <a href="F532.html">F532</a>.
</div>
</div>
<table class="input">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">H</td>
<td class="register-desc">0xC8 (MR WACKER)</td>
</tr>
</table>
</td>
</tr>
<tr>
<td class="address-2"><span id="f55f"></span>F55F</td>
<td class="instruction">LD L,$1D</td>
<td class="comment-1" rowspan="2">Set bit 7 of byte 0x1D of MR WACKER's buffer, making him run</td>
</tr>
<tr>
<td class="address-1"><span id="f561"></span>F561</td>
<td class="instruction">SET 7,(HL)</td>
</tr>
<tr>
<td class="address-1"><span id="f563"></span>F563</td>
<td class="instruction">LD A,$FF</td>
<td class="comment-1" rowspan="2">Set the MSB of the lesson clock at <a href="7FE3.html">7FE3</a> to 0xFF (this lesson will not end until ERIC's expelled)</td>
</tr>
<tr>
<td class="address-1"><span id="f565"></span>F565</td>
<td class="instruction">LD ($7FE4),A</td>
</tr>
<tr>
<td class="address-1"><span id="f568"></span>F568</td>
<td class="instruction">CALL <a href="6558.html">$6558</a></td>
<td class="comment-1" rowspan="1">Move MR WACKER one step closer to ERIC (if he's not yet close enough)</td>
</tr>
<tr>
<td class="address-1"><span id="f56b"></span>F56B</td>
<td class="instruction">LD HL,$C800</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at byte 0x00 of MR WACKER's buffer</td>
</tr>
<tr>
<td class="address-1"><span id="f56e"></span>F56E</td>
<td class="instruction">BIT 0,(HL)</td>
<td class="comment-1" rowspan="1">Is MR WACKER now midstride?</td>
</tr>
<tr>
<td class="address-1"><span id="f570"></span>F570</td>
<td class="instruction">RET NZ</td>
<td class="comment-1" rowspan="1">Return if so</td>
</tr>
<tr>
<td class="address-1"><span id="f571"></span>F571</td>
<td class="instruction">INC L</td>
<td class="comment-1" rowspan="1"><span class="register">L</span>=0x01</td>
</tr>
<tr>
<td class="address-1"><span id="f572"></span>F572</td>
<td class="instruction">LD DE,($D201)</td>
<td class="comment-1" rowspan="1"><span class="register">E</span>=ERIC's x-coordinate, <span class="register">D</span>=ERIC's y-coordinate</td>
</tr>
<tr>
<td class="address-1"><span id="f576"></span>F576</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=MR WACKER's x-coordinate</td>
</tr>
<tr>
<td class="address-1"><span id="f577"></span>F577</td>
<td class="instruction">SUB E</td>
<td class="comment-1" rowspan="3">Is MR WACKER within 3 x-coordinates of ERIC?</td>
</tr>
<tr>
<td class="address-1"><span id="f578"></span>F578</td>
<td class="instruction">ADD A,$03</td>
</tr>
<tr>
<td class="address-1"><span id="f57a"></span>F57A</td>
<td class="instruction">CP $07</td>
</tr>
<tr>
<td class="address-1"><span id="f57c"></span>F57C</td>
<td class="instruction">RET NC</td>
<td class="comment-1" rowspan="1">Return if not</td>
</tr>
<tr>
<td class="address-1"><span id="f57d"></span>F57D</td>
<td class="instruction">INC L</td>
<td class="comment-1" rowspan="1"><span class="register">L</span>=0x02</td>
</tr>
<tr>
<td class="address-1"><span id="f57e"></span>F57E</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=MR WACKER's y-coordinate</td>
</tr>
<tr>
<td class="address-1"><span id="f57f"></span>F57F</td>
<td class="instruction">SUB D</td>
<td class="comment-1" rowspan="3">Is MR WACKER within 3 y-coordinates of ERIC?</td>
</tr>
<tr>
<td class="address-1"><span id="f580"></span>F580</td>
<td class="instruction">ADD A,$03</td>
</tr>
<tr>
<td class="address-1"><span id="f582"></span>F582</td>
<td class="instruction">CP $07</td>
</tr>
<tr>
<td class="address-1"><span id="f584"></span>F584</td>
<td class="instruction">RET NC</td>
<td class="comment-1" rowspan="1">Return if not</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="f585"></span>
<div class="comments">
<div class="paragraph">
MR WACKER has found ERIC.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="f585"></span>F585</td>
<td class="instruction">LD HL,$7FFB</td>
<td class="comment-1" rowspan="1"><a href="7FFB.html">7FFB</a> holds ERIC's status flags</td>
</tr>
<tr>
<td class="address-1"><span id="f588"></span>F588</td>
<td class="instruction">LD (HL),$40</td>
<td class="comment-1" rowspan="1">Set bit 6: MR WACKER is expelling ERIC (who is now paralysed)</td>
</tr>
<tr>
<td class="address-1"><span id="f58a"></span>F58A</td>
<td class="instruction">LD L,$ED</td>
<td class="comment-1" rowspan="1"><span class="register">HL</span>=<a href="7FED.html">7FED</a> (ERIC's other status flags)</td>
</tr>
<tr>
<td class="address-1"><span id="f58c"></span>F58C</td>
<td class="instruction">BIT 5,(HL)</td>
<td class="comment-1" rowspan="1">Bit 5 is set if ERIC jumped out of the top-floor window</td>
</tr>
<tr>
<td class="address-1"><span id="f58e"></span>F58E</td>
<td class="instruction">LD H,$C8</td>
<td class="comment-1" rowspan="1">0xC8=MR WACKER</td>
</tr>
<tr>
<td class="address-1"><span id="f590"></span>F590</td>
<td class="instruction">LD E,$63</td>
<td class="comment-1" rowspan="1">Message <a href="EE19.html">0x63</a>: YOU HAVE 10000 LINES...</td>
</tr>
<tr>
<td class="address-1"><span id="f592"></span>F592</td>
<td class="instruction">JR Z,$F595</td>
<td class="comment-1" rowspan="1">Jump if ERIC didn't jump out of the top-floor window (i.e. he has 10000 lines)</td>
</tr>
<tr>
<td class="address-1"><span id="f594"></span>F594</td>
<td class="instruction">INC E</td>
<td class="comment-1" rowspan="1"><span class="register">E</span>=<a href="EE2F.html">0x64</a>: YOU ARE NOT A BIRD...</td>
</tr>
<tr>
<td class="address-2"><span id="f595"></span>F595</td>
<td class="instruction">LD BC,$6A08</td>
<td class="comment-1" rowspan="2">Redirect control to the routine at <a href="6A08.html">6A08</a> (make character speak) and return to <a href="F55F.html#f59b">F59B</a> (below) when done</td>
</tr>
<tr>
<td class="address-1"><span id="f598"></span>F598</td>
<td class="instruction">CALL <a href="639F.html">$639F</a></td>
</tr>
<tr>
<td class="address-2"><span id="f59b"></span>F59B</td>
<td class="instruction">LD DE,($7FE5)</td>
<td class="comment-1" rowspan="1">Collect the score from <a href="7FE5.html">7FE5</a> into <span class="register">DE</span></td>
</tr>
<tr>
<td class="address-1"><span id="f59f"></span>F59F</td>
<td class="instruction">LD HL,($7FE9)</td>
<td class="comment-1" rowspan="1">Collect the current hi-score from <a href="7FE9.html">7FE9</a> into <span class="register">HL</span></td>
</tr>
<tr>
<td class="address-1"><span id="f5a2"></span>F5A2</td>
<td class="instruction">AND A</td>
<td class="comment-1" rowspan="1">Clear the carry flag ready for subtraction</td>
</tr>
<tr>
<td class="address-1"><span id="f5a3"></span>F5A3</td>
<td class="instruction">SBC HL,DE</td>
<td class="comment-1" rowspan="1">Do we have a new hi-score?</td>
</tr>
<tr>
<td class="address-1"><span id="f5a5"></span>F5A5</td>
<td class="instruction">JR NC,$F5AB</td>
<td class="comment-1" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="address-1"><span id="f5a7"></span>F5A7</td>
<td class="instruction">LD ($7FE9),DE</td>
<td class="comment-1" rowspan="1">Insert the new hi-score</td>
</tr>
<tr>
<td class="address-2"><span id="f5ab"></span>F5AB</td>
<td class="instruction">LD HL,$0000</td>
<td class="comment-1" rowspan="3">Reset the score (at <a href="7FE5.html">7FE5</a>) and the lines total (at <a href="7FE7.html">7FE7</a>) to 0</td>
</tr>
<tr>
<td class="address-1"><span id="f5ae"></span>F5AE</td>
<td class="instruction">LD ($7FE5),HL</td>
</tr>
<tr>
<td class="address-1"><span id="f5b1"></span>F5B1</td>
<td class="instruction">LD ($7FE7),HL</td>
</tr>
<tr>
<td class="address-1"><span id="f5b4"></span>F5B4</td>
<td class="instruction">JP <a href="F6D5.html">$F6D5</a></td>
<td class="comment-1" rowspan="1">Enter demo mode</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="F54A.html">F54A</a>
</td>
<td class="up">Up: <a href="../maps/all.html#f55f">Map</a></td>
<td class="next">
Next: <a href="F5B7.html">F5B7</a>
</td>
</tr>
</table>
<footer>
<div class="release">The complete Back to Skool RAM disassembly 20191115</div>
<div class="copyright">&#169; 1985 Microsphere Computer Services Ltd. &#169; 2019 Richard Dymond.</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 8.0.</div>
<div><a href="../dec/asm/62815.html">Switch to decimal</a>.</div>
</footer>
</body>
</html>